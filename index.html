<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --border: #cbd5e1;
            --cell-w: 45px;
            --header-h: 40px;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg); font-size: 14px; direction: rtl; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; align-items: center; }
        .toolbar h1 { margin: 0; font-size: 1.2rem; margin-left: auto; }
        button { cursor: pointer; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-weight: 500; font-family: inherit; }
        button:hover { background: #f1f5f9; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.danger { background: #ef4444; color: white; border-color: #ef4444; }
        input, select { padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; }
        .tabs { display: flex; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }
        .view { display: none; }
        .view.active { display: block; }
        .grid-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding-bottom: 10px; }
        .schedule-table { border-collapse: collapse; width: 100%; min-width: 1000px; }
        .schedule-table th, .schedule-table td { border: 1px solid var(--border); text-align: center; padding: 4px; height: 35px; }
        .schedule-table th { background: #f1f5f9; position: sticky; top: 0; z-index: 10; font-size: 0.85rem; }
        .schedule-table th.emp-col { position: sticky; right: 0; z-index: 20; background: #f1f5f9; width: 160px; text-align: right; padding-right: 10px; border-left: 2px solid #ddd; }
        .schedule-table td.emp-col { position: sticky; right: 0; z-index: 5; background: white; text-align: right; padding-right: 10px; font-weight: 500; border-left: 2px solid #ddd; }
        .cell { cursor: pointer; font-size: 0.8rem; line-height: 1.1; user-select: none; }
        .cell.shift-D { background-color: #dbeafe; color: #1e40af; } 
        .cell.shift-EN { background-color: #fef3c7; color: #92400e; } 
        .cell.shift-LN { background-color: #1e293b; color: #f8fafc; } 
        .cell.shift-OFF { background-color: #ecfdf5; color: #047857; } 
        .cell.shift-X { background-color: #fee2e2; color: #b91c1c; font-weight: bold; } 
        .stat-box { font-size: 0.70rem; color: #64748b; margin-top: 2px; display:flex; gap:3px; flex-wrap:wrap;}
        .violation { border: 3px solid #ef4444 !important; position: relative; }
        .req-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .req-table th, .req-table td { border: 1px solid #eee; padding: 8px; text-align: center; }
        .req-table th { background: #f8fafc; }
        .req-input { width: 50px; text-align: center; }
        .emp-card { border: 1px solid var(--border); background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .emp-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .pattern-editor { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px dashed #cbd5e1; }
        .flex-counts { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .flex-counts div { display: flex; flex-direction: column; align-items: center; }
        .flex-counts label { font-size: 0.75rem; font-weight: bold; margin-bottom: 2px; }
        .flex-counts input { width: 40px; text-align: center; }
        .depot-quotas { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; background: #fff7ed; padding: 10px; border-radius: 4px; border: 1px solid #ffedd5; }
        .depot-quotas div { display: flex; flex-direction: column; }
        .depot-quotas label { font-size: 0.75rem; color: #9a3412; }
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; font-weight: bold; font-size: 1.2rem; color: var(--primary); display: none; flex-direction: column; gap: 10px;}
        .depot-tag { font-size: 0.65rem; display: block; opacity: 0.8; }
        .note { font-size: 0.75rem; color: #64748b; margin-top: 5px; }
        .report-box { margin-top: 20px; padding: 15px; background: white; border: 1px solid var(--border); border-radius: 8px; }
        .report-item { color: #b91c1c; margin-bottom: 4px; display: flex; align-items: center; gap: 5px; font-weight: 500; }
        .report-ok { color: #047857; font-weight: bold; }
        .report-analysis { background: #fff7ed; border: 1px solid #fdba74; padding: 10px; margin-bottom: 10px; border-radius: 4px; color: #9a3412; font-size: 0.9rem;}
        .alert-box { background: #fef3c7; border: 2px solid #fbbf24; padding: 12px; border-radius: 6px; margin: 10px 0; color: #92400e; font-weight: 500; }
    </style>
</head>
<body>

<div id="loader">
    <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    <div style="font-size:0.9rem; font-weight:normal;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
</div>

<div class="app-container">
    <div class="toolbar">
        <h1>ğŸ—“ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© (Ù…ØµØ­Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)</h1>
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <button onclick="loadData()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        <div style="flex-grow:1; text-align:left;">
             <span id="lastUpdated" style="font-size:0.8rem; color:gray;"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
        <div class="tab" onclick="switchTab('employees')">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø·</div>
        <div class="tab" onclick="switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
    </div>

    <div id="view-schedule" class="view active">
        <div class="alert-box">
            âœ… <strong>ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­:</strong> Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© "Setting 1" | ØªÙˆØ²ÙŠØ¹ Ø´Ø±Ø³ Ù„Ù„Ø¥Ø¬Ø§Ø²Ø§Øª | Ù…Ù†Ø¹ ÙƒØ§Ù…Ù„ Ù„Ù„Ù‚Ù„Ø¨Ø§Øª.
        </div>
        <div class="toolbar" style="background: transparent; padding: 0; box-shadow: none; justify-content: space-between;">
            <div>
                <button onclick="runSmartOptimizer()" class="primary">âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¢Ù…Ù†Ø©)</button>
                <button onclick="fillDepots()">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Ø­Ø³Ø¨ Ø§Ù„Ø­ØµØ©)</button>
            </div>
            <div>
                <button onclick="clearMonth()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ù‡Ø±</button>
                <button onclick="exportCSV()">ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
            </div>
        </div>
        <div class="grid-container">
            <table class="schedule-table" id="scheduleGrid"></table>
        </div>
        <div id="coverageReport" class="report-box"><p>Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Øµ...</p></div>
    </div>

    <div id="view-employees" class="view">
        <button class="primary" onclick="addEmployee()" style="margin-bottom: 15px;">+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
        <div id="employeeList"></div>
    </div>

    <div id="view-settings" class="view">
        <div class="emp-card">
            <h3>1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
            <p class="note">Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨ÙØ§ØµÙ„Ø©.</p>
            <input type="text" id="settingDepots" style="width: 100%;" value="Budaiya, IsaTown" onchange="updateDepots()">
        </div>
        <div class="emp-card">
            <h3>2. Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ ÙƒÙ„ Ù…ÙˆÙ‚Ø¹</h3>
            <p class="note">Ø­Ø¯Ø¯ ÙƒÙ… Ù…ÙˆØ¸Ù ØªØ­ØªØ§Ø¬ ÙÙŠ ÙƒÙ„ Ø´ÙØª.</p>
            <div id="requirementsContainer"></div>
        </div>
        <div class="emp-card">
            <h3>3. Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h3>
            <button class="danger" onclick="saveData(true)">Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // <--- Ø¶Ø¹ Ø±Ø§Ø¨Ø· Google Web App Ù‡Ù†Ø§
    
    // --- STATE ---
    let state = { employees: [], schedule: {}, meta: { requirements: {} } };
    let appConfig = { depots: ["Main", "North"], year: new Date().getFullYear(), month: new Date().getMonth() + 1 };
    const SHIFTS = ["D", "EN", "LN", "OFF", "X"];
    const WEEKDAYS = ["Ø£Ø­Ø¯", "Ø§Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"];

    // --- HELPER: Shift Flip Check ---
    function isShiftFlipViolation(previousShift, nextShift) {
        if (!previousShift || previousShift === 'OFF' || previousShift === 'X') return false;
        if (nextShift === 'OFF' || nextShift === 'X') return false;
        // LN -> D or EN
        if (previousShift === 'LN') return nextShift === 'D' || nextShift === 'EN';
        // EN -> D
        if (previousShift === 'EN') return nextShift === 'D';
        return false;
    }

    // --- INITIALIZATION ---
    window.onload = () => { initDateSelectors(); loadData(); };

    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const currYear = new Date().getFullYear();
        for(let y = currYear - 1; y <= currYear + 2; y++) ySel.add(new Option(y, y));
        ySel.value = currYear;
        const monthsAr = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        monthsAr.forEach((m, i) => mSel.add(new Option(m, i+1)));
        mSel.value = new Date().getMonth() + 1;
        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderSchedule(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderSchedule(); };
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${tabName}`).classList.add('active');
    }

    // --- API CALLS ---
    async function loadData() {
        showLoader(true);
        try {
            const res = await fetch(`${API_URL}?action=load`);
            const json = await res.json();
            if (json.ok) {
                state = json.data;
                if (state.meta && state.meta.depots) appConfig.depots = state.meta.depots;
                else appConfig.depots = ["Budaiya", "IsaTown"];
                if (!state.meta) state.meta = {};
                if (!state.meta.requirements) state.meta.requirements = {};
                document.getElementById('settingDepots').value = appConfig.depots.join(', ');
                state.employees.forEach(emp => {
                    if(!emp.patternType) emp.patternType = 'weekly';
                    if(!emp.flexCounts) emp.flexCounts = { D: 1, EN: 2, LN: 2, OFF: 2 };
                    if(!emp.depotQuotas) emp.depotQuotas = {};
                });
                renderEmployees(); renderRequirementsTable(); renderSchedule(); updateLastUpdated();
            } else { alert("Ø®Ø·Ø£: " + json.error); }
        } catch (e) { console.error(e); alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„."); } finally { showLoader(false); }
    }

    async function saveData(reset = false) {
        showLoader(true);
        if(reset) {
            if(!confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!")) { showLoader(false); return; }
            state.employees = []; state.schedule = {}; state.meta = { requirements: {}, depots: [] };
        }
        state.meta.depots = appConfig.depots;
        try {
            const payload = { action: "save", payload: { employees: state.employees, schedule: state.schedule, meta: state.meta } };
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
            const json = await res.json();
            if (json.ok) { state.meta.updatedAt = json.meta.updatedAt; updateLastUpdated(); }
            else { alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + json.error); }
        } catch (e) { alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸."); } finally { showLoader(false); }
    }

    function updateLastUpdated() {
        if(state.meta.updatedAt) document.getElementById('lastUpdated').innerText = "Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: " + new Date(state.meta.updatedAt).toLocaleTimeString();
    }

    // --- UI ---
    function renderRequirementsTable() {
        const container = document.getElementById('requirementsContainer');
        let html = `<table class="req-table"><thead><tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>Ù†Ù‡Ø§Ø± (D)</th><th>Ø£ÙˆÙ„ Ù„ÙŠÙ„ (EN)</th><th>Ø¢Ø®Ø± Ù„ÙŠÙ„ (LN)</th></tr></thead><tbody>`;
        appConfig.depots.forEach(depot => {
            const req = state.meta.requirements[depot] || { D:0, EN:0, LN:0 };
            html += `<tr><td style="font-weight:bold;">${depot}</td>
                <td><input type="number" min="0" class="req-input" value="${req.D || 0}" onchange="updateReq('${depot}', 'D', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.EN || 0}" onchange="updateReq('${depot}', 'EN', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.LN || 0}" onchange="updateReq('${depot}', 'LN', this.value)"></td></tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }
    function updateReq(d, s, v) { if(!state.meta.requirements) state.meta.requirements={}; if(!state.meta.requirements[d]) state.meta.requirements[d]={}; state.meta.requirements[d][s]=parseInt(v)||0; }

    function renderEmployees() {
        const container = document.getElementById('employeeList');
        container.innerHTML = "";
        state.employees.forEach(emp => {
            const div = document.createElement('div'); div.className = "emp-card";
            let weekHtml = "";
            WEEKDAYS.forEach((day, i) => {
                const opts = SHIFTS.map(s => `<option value="${s}" ${emp.weeklyTemplate[i] === s ? 'selected' : ''}>${s}</option>`).join('');
                weekHtml += `<div style="text-align:center;"><label style="font-size:0.7rem; color:#666;">${day}</label><select onchange="updateWeeklyTemplate('${emp.id}', ${i}, this.value)" style="width:100%">${opts}</select></div>`;
            });
            let quotasHtml = `<label style="font-weight:bold; margin-bottom:5px; display:block;">ØªÙˆØ²ÙŠØ¹ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ (Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹):</label><div class="depot-quotas">`;
            appConfig.depots.forEach(d => {
                const val = (emp.depotQuotas && emp.depotQuotas[d]) ? emp.depotQuotas[d] : 0;
                quotasHtml += `<div><label>${d}</label><input type="number" min="0" value="${val}" onchange="updateDepotQuota('${emp.id}', '${d}', this.value)"></div>`;
            });
            quotasHtml += `</div>`;
            let patternEditorHtml = "";
            const flex = emp.flexCounts || { D: 1, EN: 2, LN: 2, OFF: 2 };
            if(emp.patternType === 'rolling') {
                patternEditorHtml = `
                    <div class="pattern-editor">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ø§Ù„Ø£Ø­Ø¯-Ø§Ù„Ø³Ø¨Øª):</label>
                        <div class="flex-counts">
                            <div><label>D Ù†Ù‡Ø§Ø±</label><input type="number" min="0" value="${flex.D}" onchange="updateFlexCount('${emp.id}', 'D', this.value)"></div>
                            <div><label>EN Ø£ÙˆÙ„</label><input type="number" min="0" value="${flex.EN}" onchange="updateFlexCount('${emp.id}', 'EN', this.value)"></div>
                            <div><label>LN Ø¢Ø®Ø±</label><input type="number" min="0" value="${flex.LN}" onchange="updateFlexCount('${emp.id}', 'LN', this.value)"></div>
                            <div><label>OFF</label><input type="number" min="0" value="${flex.OFF}" onchange="updateFlexCount('${emp.id}', 'OFF', this.value)"></div>
                        </div>
                        <div class="note">âœ… ÙŠÙ„ØªØ²Ù… Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹.</div>
                    </div>`;
            } else if (emp.patternType === 'joker') {
                patternEditorHtml = `<div class="pattern-editor"><div class="note" style="color:#d97706; font-weight:bold;">ğŸƒ Ø§Ù„Ø¬ÙˆÙƒØ±</div><div class="note">âœ… ÙŠØºØ·ÙŠ Ø§Ù„Ù†Ù‚Øµ Ø¨Ø´Ø±Ø§Ø³Ø©. Ø¥Ø¬Ø§Ø²Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·/Ø£Ø³Ø¨ÙˆØ¹. ÙŠÙØ¶Ù„ Ø§Ù„Ù„ÙŠÙ„.</div></div>`;
            } else {
                patternEditorHtml = `<div class="pattern-editor"><label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø«Ø§Ø¨ØªØ©:</label><div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:5px;">${weekHtml}</div></div>`;
            }
            const exc = emp.exceptions || { offDates:"", xDates:"" };
            div.innerHTML = `
                <div class="emp-header">
                    <input type="text" value="${emp.name}" onchange="updateEmployee('${emp.id}', 'name', this.value)" style="font-weight:bold; font-size:1.1rem;">
                    <select onchange="updateEmployee('${emp.id}', 'patternType', this.value)" style="font-size:0.9rem;">
                        <option value="weekly" ${emp.patternType === 'weekly' ? 'selected' : ''}>1. Ø£ÙŠØ§Ù… Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø«Ø§Ø¨ØªØ©</option>
                        <option value="rolling" ${emp.patternType === 'rolling' ? 'selected' : ''}>2. Ø´ÙØª Ø¯ÙˆØ§Ø± (Ø­ØµØ© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©)</option>
                        <option value="joker" ${emp.patternType === 'joker' ? 'selected' : ''}>3. Ù…ÙˆØ¸Ù Ø¬ÙˆÙƒØ±</option>
                    </select>
                    <button class="danger" onclick="deleteEmployee('${emp.id}')">Ø­Ø°Ù</button>
                </div>
                ${quotasHtml} ${patternEditorHtml}
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <div><label style="font-size:0.75rem">Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¬Ø§Ø²Ø©:</label><input type="text" style="width:95%" value="${exc.offDates || ''}" placeholder="5, 12..." onchange="updateExceptions('${emp.id}', 'offDates', this.value)"></div>
                    <div><label style="font-size:0.75rem">Ø¥Ø¬Ø¨Ø§Ø± ØºÙŠØ§Ø¨:</label><input type="text" style="width:95%" value="${exc.xDates || ''}" placeholder="15..." onchange="updateExceptions('${emp.id}', 'xDates', this.value)"></div>
                </div>`;
            container.appendChild(div);
        });
    }

    // --- State helpers ---
    function addEmployee() {
        const id = "emp_" + Math.random().toString(36).substr(2, 9);
        state.employees.push({ id: id, name: "Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯", patternType: "weekly", weeklyTemplate: Array(7).fill("D"), flexCounts: { D:1, EN:2, LN:2, OFF:2 }, depotQuotas: {}, exceptions: { offDates: "", xDates: "" } });
        renderEmployees();
    }
    function updateEmployee(id, f, v) { const e = state.employees.find(x=>x.id===id); if(e){e[f]=v; if(f==='patternType') renderEmployees();} }
    function updateWeeklyTemplate(id, i, v) { const e = state.employees.find(x=>x.id===id); if(e) e.weeklyTemplate[i]=v; }
    function updateFlexCount(id, t, v) { const e = state.employees.find(x=>x.id===id); if(e){ if(!e.flexCounts) e.flexCounts={}; e.flexCounts[t]=parseInt(v)||0; } }
    function updateDepotQuota(id, d, v) { const e = state.employees.find(x=>x.id===id); if(e){ if(!e.depotQuotas) e.depotQuotas={}; e.depotQuotas[d]=parseInt(v)||0; } }
    function updateExceptions(id, t, v) { const e = state.employees.find(x=>x.id===id); if(e){ if(!e.exceptions) e.exceptions={}; e.exceptions[t]=v; } }
    function deleteEmployee(id) { if(confirm("Ø­Ø°ÙØŸ")) { state.employees = state.employees.filter(x=>x.id!==id); renderEmployees(); renderSchedule(); saveData(); } }

    // ==========================================
    // === OPTIMIZER ENGINE (SAFE MODE) ===
    // ==========================================
    
    function runSmartOptimizer() {
        if(!confirm("Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØªØ¬Ø±Ø¨Ø© Ø¹Ø¯Ø© Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ Ø¬Ø¯ÙˆÙ„ ÙŠØºØ·ÙŠ Ø§Ù„Ù†Ù‚Øµ.\n- Ø§Ù„Ø¬ÙˆÙƒØ±: Ø¥Ø¬Ø§Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹.\n- Ù…Ù†Ø¹ Ù‚Ù„Ø¨Ø© Ø§Ù„Ø´ÙØª.")) return;
        
        showLoader(true);
        setTimeout(() => {
            let bestSched = null;
            let bestScore = -Infinity; 

            // Run 50 iterations
            for(let i=0; i<50; i++) {
                let result = generateSingleRun();
                if(result.score > bestScore) {
                    bestScore = result.score;
                    bestSched = result.schedule;
                }
            }

            const key = getMonthKey();
            state.schedule[key] = bestSched;
            renderSchedule();
            saveData();
            showLoader(false);
            alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!`);
        }, 100);
    }

    function generateSingleRun() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());
        
        let tempSched = {};
        // âœ… FIX: Ensure initialization for ALL employees
        state.employees.forEach(e => tempSched[e.id] = {});

        // 1. Daily Needs
        let dailyNeeds = {}; 
        for(let d=1; d<=numDays; d++) {
            dailyNeeds[d] = { D:0, EN:0, LN:0 };
            cleanDepots.forEach(dep => {
                let r = reqs[dep] || reqs[dep.trim()];
                if(r) {
                    dailyNeeds[d].D += (r.D || 0);
                    dailyNeeds[d].EN += (r.EN || 0);
                    dailyNeeds[d].LN += (r.LN || 0);
                }
            });
        }

        let workStreaks = {}; 
        let empPrevShift = {};
        state.employees.forEach(e => { workStreaks[e.id] = 0; empPrevShift[e.id] = 'OFF'; });

        // 2. Fixed Weekly
        state.employees.forEach(emp => {
            if(emp.patternType === 'weekly' || !emp.patternType) {
                applyWeeklyImproved(emp, numDays, tempSched, dailyNeeds, workStreaks, empPrevShift);
            }
        });

        // 3. Rolling
        const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
        processWeeklyBuckets(rollingEmps, numDays, tempSched, dailyNeeds, workStreaks, empPrevShift, 'rolling');

        // 4. Joker
        const jokerEmps = state.employees.filter(e => e.patternType === 'joker');
        processWeeklyBuckets(jokerEmps, numDays, tempSched, dailyNeeds, workStreaks, empPrevShift, 'joker');

        // Calculate Score
        let score = 0;
        for(let d=1; d<=numDays; d++) {
            score -= (dailyNeeds[d].D * 10);
            score -= (dailyNeeds[d].EN * 10);
            score -= (dailyNeeds[d].LN * 10);
        }
        return { schedule: tempSched, score: score };
    }

    function processWeeklyBuckets(employees, numDays, sched, dailyNeeds, workStreaks, empPrevShift, type) {
        let currentDay = 1;
        while(currentDay <= numDays) {
            // Define Week
            let daysInWeek = [];
            let d = currentDay;
            while(d <= numDays) {
                daysInWeek.push(d);
                let curDate = new Date(appConfig.year, appConfig.month - 1, d);
                if(curDate.getDay() === 6) break; 
                d++;
            }

            // Init Buckets
            let buckets = {};
            let jokerPlannedOff = {}; // Specific for Jokers

            if(type === 'joker') {
                // Pre-distribute OFFs for Jokers to avoid overlap
                let daysUsage = {};
                daysInWeek.forEach(day => daysUsage[day] = 0);
                
                // Shuffle jokers to assign OFF day randomly but balanced
                let shuffledEmps = [...employees].sort(() => Math.random() - 0.5);
                shuffledEmps.forEach(emp => {
                    // Pick day with min usage
                    let bestDay = daysInWeek.sort((a,b) => daysUsage[a] - daysUsage[b])[0];
                    jokerPlannedOff[emp.id] = bestDay;
                    daysUsage[bestDay]++;
                    // Bucket: 6 Work, 1 OFF (strictly)
                    buckets[emp.id] = { WORK: 6, OFF: 1 };
                });
            } else {
                employees.forEach(emp => {
                    let flex = emp.flexCounts || { D:1, EN:2, LN:2, OFF:2 };
                    buckets[emp.id] = { ...flex };
                });
            }

            let shuffledDays = [...daysInWeek].sort(() => Math.random() - 0.5);

            shuffledDays.forEach(dayNum => {
                let todaysNeeds = dailyNeeds[dayNum];
                let activeEmps = [...employees].sort(() => Math.random() - 0.5);

                activeEmps.forEach(emp => {
                    // âœ… FIX: Ensure emp object exists in sched
                    if (!sched[emp.id]) sched[emp.id] = {};

                    if(handleExceptionsImproved(emp, dayNum, sched, workStreaks, empPrevShift)) {
                        if(type === 'rolling' && sched[emp.id][dayNum].shift === 'OFF' && buckets[emp.id].OFF > 0) buckets[emp.id].OFF--;
                        return;
                    }

                    let bucket = buckets[emp.id];
                    let prev = empPrevShift[emp.id];
                    let streak = workStreaks[emp.id];
                    let assigned = "OFF";

                    // Determine Constraint
                    let mustRest = (streak >= 5);
                    let isJokerPlannedOff = (type === 'joker' && jokerPlannedOff[emp.id] === dayNum);
                    
                    if (mustRest || isJokerPlannedOff) {
                        assigned = "OFF";
                    } else {
                        // Priority logic
                        let canD = !isShiftFlipViolation(prev, 'D') && (type==='joker' ? true : bucket.D > 0);
                        let canEN = !isShiftFlipViolation(prev, 'EN') && (type==='joker' ? true : bucket.EN > 0);
                        let canLN = !isShiftFlipViolation(prev, 'LN') && (type==='joker' ? true : bucket.LN > 0);

                        if(type === 'joker') {
                            // Joker: Aggressive Work
                            if (todaysNeeds.LN > 0 && canLN) { assigned = "LN"; todaysNeeds.LN--; }
                            else if (todaysNeeds.EN > 0 && canEN) { assigned = "EN"; todaysNeeds.EN--; }
                            else if (todaysNeeds.D > 0 && canD) { assigned = "D"; todaysNeeds.D--; }
                            else {
                                // Must work (it's not their off day)
                                if(canLN) assigned = "LN";
                                else if(canEN) assigned = "EN";
                                else if(canD) assigned = "D";
                                else assigned = "OFF"; // Stuck
                            }

                        } else {
                            // Rolling Logic
                            if (todaysNeeds.D > 0 && canD) { assigned = "D"; todaysNeeds.D--; bucket.D--; }
                            else if (todaysNeeds.EN > 0 && canEN) { assigned = "EN"; todaysNeeds.EN--; bucket.EN--; }
                            else if (todaysNeeds.LN > 0 && canLN) { assigned = "LN"; todaysNeeds.LN--; bucket.LN--; }
                            else {
                                if(bucket.OFF > 0) { assigned = "OFF"; bucket.OFF--; }
                                else if(canD && bucket.D > 0) { assigned = "D"; bucket.D--; }
                                else if(canEN && bucket.EN > 0) { assigned = "EN"; bucket.EN--; }
                                else if(canLN && bucket.LN > 0) { assigned = "LN"; bucket.LN--; }
                                else assigned = "OFF"; 
                            }
                        }
                    }

                    sched[emp.id][dayNum] = { shift: assigned, depot: "" };
                    empPrevShift[emp.id] = assigned;
                    updateStreak(emp.id, assigned, workStreaks);
                });
            });

            currentDay = d + 1;
        }
    }

    // --- SHARED HELPERS ---
    function updateStreak(empId, shift, streaks) {
        if(shift === 'OFF' || shift === 'X' || shift === '') streaks[empId] = 0;
        else streaks[empId] = (streaks[empId] || 0) + 1;
    }
    
    function handleExceptionsImproved(emp, d, sched, streaks, prevShifts) {
        // âœ… FIX: Ensure object exists
        if (!sched[emp.id]) sched[emp.id] = {};

        const exc = emp.exceptions || {};
        const offDates = (exc.offDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
        const xDates = (exc.xDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
        
        if (xDates.includes(d)) { 
            sched[emp.id][d] = { shift: "X", depot: "" }; 
            updateStreak(emp.id, "X", streaks);
            prevShifts[emp.id] = "X";
            return true; 
        }
        if (offDates.includes(d)) { 
            sched[emp.id][d] = { shift: "OFF", depot: "" }; 
            updateStreak(emp.id, "OFF", streaks);
            prevShifts[emp.id] = "OFF";
            return true; 
        }
        return false;
    }
    
    function applyWeeklyImproved(emp, numDays, sched, dailyNeeds, streaks, prevShifts) {
        // âœ… FIX: Ensure object exists
        if (!sched[emp.id]) sched[emp.id] = {};

        const exc = emp.exceptions || {};
        const offDates = (exc.offDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
        const xDates = (exc.xDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
        
        for(let d=1; d<=numDays; d++) {
            let shift = sched[emp.id][d] ? sched[emp.id][d].shift : "";
            if (shift === "") {
                const date = new Date(appConfig.year, appConfig.month - 1, d);
                shift = emp.weeklyTemplate[date.getDay()];
                if (xDates.includes(d)) shift = "X"; 
                else if (offDates.includes(d)) shift = "OFF";
                
                const currentStreak = streaks[emp.id] || 0;
                if(currentStreak >= 5 && ["D","EN","LN"].includes(shift)) shift = "OFF";
                
                const prev = prevShifts[emp.id];
                if(isShiftFlipViolation(prev, shift)) {
                    if(!isShiftFlipViolation(prev, 'LN')) shift = 'LN';
                    else shift = 'OFF';
                }
                
                sched[emp.id][d] = { shift: shift, depot: "" };
            }
            
            if (["D","EN","LN"].includes(shift)) {
                if(dailyNeeds[d][shift] > 0) dailyNeeds[d][shift]--;
                updateStreak(emp.id, shift, streaks);
            } else {
                updateStreak(emp.id, shift, streaks);
            }
            
            prevShifts[emp.id] = shift;
        }
    }

    // --- DEPOT DISTRIBUTOR ---
    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        if(!sched) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());

        if(!confirm("Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø­Ø³Ø¨ Ø­ØµØµ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.")) return;

        for(let d=1; d<=numDays; d++) {
            state.employees.forEach(emp => {
                if(sched[emp.id] && sched[emp.id][d] && ["D","EN","LN"].includes(sched[emp.id][d].shift)) {
                    sched[emp.id][d].depot = ""; 
                }
            });
        }

        let empDepotUsage = {}; state.employees.forEach(e => empDepotUsage[e.id] = {});

        for(let d=1; d<=numDays; d++) {
            let currentCounts = {}; cleanDepots.forEach(dep => { currentCounts[dep] = { D:0, EN:0, LN:0 }; });
            let workersByShift = { D:[], EN:[], LN:[] };
            state.employees.forEach(emp => {
                if(sched[emp.id] && sched[emp.id][d]) {
                    const s = sched[emp.id][d].shift;
                    if(["D","EN","LN"].includes(s)) workersByShift[s].push(emp);
                }
            });

            ["D", "EN", "LN"].forEach(shiftType => {
                let workers = workersByShift[shiftType];
                if(workers.length === 0) return;
                cleanDepots.forEach(dep => {
                    let needed = 0;
                    let r = reqs[dep] || reqs[dep.trim()];
                    if(r) needed = r[shiftType] || 0;
                    workers.sort((a, b) => {
                        let quotaA = (a.depotQuotas && a.depotQuotas[dep]) || 0;
                        let quotaB = (b.depotQuotas && b.depotQuotas[dep]) || 0;
                        let usedA = (empDepotUsage[a.id][dep] || 0);
                        let usedB = (empDepotUsage[b.id][dep] || 0);
                        return (quotaB - usedB) - (quotaA - usedA);
                    });
                    let i = 0;
                    while(i < workers.length && currentCounts[dep][shiftType] < needed) {
                        let emp = workers[i];
                        if(!sched[emp.id][d].depot) { 
                            sched[emp.id][d].depot = dep;
                            currentCounts[dep][shiftType]++;
                            if(!empDepotUsage[emp.id][dep]) empDepotUsage[emp.id][dep] = 0;
                            empDepotUsage[emp.id][dep]++;
                        }
                        i++;
                    }
                });
                workers.forEach(emp => {
                    if(!sched[emp.id][d].depot) {
                        let target = cleanDepots.reduce((a, b) => currentCounts[a][shiftType] < currentCounts[b][shiftType] ? a : b);
                        sched[emp.id][d].depot = target;
                        currentCounts[target][shiftType]++;
                    }
                });
            });
        }
        renderSchedule(); saveData();
    }

    function getMonthKey() { return `${appConfig.year}-${appConfig.month}`; }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    
    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = state.schedule[getMonthKey()] || {};
        let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
        for(let d=1; d<=numDays; d++) html += `<th>${d}<br>${WEEKDAYS[new Date(appConfig.year,appConfig.month-1,d).getDay()]}</th>`;
        html += `</tr></thead><tbody>`;
        
        state.employees.forEach(emp => {
            let prev = 'OFF';
            let row = `<tr><td class="emp-col">${emp.name}</td>`;
            for(let d=1; d<=numDays; d++) {
                let cell = (data[emp.id] && data[emp.id][d]) || {shift:''};
                let s = cell.shift || '';
                let violation = isShiftFlipViolation(prev, s) ? 'violation' : '';
                row += `<td class="cell shift-${s} ${violation}">${s}${cell.depot?`<span class="depot-tag">${cell.depot}</span>`:''}</td>`;
                prev = (s!=='OFF' && s!=='X' && s!=='') ? s : s;
            }
            html += row + `</tr>`;
        });
        grid.innerHTML = html + `</tbody>`;
        analyzeCoverage();
    }

    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = state.schedule[getMonthKey()] || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());
        const reqs = state.meta.requirements || {};
        let issues = [];
        let flips = 0;

        state.employees.forEach(emp => {
            let prev = 'OFF';
            for(let d=1; d<=numDays; d++) {
                let s = (sched[emp.id] && sched[emp.id][d]) ? sched[emp.id][d].shift : '';
                if(s) {
                    if(isShiftFlipViolation(prev, s)) {
                        flips++;
                        issues.push(`ğŸš¨ Ù‚Ù„Ø¨Ø© Ø´ÙØª: ${emp.name} ÙŠÙˆÙ… ${d} (${prev}->${s})`);
                    }
                    prev = s;
                }
            }
        });

        for(let d=1; d<=numDays; d++) {
            let counts = {}; cleanDepots.forEach(dep => counts[dep] = {D:0,EN:0,LN:0});
            state.employees.forEach(e => {
                let c = (sched[e.id] && sched[e.id][d]);
                if(c && c.depot && c.shift && ['D','EN','LN'].includes(c.shift)) counts[c.depot.trim()][c.shift]++;
            });
            cleanDepots.forEach(dep => {
                let r = reqs[dep] || reqs[dep.trim()];
                if(r) {
                    ['D','EN','LN'].forEach(s => {
                        if(counts[dep][s] < (r[s]||0)) issues.push(`ÙŠÙˆÙ… ${d} ${dep} (${s}): Ù…Ø·Ù„ÙˆØ¨ ${r[s]}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${counts[dep][s]}`);
                    });
                }
            });
        }

        if(issues.length === 0) report.innerHTML = `<div class="report-ok">âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù…ØªØ§Ø² ÙˆØ®Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡!</div>`;
        else report.innerHTML = (flips>0 ? `<div class="alert-box" style="background:#fee2e2;color:#991b1b">âš ï¸ ÙŠÙˆØ¬Ø¯ ${flips} Ù‚Ù„Ø¨Ø© Ø´ÙØª!</div>` : '') + 
            issues.map(i => `<div class="report-item">${i}</div>`).join('');
    }

    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        let csv = "\uFEFFM,";
        for(let d=1; d<=numDays; d++) csv += d + ","; csv += "\n";
        let data = state.schedule[getMonthKey()] || {};
        state.employees.forEach(e => {
            csv += `"${e.name}",`;
            for(let d=1; d<=numDays; d++) {
                let c = (data[e.id] && data[e.id][d]) || {};
                csv += `"${c.shift || ''} ${c.depot||''}",`;
            }
            csv += "\n";
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'schedule.csv'; a.click();
    }
</script>
</body>
</html>
