<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ø§Ù„Ù…ØµØ­Ø­)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --border: #cbd5e1;
            --cell-w: 45px;
            --header-h: 40px;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg); font-size: 14px; direction: rtl; }
        
        /* Layout */
        .app-container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; align-items: center; }
        .toolbar h1 { margin: 0; font-size: 1.2rem; margin-left: auto; }
        
        /* Buttons & Inputs */
        button { cursor: pointer; padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; font-weight: 500; font-family: inherit; }
        button:hover { background: #f1f5f9; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.danger { background: #ef4444; color: white; border-color: #ef4444; }
        input, select { padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-family: inherit; }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }
        .view { display: none; }
        .view.active { display: block; }

        /* Schedule Grid */
        .grid-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding-bottom: 10px; }
        .schedule-table { border-collapse: collapse; width: 100%; min-width: 1000px; }
        .schedule-table th, .schedule-table td { border: 1px solid var(--border); text-align: center; padding: 4px; height: 35px; }
        .schedule-table th { background: #f1f5f9; position: sticky; top: 0; z-index: 10; font-size: 0.85rem; }
        .schedule-table th.emp-col { position: sticky; right: 0; z-index: 20; background: #f1f5f9; width: 160px; text-align: right; padding-right: 10px; border-left: 2px solid #ddd; }
        .schedule-table td.emp-col { position: sticky; right: 0; z-index: 5; background: white; text-align: right; padding-right: 10px; font-weight: 500; border-left: 2px solid #ddd; }
        
        /* Cell Styling */
        .cell { cursor: pointer; font-size: 0.8rem; line-height: 1.1; user-select: none; }
        .cell.shift-D { background-color: #dbeafe; color: #1e40af; } /* Ù†Ù‡Ø§Ø± - Ø£Ø²Ø±Ù‚ */
        .cell.shift-EN { background-color: #fef3c7; color: #92400e; } /* Ø£ÙˆÙ„ Ù„ÙŠÙ„ - Ø£ØµÙØ± */
        .cell.shift-LN { background-color: #1e293b; color: #f8fafc; } /* Ø¢Ø®Ø± Ù„ÙŠÙ„ - ÙƒØ­Ù„ÙŠ */
        .cell.shift-OFF { background-color: #ecfdf5; color: #047857; } /* Ø¥Ø¬Ø§Ø²Ø© - Ø£Ø®Ø¶Ø± */
        .cell.shift-X { background-color: #fee2e2; color: #b91c1c; font-weight: bold; } /* ØºÙŠØ§Ø¨ - Ø£Ø­Ù…Ø± */
        
        /* Stats & Warnings */
        .stat-box { font-size: 0.70rem; color: #64748b; margin-top: 2px; display:flex; gap:3px; flex-wrap:wrap;}
        .violation { border: 3px solid #ef4444 !important; position: relative; }
        
        /* Requirements Table */
        .req-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .req-table th, .req-table td { border: 1px solid #eee; padding: 8px; text-align: center; }
        .req-table th { background: #f8fafc; }
        .req-input { width: 50px; text-align: center; }

        /* Employee Manager */
        .emp-card { border: 1px solid var(--border); background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .emp-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .pattern-editor { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px dashed #cbd5e1; }
        
        /* Loading Overlay */
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; font-weight: bold; font-size: 1.2rem; color: var(--primary); display: none; flex-direction: column; gap: 10px;}
        
        .depot-tag { font-size: 0.65rem; display: block; opacity: 0.8; }
        .note { font-size: 0.75rem; color: #64748b; margin-top: 5px; }

        /* Report Box */
        .report-box { margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid var(--border); }
        .report-item { color: #b91c1c; margin-bottom: 4px; display: flex; align-items: center; gap: 5px; font-weight: 500; }
        .report-ok { color: #047857; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader">
    <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    <div style="font-size:0.9rem; font-weight:normal;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
</div>

<div class="app-container">
    <div class="toolbar">
        <h1>ğŸ—“ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</h1>
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <button onclick="loadData()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        <div style="flex-grow:1; text-align:left;">
             <span id="lastUpdated" style="font-size:0.8rem; color:gray;"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
        <div class="tab" onclick="switchTab('employees')">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø£Ù†Ù…Ø§Ø·</div>
        <div class="tab" onclick="switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
    </div>

    <div id="view-schedule" class="view active">
        <div class="toolbar" style="background: transparent; padding: 0; box-shadow: none; justify-content: space-between;">
            <div>
                <button onclick="generateSchedule()" class="primary">âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª (Ø°ÙƒÙŠ)</button>
                <button onclick="fillDepots()">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯)</button>
            </div>
            <div>
                <button onclick="clearMonth()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ù‡Ø±</button>
                <button onclick="exportCSV()">ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„ (CSV)</button>
            </div>
        </div>
        <div class="grid-container">
            <table class="schedule-table" id="scheduleGrid">
                </table>
        </div>
        <div id="coverageReport" class="report-box">
            <p>Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Øµ...</p>
        </div>
    </div>

    <div id="view-employees" class="view">
        <button class="primary" onclick="addEmployee()" style="margin-bottom: 15px;">+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
        <div id="employeeList">
            </div>
    </div>

    <div id="view-settings" class="view">
        <div class="emp-card">
            <h3>1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
            <p class="note">Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨ÙØ§ØµÙ„Ø©</p>
            <input type="text" id="settingDepots" style="width: 100%;" value="Ù…ÙˆÙ‚Ø¹ 1, Ù…ÙˆÙ‚Ø¹ 2" onchange="updateDepots()">
        </div>

        <div class="emp-card">
            <h3>2. Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ ÙƒÙ„ Ù…ÙˆÙ‚Ø¹ (Requirements)</h3>
            <p class="note">Ø­Ø¯Ø¯ ÙƒÙ… Ù…ÙˆØ¸Ù ØªØ­ØªØ§Ø¬ ÙÙŠ ÙƒÙ„ Ø´ÙØª. (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)</p>
            <div id="requirementsContainer"></div>
        </div>

        <div class="emp-card">
            <h3>3. Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h3>
            <button class="danger" onclick="saveData(true)">Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // <--- Ø¶Ø¹ Ø±Ø§Ø¨Ø· Google Web App Ù‡Ù†Ø§
    
    // --- STATE ---
    let state = {
        employees: [],
        schedule: {}, 
        meta: { requirements: {} } 
    };
    
    let appConfig = {
        depots: ["Main", "North"],
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1 
    };

    const SHIFTS = ["D", "EN", "LN", "OFF", "X"];
    const WEEKDAYS = ["Ø£Ø­Ø¯", "Ø§Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"];

    // --- INITIALIZATION ---
    window.onload = () => {
        initDateSelectors();
        loadData();
    };

    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const currYear = new Date().getFullYear();
        
        for(let y = currYear - 1; y <= currYear + 2; y++) {
            ySel.add(new Option(y, y));
        }
        ySel.value = currYear;

        const monthsAr = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        monthsAr.forEach((m, i) => {
            mSel.add(new Option(m, i+1));
        });
        mSel.value = new Date().getMonth() + 1;

        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderSchedule(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderSchedule(); };
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${tabName}`).classList.add('active');
    }

    // --- API CALLS ---
    async function loadData() {
        showLoader(true);
        try {
            const res = await fetch(`${API_URL}?action=load`);
            const json = await res.json();
            if (json.ok) {
                state = json.data;
                
                // --- Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ---
                if (state.meta && state.meta.depots && state.meta.depots.length > 0) {
                    appConfig.depots = state.meta.depots;
                } else {
                    appConfig.depots = ["Budaiya", "IsaTown"]; 
                }

                if (!state.meta) state.meta = {};
                if (!state.meta.requirements) state.meta.requirements = {};

                document.getElementById('settingDepots').value = appConfig.depots.join(', ');
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                state.employees.forEach(emp => {
                    if(!emp.patternType) emp.patternType = 'weekly';
                    if(!emp.rollingPattern) emp.rollingPattern = "D,D,EN,EN,LN,LN,OFF,OFF"; 
                });

                renderEmployees();
                renderRequirementsTable();
                renderSchedule();
                updateLastUpdated();
            } else {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: " + json.error);
            }
        } catch (e) {
            console.error(e);
            alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
        } finally {
            showLoader(false);
        }
    }

    async function saveData(reset = false) {
        showLoader(true);
        if(reset) {
            if(!confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { showLoader(false); return; }
            state.employees = [];
            state.schedule = {};
            state.meta = { requirements: {}, depots: [] };
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹Ù‡Ø§
        state.meta.depots = appConfig.depots; 

        try {
            const payload = { action: "save", payload: { employees: state.employees, schedule: state.schedule, meta: state.meta } };
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (json.ok) {
                state.meta.updatedAt = json.meta.updatedAt;
                updateLastUpdated();
                renderSchedule(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            } else {
                alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + json.error);
            }
        } catch (e) {
            console.error(e);
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.");
        } finally {
            showLoader(false);
        }
    }

    function updateLastUpdated() {
        if(state.meta.updatedAt) {
            const date = new Date(state.meta.updatedAt);
            document.getElementById('lastUpdated').innerText = "Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©: " + date.toLocaleTimeString();
        }
    }

    // --- REQUIREMENTS SETTINGS ---
    function renderRequirementsTable() {
        const container = document.getElementById('requirementsContainer');
        let html = `<table class="req-table"><thead><tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>Ù†Ù‡Ø§Ø± (D)</th><th>Ø£ÙˆÙ„ Ù„ÙŠÙ„ (EN)</th><th>Ø¢Ø®Ø± Ù„ÙŠÙ„ (LN)</th></tr></thead><tbody>`;
        
        appConfig.depots.forEach(depot => {
            const req = state.meta.requirements[depot] || { D:0, EN:0, LN:0 };
            html += `<tr>
                <td style="font-weight:bold;">${depot}</td>
                <td><input type="number" min="0" class="req-input" value="${req.D || 0}" onchange="updateReq('${depot}', 'D', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.EN || 0}" onchange="updateReq('${depot}', 'EN', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.LN || 0}" onchange="updateReq('${depot}', 'LN', this.value)"></td>
            </tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function updateReq(depot, shift, val) {
        if(!state.meta.requirements) state.meta.requirements = {};
        if(!state.meta.requirements[depot]) state.meta.requirements[depot] = {};
        state.meta.requirements[depot][shift] = parseInt(val) || 0;
    }

    // --- EMPLOYEE MANAGEMENT ---
    function addEmployee() {
        const id = "emp_" + Math.random().toString(36).substr(2, 9);
        state.employees.push({
            id: id,
            name: "Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯",
            patternType: "weekly", 
            weeklyTemplate: ["OFF", "D", "D", "D", "D", "D", "OFF"], 
            rollingPattern: "D,D,EN,EN,LN,LN,OFF,OFF", 
            exceptions: { offDates: "", xDates: "" }
        });
        renderEmployees();
    }

    function updateEmployee(id, field, value) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) {
            emp[field] = value;
            if(field === 'name' || field === 'patternType') renderEmployees(); 
        }
    }

    function updateWeeklyTemplate(id, dayIndex, val) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) emp.weeklyTemplate[dayIndex] = val;
    }

    function updateExceptions(id, type, val) {
         const emp = state.employees.find(e => e.id === id);
         if(emp) {
             if(!emp.exceptions) emp.exceptions = { offDates:"", xDates:"" };
             emp.exceptions[type] = val;
         }
    }

    function deleteEmployee(id) {
        if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙØŸ")) return;
        state.employees = state.employees.filter(e => e.id !== id);
        renderEmployees();
        renderSchedule();
        saveData(); 
    }

    function renderEmployees() {
        const container = document.getElementById('employeeList');
        container.innerHTML = "";
        
        state.employees.forEach(emp => {
            const div = document.createElement('div');
            div.className = "emp-card";
            
            let weekHtml = "";
            WEEKDAYS.forEach((day, i) => {
                const opts = SHIFTS.map(s => `<option value="${s}" ${emp.weeklyTemplate[i] === s ? 'selected' : ''}>${s}</option>`).join('');
                weekHtml += `
                    <div style="text-align:center;">
                        <label style="font-size:0.7rem; color:#666;">${day}</label>
                        <select onchange="updateWeeklyTemplate('${emp.id}', ${i}, this.value)" style="width:100%">${opts}</select>
                    </div>`;
            });

            let patternEditorHtml = "";
            if(emp.patternType === 'rolling') {
                patternEditorHtml = `
                    <div class="pattern-editor">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø´ÙØªØ§Øª (Ø§Ù„Ø¯ÙˆØ±Ø©):</label>
                        <input type="text" value="${emp.rollingPattern}" onchange="updateEmployee('${emp.id}', 'rollingPattern', this.value)" style="width:98%; font-family:monospace; letter-spacing:1px;">
                        <div class="note">Ø§ÙƒØªØ¨ Ø§Ù„Ø´ÙØªØ§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©. Ù…Ø«Ø§Ù„: D,D,EN,EN,LN,LN,OFF,OFF</div>
                        <div class="note" style="color:#2563eb">Ø³ÙŠÙ‚ÙˆÙ… "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª" Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ Ø¨Ø¯Ø§ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…Ø· Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù†Ù‚Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
                    </div>
                `;
            } else {
                patternEditorHtml = `
                    <div class="pattern-editor">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ©:</label>
                        <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:5px;">${weekHtml}</div>
                    </div>
                `;
            }

            const exc = emp.exceptions || { offDates:"", xDates:"" };

            div.innerHTML = `
                <div class="emp-header">
                    <input type="text" value="${emp.name}" onchange="updateEmployee('${emp.id}', 'name', this.value)" style="font-weight:bold; font-size:1.1rem;">
                    <select onchange="updateEmployee('${emp.id}', 'patternType', this.value)" style="font-size:0.9rem;">
                        <option value="weekly" ${emp.patternType === 'weekly' ? 'selected' : ''}>Ø£ÙŠØ§Ù… Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø«Ø§Ø¨ØªØ©</option>
                        <option value="rolling" ${emp.patternType === 'rolling' ? 'selected' : ''}>Ø´ÙØª Ø¯ÙˆØ§Ø± (ØªØ³Ù„Ø³Ù„)</option>
                    </select>
                    <button class="danger" onclick="deleteEmployee('${emp.id}')">Ø­Ø°Ù</button>
                </div>
                ${patternEditorHtml}
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <div>
                        <label style="font-size:0.75rem">Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¬Ø§Ø²Ø© (ØªÙˆØ§Ø±ÙŠØ®):</label>
                        <input type="text" style="width:95%" value="${exc.offDates || ''}" placeholder="Ù…Ø«Ø§Ù„: 5, 12, 20" onchange="updateExceptions('${emp.id}', 'offDates', this.value)">
                    </div>
                    <div>
                        <label style="font-size:0.75rem">Ø¥Ø¬Ø¨Ø§Ø± ØºÙŠØ§Ø¨ (ØªÙˆØ§Ø±ÙŠØ®):</label>
                        <input type="text" style="width:95%" value="${exc.xDates || ''}" placeholder="Ù…Ø«Ø§Ù„: 15" onchange="updateExceptions('${emp.id}', 'xDates', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // --- SCHEDULE LOGIC ---
    function getMonthKey() { return `${appConfig.year}-${appConfig.month}`; }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    
    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = (state.schedule[getMonthKey()] || {});
        
        let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
        for(let d=1; d<=numDays; d++) {
            const date = new Date(appConfig.year, appConfig.month - 1, d);
            const dayName = WEEKDAYS[date.getDay()];
            const isWeekend = (date.getDay() === 5 || date.getDay() === 6); 
            html += `<th style="${isWeekend ? 'background:#e2e8f0' : ''}">${d}<br>${dayName}</th>`;
        }
        html += `</tr></thead><tbody>`;

        state.employees.forEach(emp => {
            const empData = data[emp.id] || {};
            let counts = { D:0, EN:0, LN:0, OFF:0, X:0 };
            
            let rowHtml = `<tr><td class="emp-col">
                <div>${emp.name}</div>
                <div class="stat-box" id="stats-${emp.id}"></div>
            </td>`;
            
            let prevShift = null;

            for(let d=1; d<=numDays; d++) {
                const cellData = empData[d] || { shift: "" };
                const shift = cellData.shift || "";
                const depot = cellData.depot || "";
                
                if(counts[shift] !== undefined) counts[shift]++;

                let violation = "";
                if (prevShift === 'LN' && shift === 'D') violation = "violation";
                if (prevShift === 'LN' && shift === 'EN') violation = "violation";
                if (prevShift === 'EN' && shift === 'D') violation = "violation";
                
                if(shift !== 'OFF' && shift !== 'X' && shift !== '') prevShift = shift;
                if(shift === 'OFF' || shift === 'X') prevShift = 'OFF'; 

                const display = (shift === "OFF" || shift === "X") ? shift : (shift ? `${shift}<span class="depot-tag">${depot}</span>` : "");
                
                rowHtml += `<td class="cell shift-${shift} ${violation}" onclick="cycleCell('${emp.id}', ${d})">${display}</td>`;
            }
            rowHtml += `</tr>`;
            html += rowHtml;

            setTimeout(() => {
                const el = document.getElementById(`stats-${emp.id}`);
                if(el) el.innerText = `D:${counts.D} EN:${counts.EN} LN:${counts.LN}`;
            }, 0);
        });

        html += `</tbody>`;
        grid.innerHTML = html;
        analyzeCoverage();
    }

    function cycleCell(empId, day) {
        const key = getMonthKey();
        if(!state.schedule[key]) state.schedule[key] = {};
        if(!state.schedule[key][empId]) state.schedule[key][empId] = {};
        
        const current = state.schedule[key][empId][day] || { shift: "" };
        let idx = SHIFTS.indexOf(current.shift);
        
        if (idx === -1) idx = 0; 
        else idx++; 
        
        let newShift = "";
        let newDepot = "";

        if (idx < SHIFTS.length) {
            newShift = SHIFTS[idx];
            if(["D","EN","LN"].includes(newShift)) {
                newDepot = current.depot || appConfig.depots[0];
            }
        } else {
            newShift = ""; 
        }

        state.schedule[key][empId][day] = { shift: newShift, depot: newDepot };
        renderSchedule();
        saveData();
    }

    // --- GENERATOR LOGIC (SMART STAGGER) ---
    function generateSchedule() {
        if(!confirm("Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù† Ø¨ØªÙˆØ²ÙŠØ¹ 'Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø¯ÙˆØ§Ø±Ø©' Ø¨Ø°ÙƒØ§Ø¡ Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù†Ù‚Øµ Ø¨Ø¯Ù‚Ø©.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ")) return;
        
        const key = getMonthKey();
        if(!state.schedule[key]) state.schedule[key] = {};
        const sched = state.schedule[key];
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        
        // 1. Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙŠÙˆÙ…ÙŠØ§Ù‹
        let dailyNeeds = {};
        const reqs = state.meta.requirements || {};
        
        for(let d=1; d<=numDays; d++) {
            dailyNeeds[d] = { D:0, EN:0, LN:0 };
            appConfig.depots.forEach(dep => {
                if(reqs[dep]) {
                    dailyNeeds[d].D += (reqs[dep].D || 0);
                    dailyNeeds[d].EN += (reqs[dep].EN || 0);
                    dailyNeeds[d].LN += (reqs[dep].LN || 0);
                }
            });
        }

        // 2. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø«Ø§Ø¨ØªÙŠÙ† (Weekly) 
        let currentCoverage = {}; 
        for(let d=1; d<=numDays; d++) currentCoverage[d] = { D:0, EN:0, LN:0 };

        state.employees.forEach(emp => {
            if(!sched[emp.id]) sched[emp.id] = {};
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¸Ù Ø«Ø§Ø¨Øª
            if (emp.patternType !== 'rolling') {
                const exc = emp.exceptions || {};
                const offDates = (exc.offDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                const xDates = (exc.xDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));

                for(let d=1; d<=numDays; d++) {
                    let shift = sched[emp.id][d] ? sched[emp.id][d].shift : "";
                    if (shift === "") {
                        const date = new Date(appConfig.year, appConfig.month - 1, d);
                        shift = emp.weeklyTemplate[date.getDay()];
                        if (xDates.includes(d)) shift = "X";
                        else if (offDates.includes(d)) shift = "OFF";
                        
                        sched[emp.id][d] = { shift: shift, depot: "" };
                    }
                    if (["D","EN","LN"].includes(shift)) {
                        currentCoverage[d][shift]++;
                    }
                }
            } else {
                // ØªØµÙÙŠØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ§Ø±ÙŠÙ† Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹
                for(let d=1; d<=numDays; d++) {
                     sched[emp.id][d] = { shift: "", depot: "" };
                }
            }
        });

        // 3. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¯ÙˆØ§Ø±ÙŠÙ† (Rolling) Ø¨Ø°ÙƒØ§Ø¡
        const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
        
        rollingEmps.forEach(emp => {
            let pattern = emp.rollingPattern.split(',').map(s => s.trim().toUpperCase());
            if(pattern.length === 0) pattern = ["OFF"];
            const pLen = pattern.length;

            const exc = emp.exceptions || {};
            const offDates = (exc.offDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            const xDates = (exc.xDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ "Ø¥Ø²Ø§Ø­Ø©" (Offset) Ù„Ù„Ø¨Ø¯Ø¡
            let bestOffset = 0;
            let bestScore = Infinity; 

            for(let offset = 0; offset < pLen; offset++) {
                let currentScore = 0;
                
                for(let d=1; d<=numDays; d++) {
                    let pIndex = (d - 1 + offset) % pLen; 
                    let proposedShift = pattern[pIndex];

                    if (xDates.includes(d) || offDates.includes(d)) proposedShift = "OFF";

                    if (["D","EN","LN"].includes(proposedShift)) {
                        let needed = dailyNeeds[d][proposedShift];
                        let have = currentCoverage[d][proposedShift];
                        
                        // Ø¥Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø´ÙØª Ù…Ø·Ù„ÙˆØ¨ ÙˆÙ„Ø³Ù‡ Ù…Ø§ ÙƒÙ…Ù„Ù†Ø§ Ø§Ù„Ø¹Ø¯Ø¯ØŒ Ù†Ø¹Ø·ÙŠ Ù†Ù‚Ø§Ø· Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©
                        if (have < needed) {
                            currentScore -= 10; 
                        } else {
                            currentScore += 5; // ÙØ§Ø¦Ø¶
                        }
                    }
                }

                if (currentScore < bestScore) {
                    bestScore = currentScore;
                    bestOffset = offset;
                }
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø£ÙØ¶Ù„ Ø¥Ø²Ø§Ø­Ø©
            for(let d=1; d<=numDays; d++) {
                let pIndex = (d - 1 + bestOffset) % pLen;
                let finalShift = pattern[pIndex];
                
                if (xDates.includes(d)) finalShift = "X";
                else if (offDates.includes(d)) finalShift = "OFF";

                sched[emp.id][d] = { shift: finalShift, depot: "" };

                if (["D","EN","LN"].includes(finalShift)) {
                    currentCoverage[d][finalShift]++;
                }
            }
        });
        
        renderSchedule();
        saveData();
        alert("ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª Ø§Ù„Ø¯ÙˆØ§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ø¬Ø© Ø¨Ø¯Ù‚Ø©.\nØ§Ø¶ØºØ· Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø²Ø± 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹' Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ù…Ø§ÙƒÙ†.");
    }

    // --- DEPOT DISTRIBUTOR (CORRECTED & CLEAN) ---
    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        if(!sched) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª)
        const cleanDepots = appConfig.depots.map(d => d.trim());

        let totalReqs = 0;
        cleanDepots.forEach(d => {
            let r = reqs[d] || reqs[d.trim()];
            if(r) totalReqs += (r.D||0) + (r.EN||0) + (r.LN||0);
        });

        if(totalReqs === 0) {
            alert("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØµÙØ±! ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ ÙˆØ­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
            return;
        }

        if(!confirm("Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø¯Ù‚Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡.\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;

        for(let d=1; d<=numDays; d++) {
            let currentCounts = {}; 
            cleanDepots.forEach(dep => {
                currentCounts[dep] = { D:0, EN:0, LN:0 };
            });

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆÙ…Ø³Ø­ Ù…ÙˆØ§Ù‚Ø¹Ù‡Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ø¸ÙŠÙ)
            let unassigned = { D: [], EN: [], LN: [] };

            state.employees.forEach(emp => {
                if(sched[emp.id] && sched[emp.id][d]) {
                    const cell = sched[emp.id][d];
                    if(["D","EN","LN"].includes(cell.shift)) {
                        cell.depot = ""; // ØªØµÙÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹
                        unassigned[cell.shift].push(cell);
                    }
                }
            });

            // Ø§Ù„ØªÙˆØ²ÙŠØ¹
            ["D", "EN", "LN"].forEach(shiftType => {
                let workers = unassigned[shiftType];
                if(workers.length === 0) return;

                // Ø£) ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Priority)
                cleanDepots.forEach(dep => {
                    let needed = 0;
                    if(reqs[dep]) needed = reqs[dep][shiftType] || 0;
                    else if(reqs[dep.trim()]) needed = reqs[dep.trim()][shiftType] || 0;
                    
                    while (workers.length > 0 && currentCounts[dep][shiftType] < needed) {
                        let cell = workers.pop(); 
                        cell.depot = dep;      
                        currentCounts[dep][shiftType]++;
                    }
                });

                // Ø¨) ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ§Ø¦Ø¶ (Ø¥Ù† ÙˆØ¬Ø¯)
                while (workers.length > 0) {
                    let targetDepot = cleanDepots.reduce((a, b) => 
                        currentCounts[a][shiftType] < currentCounts[b][shiftType] ? a : b
                    );
                    let cell = workers.pop();
                    cell.depot = targetDepot;
                    currentCounts[targetDepot][shiftType]++;
                }
            });
        }
        
        renderSchedule();
        saveData();
        alert("ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡!");
    }

    // --- COVERAGE ANALYSIS (CORRECTED & CLEAN) ---
    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const key = getMonthKey();
        const sched = state.schedule[key] || {};
        const requirements = state.meta.requirements || {};
        
        const cleanDepots = appConfig.depots.map(d => d.trim());
        let issues = [];

        for(let d=1; d<=numDays; d++) {
            let dailyCounts = {}; 
            cleanDepots.forEach(dep => dailyCounts[dep] = {D:0, EN:0, LN:0});

            // Ø§Ù„Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ (ÙŠØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª)
            state.employees.forEach(emp => {
                const cell = (sched[emp.id] && sched[emp.id][d]) ? sched[emp.id][d] : null;
                if(cell && cell.shift && cell.depot) {
                    let cellDepot = cell.depot.trim(); 
                    if(dailyCounts[cellDepot] && dailyCounts[cellDepot][cell.shift] !== undefined) {
                        dailyCounts[cellDepot][cell.shift]++;
                    }
                }
            });

            // Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            cleanDepots.forEach(dep => {
                let req = requirements[dep] || requirements[dep.trim()];
                if(!req) return;

                ["D","EN","LN"].forEach(shift => {
                    const required = req[shift] || 0;
                    const actual = dailyCounts[dep][shift];
                    if(actual < required) {
                        issues.push(`ÙŠÙˆÙ… ${d}: <b>${dep}</b> (Ø´ÙØª ${shift}) - Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ${required}ØŒ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ${actual}`);
                    }
                });
            });
        }

        if(issues.length === 0) {
            report.innerHTML = `<div class="report-ok">âœ… Ø§Ù„ØªØºØ·ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø© (100%) - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ.</div>`;
        } else {
            report.innerHTML = `<h4 style="margin:0 0 10px 0;">âš ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‚Øµ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Missing Staff):</h4>` + 
                issues.map(i => `<div class="report-item">âŒ ${i}</div>`).join('');
        }
    }

    // --- UTILS ---
    function updateDepots() {
        const val = document.getElementById('settingDepots').value;
        appConfig.depots = val.split(',').map(s => s.trim()).filter(s => s);
        renderRequirementsTable();
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        let csv = "\uFEFF"; 
        csv += "Ø§Ù„Ù…ÙˆØ¸Ù,";
        for(let d=1; d<=numDays; d++) csv += d + ",";
        csv += "\n";

        const key = getMonthKey();
        const data = state.schedule[key] || {};

        state.employees.forEach(emp => {
            csv += `"${emp.name}",`;
            for(let d=1; d<=numDays; d++) {
                const cell = (data[emp.id] && data[emp.id][d]) ? data[emp.id][d] : {shift:""};
                let val = cell.shift;
                if(val && cell.depot) val += ` (${cell.depot})`;
                csv += `"${val}",`;
            }
            csv += "\n";
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Schedule_${appConfig.year}_${appConfig.month}.csv`;
        a.click();
    }
</script>
</body>
</html>
