<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ Ù„Ù„Ø´ÙØªØ§Øª </title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --border: #cbd5e1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg); font-size: 13px; direction: rtl; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; margin-left: auto; color: #1e293b; }
        button { cursor: pointer; padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 6px; font-weight: 600; font-family: inherit; transition: all 0.2s; }
        button:hover { background: #e2e8f0; transform: translateY(-1px); }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.danger { background: #ef4444; color: white; border-color: #ef4444; }
        input, select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); }
        .view { display: none; }
        .view.active { display: block; }

        .grid-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .schedule-table { border-collapse: collapse; width: 100%; min-width: 1000px; }
        .schedule-table th, .schedule-table td { border: 1px solid #e2e8f0; text-align: center; padding: 6px; height: 40px; }
        .schedule-table th { background: #f8fafc; position: sticky; top: 0; z-index: 10; font-weight: 700; color: #334155; }
        .schedule-table th.emp-col { position: sticky; right: 0; z-index: 20; background: #f8fafc; width: 180px; text-align: right; padding-right: 15px; border-left: 2px solid #e2e8f0; }
        .schedule-table td.emp-col { position: sticky; right: 0; z-index: 5; background: white; text-align: right; padding-right: 15px; font-weight: 600; border-left: 2px solid #e2e8f0; color: #1e293b; }
        
        .cell { cursor: pointer; font-weight: 600; font-size: 0.85rem; user-select: none; }
        .cell:hover { opacity: 0.8; }
        .cell.shift-D { background-color: #dbeafe; color: #1e40af; } 
        .cell.shift-EN { background-color: #fef3c7; color: #92400e; } 
        .cell.shift-LN { background-color: #1e293b; color: #f8fafc; } 
        .cell.shift-OFF { background-color: #f0fdf4; color: #166534; } 
        .cell.shift-X { background-color: #fef2f2; color: #991b1b; } 
        
        .stat-box { font-size: 0.7rem; color: #64748b; margin-top: 4px; font-weight: normal; }
        .violation { border: 3px solid #ef4444 !important; position: relative; }
        .violation::after { content: "âš ï¸"; position: absolute; top:0; left:0; font-size: 10px; }

        .req-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .req-table th, .req-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        .req-input { width: 60px; text-align: center; padding: 4px; }

        .emp-card { border: 1px solid var(--border); background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .emp-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; }
        
        .pattern-block { background: #f8fafc; padding: 15px; border-radius: 6px; border: 1px dashed #cbd5e1; }
        .flex-counts { display: flex; gap: 15px; flex-wrap: wrap; }
        .flex-counts div { display: flex; align-items: center; gap: 5px; }
        .flex-counts label { font-weight: 600; color: #475569; }
        
        .depot-quotas { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .depot-quotas div { background: #fff7ed; padding: 8px; border-radius: 4px; border: 1px solid #ffedd5; display: flex; justify-content: space-between; align-items: center; }
        
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: var(--primary); font-weight: bold; }
        
        .report-box { margin-top: 20px; background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
        .report-item { margin-bottom: 5px; padding: 5px; border-radius: 4px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .report-err { color: #b91c1c; background: #fef2f2; }
        .report-warn { color: #b45309; background: #fffbeb; }
        .report-ok { color: #15803d; background: #f0fdf4; padding: 10px; text-align: center; font-size: 1.1rem; }
        
        .alert-strict { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 6px; border: 1px solid #fecaca; margin-bottom: 10px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div id="loader">
    <div style="font-size: 2rem;">â³</div>
    <div style="margin-top: 10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
</div>

<div class="app-container">
    <div class="toolbar">
        <h1>ğŸ—“ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ Ù„Ù„Ø´ÙØªØ§Øª (Strict Safety)</h1>
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <button onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸</button>
        <div style="flex-grow:1; text-align:left; font-size:0.8rem; color:#64748b;">
             <span id="lastUpdated"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>
        <div class="tab" onclick="switchTab('employees')">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <div class="tab" onclick="switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <div id="view-schedule" class="view active">
        <div class="alert-strict">
            â›” Ù‚ÙˆØ§Ø¹Ø¯ ØµØ§Ø±Ù…Ø© Ù…ÙØ¹Ù„Ø©: Ù…Ù…Ù†ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (LN â” D/EN) ÙˆÙ…Ù…Ù†ÙˆØ¹ (EN â” D). Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.
        </div>
        <div class="toolbar" style="background:transparent; padding:0; box-shadow:none; justify-content:space-between;">
            <div style="display:flex; gap:10px;">
                <button onclick="generateScheduleStrict()" class="primary">âš¡ ØªÙˆØ²ÙŠØ¹ ØµØ§Ø±Ù… (Safety First)</button>
                <button onclick="fillDepots()">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="clearMonth()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
                <button onclick="exportCSV()">ğŸ“„ Excel</button>
            </div>
        </div>
        <div class="grid-container">
            <table class="schedule-table" id="scheduleGrid"></table>
        </div>
        <div id="coverageReport" class="report-box"></div>
    </div>

    <div id="view-employees" class="view">
        <button class="primary" onclick="addEmployee()" style="margin-bottom: 20px;">+ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
        <div id="employeeList"></div>
    </div>

    <div id="view-settings" class="view">
        <div class="emp-card">
            <h3>1. Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
            <input type="text" id="settingDepots" style="width: 100%;" onchange="updateDepots()">
        </div>
        <div class="emp-card">
            <h3>2. Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ (Requirements)</h3>
            <div id="requirementsContainer"></div>
        </div>
        <div class="emp-card">
            <h3>3. ØªØ­ÙƒÙ…</h3>
            <button class="danger" onclick="saveData(true)">âš ï¸ ØªØµÙÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // <--- Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§
    
    // --- STATE ---
    let state = { employees: [], schedule: {}, meta: { requirements: {} } };
    let appConfig = { depots: ["Main"], year: new Date().getFullYear(), month: new Date().getMonth() + 1 };
    const SHIFTS = ["D", "EN", "LN", "OFF", "X"];
    const WEEKDAYS = ["Ø£Ø­Ø¯", "Ø§Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"];

    // ==========================================
    // === CORE LOGIC: THE STRICT SAFETY GATE ===
    // ==========================================
    
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡ÙŠ "Ø§Ù„Ø­Ø§Ø±Ø³" Ø§Ù„Ø°ÙŠ ÙŠÙ…Ù†Ø¹ Ø£ÙŠ Ù‚Ù„Ø¨Ø© Ø´ÙØª
    function getSafeShifts(prevShift) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù…Ø³ Ø¥Ø¬Ø§Ø²Ø© Ø£Ùˆ ØºÙŠØ§Ø¨ Ø£Ùˆ ØºÙŠØ± Ù…Ø­Ø¯Ø¯ØŒ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø³Ù…ÙˆØ­
        if (!prevShift || prevShift === 'OFF' || prevShift === 'X' || prevShift === '') {
            return ['D', 'EN', 'LN', 'OFF'];
        }

        // Ù‚Ø§Ø¹Ø¯Ø© 1: Ø¥Ø°Ø§ Ø£Ù…Ø³ (Ø¢Ø®Ø± Ù„ÙŠÙ„ LN) -> Ù…Ù…Ù†ÙˆØ¹ Ù†Ù‡Ø§Ø± ÙˆÙ…Ù…Ù†ÙˆØ¹ Ø£ÙˆÙ„ Ù„ÙŠÙ„
        if (prevShift === 'LN') {
            return ['LN', 'OFF']; // Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· ÙŠÙƒÙ…Ù„ Ù„ÙŠÙ„ Ø£Ùˆ ÙŠØ£Ø®Ø° Ø¥Ø¬Ø§Ø²Ø©
        }

        // Ù‚Ø§Ø¹Ø¯Ø© 2: Ø¥Ø°Ø§ Ø£Ù…Ø³ (Ø£ÙˆÙ„ Ù„ÙŠÙ„ EN) -> Ù…Ù…Ù†ÙˆØ¹ Ù†Ù‡Ø§Ø±
        if (prevShift === 'EN') {
            return ['EN', 'LN', 'OFF']; // Ù…Ø³Ù…ÙˆØ­ Ø£ÙˆÙ„ Ù„ÙŠÙ„ØŒ Ø¢Ø®Ø± Ù„ÙŠÙ„ØŒ Ø¥Ø¬Ø§Ø²Ø©
        }

        // Ù‚Ø§Ø¹Ø¯Ø© 3: Ø¥Ø°Ø§ Ø£Ù…Ø³ (Ù†Ù‡Ø§Ø± D) -> ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø³Ù…ÙˆØ­
        if (prevShift === 'D') {
            return ['D', 'EN', 'LN', 'OFF'];
        }

        return ['OFF']; // Fallback
    }

    // ==========================================
    // === GENERATOR: STRICT MODE ===
    // ==========================================

    function generateScheduleStrict() {
        if(!confirm("Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù†Ø¸Ø§Ù… 'Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØªØ§Ù…'.\nØ³ÙŠØªÙ… Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯ÙˆØ±Ù‡ ÙŠØ³Ø¨Ø¨ Ù‚Ù„Ø¨Ø© Ø´ÙØª.\nÙ‡Ù„ Ø£Ù†Øª Ù…ÙˆØ§ÙÙ‚ØŸ")) return;

        showLoader(true);
        setTimeout(() => {
            // Run logic inside timeout to render loader
            const key = getMonthKey();
            state.schedule[key] = {}; // Reset
            const sched = state.schedule[key];
            const numDays = daysInMonth(appConfig.year, appConfig.month);
            const reqs = state.meta.requirements || {};
            const cleanDepots = appConfig.depots.map(d => d.trim());

            // 1. Calculate Daily Needs
            let dailyNeeds = {};
            for(let d=1; d<=numDays; d++) {
                dailyNeeds[d] = { D:0, EN:0, LN:0 };
                cleanDepots.forEach(dep => {
                    let r = reqs[dep] || reqs[dep.trim()];
                    if(r) {
                        dailyNeeds[d].D += (r.D||0);
                        dailyNeeds[d].EN += (r.EN||0);
                        dailyNeeds[d].LN += (r.LN||0);
                    }
                });
            }

            // Trackers
            let workStreaks = {}; 
            let prevShifts = {};
            state.employees.forEach(e => { 
                workStreaks[e.id] = 0; 
                prevShifts[e.id] = 'OFF'; // Start of month assumption
            });

            // 2. Fixed Weekly Employees (Priority 1)
            state.employees.forEach(emp => {
                sched[emp.id] = {};
                if (emp.patternType === 'weekly' || !emp.patternType) {
                    processFixedEmployee(emp, numDays, sched, dailyNeeds, prevShifts, workStreaks);
                }
            });

            // 3. Process Week by Week for Rolling & Joker
            let currentDay = 1;
            while(currentDay <= numDays) {
                // Determine Week Block (Sun -> Sat)
                let daysInWeek = [];
                let d = currentDay;
                while(d <= numDays) {
                    daysInWeek.push(d);
                    let date = new Date(appConfig.year, appConfig.month - 1, d);
                    if(date.getDay() === 6) break; // Saturday is end
                    d++;
                }

                // Prepare Buckets for Rolling Employees (Reset Weekly)
                let rollingBuckets = {};
                const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
                rollingEmps.forEach(e => {
                    let flex = e.flexCounts || { D:1, EN:2, LN:2, OFF:2 };
                    rollingBuckets[e.id] = { ...flex };
                });

                // Prepare Virtual Buckets for Jokers (1 OFF per week logic)
                const jokerEmps = state.employees.filter(e => e.patternType === 'joker');
                // Joker logic: Target 6 days work, 1 OFF.
                // We create a bucket of 6 "Any Work" and 1 "OFF"
                let jokerBuckets = {};
                jokerEmps.forEach(e => {
                    jokerBuckets[e.id] = { WORK: 6, OFF: 1 };
                });

                // Process Days in this Week
                daysInWeek.forEach(dayNum => {
                    let todaysNeeds = dailyNeeds[dayNum];

                    // A. Rolling Employees
                    let activeRolling = [...rollingEmps].sort(() => Math.random() - 0.5);
                    activeRolling.forEach(emp => {
                        assignShiftStrict(emp, dayNum, sched, todaysNeeds, prevShifts, workStreaks, rollingBuckets[emp.id], 'rolling');
                    });

                    // B. Joker Employees
                    let activeJokers = [...jokerEmps].sort(() => Math.random() - 0.5);
                    activeJokers.forEach(emp => {
                        assignShiftStrict(emp, dayNum, sched, todaysNeeds, prevShifts, workStreaks, jokerBuckets[emp.id], 'joker');
                    });
                });

                currentDay = d + 1;
            }

            renderSchedule();
            saveData();
            showLoader(false);
            alert("ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹.\nØ±Ø§Ø¬Ø¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù‚Ù„Ø¨Ø§Øª.");
        }, 100);
    }

    function processFixedEmployee(emp, numDays, sched, dailyNeeds, prevShifts, streaks) {
        const exc = emp.exceptions || {};
        const offDates = (exc.offDates||"").split(',').map(n=>parseInt(n)).filter(n=>!isNaN(n));
        
        for(let d=1; d<=numDays; d++) {
            let shift = "";
            let date = new Date(appConfig.year, appConfig.month - 1, d);
            shift = emp.weeklyTemplate[date.getDay()]; // Fixed day

            // Exception check
            if(offDates.includes(d)) shift = "OFF";

            // Safety Check (Even for fixed!)
            // If fixed pattern says D but yesterday was LN -> FORCE OFF
            let safeOptions = getSafeShifts(prevShifts[emp.id]);
            if(!safeOptions.includes(shift) && shift !== 'OFF' && shift !== 'X') {
                shift = "OFF"; // Violation prevented
            }

            // Max 5 days check
            if(streaks[emp.id] >= 5 && shift !== 'OFF') shift = "OFF";

            sched[emp.id][d] = { shift: shift, depot: "" };
            
            // Update needs
            if(["D","EN","LN"].includes(shift)) {
                if(dailyNeeds[d][shift] > 0) dailyNeeds[d][shift]--;
                streaks[emp.id]++;
            } else {
                streaks[emp.id] = 0;
            }
            prevShifts[emp.id] = shift;
        }
    }

    function assignShiftStrict(emp, d, sched, needs, prevShifts, streaks, bucket, type) {
        // 1. Exception Check
        const exc = emp.exceptions || {};
        const offDates = (exc.offDates||"").split(',').map(n=>parseInt(n)).filter(n=>!isNaN(n));
        if(offDates.includes(d)) {
            sched[emp.id][d] = { shift: "OFF", depot: "" };
            prevShifts[emp.id] = "OFF";
            streaks[emp.id] = 0;
            if(type === 'rolling' && bucket.OFF > 0) bucket.OFF--;
            if(type === 'joker' && bucket.OFF > 0) bucket.OFF--;
            return;
        }

        // 2. Determine Safe Options
        let prev = prevShifts[emp.id];
        let safeShifts = getSafeShifts(prev); // e.g. ['LN', 'OFF'] if prev was LN

        // 3. Max Streak Check
        if(streaks[emp.id] >= 5) {
            safeShifts = ['OFF'];
        }

        let assigned = "OFF";

        // 4. Decision Logic
        if(safeShifts.length === 1 && safeShifts[0] === 'OFF') {
            assigned = "OFF";
        } else {
            // We have options. Let's see what is needed AND available in bucket.
            
            // Priorities:
            // Rolling: D (to save night for Joker) -> EN -> LN
            // Joker: LN -> EN -> D (Only if desperate)

            if(type === 'rolling') {
                // Try D
                if(safeShifts.includes('D') && needs.D > 0 && bucket.D > 0) { assigned = 'D'; needs.D--; bucket.D--; }
                else if(safeShifts.includes('EN') && needs.EN > 0 && bucket.EN > 0) { assigned = 'EN'; needs.EN--; bucket.EN--; }
                else if(safeShifts.includes('LN') && needs.LN > 0 && bucket.LN > 0) { assigned = 'LN'; needs.LN--; bucket.LN--; }
                else {
                    // No match with needs. Dump bucket?
                    if(safeShifts.includes('D') && bucket.D > 0) { assigned='D'; bucket.D--; }
                    else if(safeShifts.includes('EN') && bucket.EN > 0) { assigned='EN'; bucket.EN--; }
                    else if(safeShifts.includes('LN') && bucket.LN > 0) { assigned='LN'; bucket.LN--; }
                    else { assigned = 'OFF'; if(bucket.OFF > 0) bucket.OFF--; }
                }
            } 
            else if (type === 'joker') {
                // Joker Logic
                // Must work 6 days if possible (bucket.WORK)
                // If bucket.OFF > 0 and no critical need, maybe take OFF? 
                // Let's be aggressive: Work unless forced OFF.
                
                if(safeShifts.includes('LN') && needs.LN > 0) { assigned = 'LN'; needs.LN--; bucket.WORK--; }
                else if(safeShifts.includes('EN') && needs.EN > 0) { assigned = 'EN'; needs.EN--; bucket.WORK--; }
                else if(safeShifts.includes('D') && needs.D > 0) { assigned = 'D'; needs.D--; bucket.WORK--; } // Joker takes D if needed
                else {
                    // No specific need. Fill a safe spot to keep working?
                    // Prefer Night
                    if(safeShifts.includes('LN')) { assigned = 'LN'; bucket.WORK--; }
                    else if(safeShifts.includes('EN')) { assigned = 'EN'; bucket.WORK--; }
                    else if(safeShifts.includes('D')) { assigned = 'D'; bucket.WORK--; } // Last resort
                    else { assigned = 'OFF'; bucket.OFF--; }
                }
            }
        }

        // Final Safety Net (Should generally be handled above)
        if(!safeShifts.includes(assigned)) assigned = "OFF";

        sched[emp.id][d] = { shift: assigned, depot: "" };
        prevShifts[emp.id] = assigned;
        
        if(assigned === 'OFF' || assigned === 'X') streaks[emp.id] = 0;
        else streaks[emp.id]++;
    }

    // ==========================================
    // === DEPOT LOGIC ===
    // ==========================================
    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        if(!sched) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());

        // Check if reqs exist
        let hasReqs = false;
        cleanDepots.forEach(d => { if(reqs[d]) hasReqs = true; });
        if(!hasReqs) { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ­ÙØ¸Ù‡Ø§."); return; }

        if(!confirm("Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.")) return;

        // Reset depots
        for(let d=1; d<=numDays; d++) {
            state.employees.forEach(emp => {
                if(sched[emp.id] && sched[emp.id][d] && ["D","EN","LN"].includes(sched[emp.id][d].shift)) {
                    sched[emp.id][d].depot = "";
                }
            });
        }

        let empUsage = {}; 
        state.employees.forEach(e => empUsage[e.id] = {});

        for(let d=1; d<=numDays; d++) {
            let counts = {}; cleanDepots.forEach(dep => counts[dep] = { D:0, EN:0, LN:0 });
            let workers = { D:[], EN:[], LN:[] };
            
            // Gather workers
            state.employees.forEach(emp => {
                if(sched[emp.id] && sched[emp.id][d]) {
                    const s = sched[emp.id][d].shift;
                    if(["D","EN","LN"].includes(s)) workers[s].push(emp);
                }
            });

            ["D","EN","LN"].forEach(s => {
                let list = workers[s];
                // Sort by quota priority
                list.sort((a,b) => {
                    // Placeholder for sophisticated sorting
                    return Math.random() - 0.5;
                });

                cleanDepots.forEach(dep => {
                    let r = reqs[dep] || reqs[dep.trim()];
                    let needed = r ? (r[s]||0) : 0;
                    
                    let i = 0;
                    while(i < list.length && counts[dep][s] < needed) {
                        let emp = list[i];
                        if(!sched[emp.id][d].depot) {
                            sched[emp.id][d].depot = dep;
                            counts[dep][s]++;
                        }
                        i++;
                    }
                });

                // Overflow
                list.forEach(emp => {
                    if(!sched[emp.id][d].depot) {
                        // Assign to any with least people? Or first one?
                        sched[emp.id][d].depot = cleanDepots[0]; 
                    }
                });
            });
        }
        renderSchedule(); saveData();
    }

    // ==========================================
    // === STANDARD FUNCTIONS ===
    // ==========================================
    
    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const curr = new Date().getFullYear();
        for(let i=curr-1; i<=curr+2; i++) ySel.add(new Option(i,i));
        ySel.value = curr;
        ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"].forEach((m,i)=>mSel.add(new Option(m,i+1)));
        mSel.value = new Date().getMonth()+1;
        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderSchedule(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderSchedule(); };
    }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${t}`).classList.add('active');
    }

    async function loadData() {
        showLoader(true);
        try {
            let res = await fetch(`${API_URL}?action=load`);
            let json = await res.json();
            if(json.ok) {
                state = json.data;
                if(state.meta && state.meta.depots) appConfig.depots = state.meta.depots;
                else appConfig.depots = ["Budaiya", "IsaTown"];
                document.getElementById('settingDepots').value = appConfig.depots.join(', ');
                renderEmployees(); renderRequirementsTable(); renderSchedule();
                if(state.meta.updatedAt) document.getElementById('lastUpdated').innerText = new Date(state.meta.updatedAt).toLocaleTimeString();
            }
        } catch(e) { console.error(e); alert("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"); } finally { showLoader(false); }
    }

    async function saveData(reset=false) {
        showLoader(true);
        if(reset && !confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")) { showLoader(false); return; }
        if(reset) { state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } }; }
        state.meta.depots = appConfig.depots;
        try {
            await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "save", payload: state }) });
            if(state.meta.updatedAt) document.getElementById('lastUpdated').innerText = new Date().toLocaleTimeString();
        } catch(e) { alert("Ø®Ø·Ø£ Ø­ÙØ¸"); } finally { showLoader(false); }
    }

    function updateDepots() { appConfig.depots = document.getElementById('settingDepots').value.split(',').map(s=>s.trim()).filter(s=>s); renderRequirementsTable(); }
    
    function renderRequirementsTable() {
        let html = `<table class="req-table"><thead><tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>D</th><th>EN</th><th>LN</th></tr></thead><tbody>`;
        appConfig.depots.forEach(d => {
            let r = (state.meta.requirements && state.meta.requirements[d]) || {D:0,EN:0,LN:0};
            html += `<tr><td>${d}</td>
            <td><input type="number" class="req-input" value="${r.D||0}" onchange="updReq('${d}','D',this.value)"></td>
            <td><input type="number" class="req-input" value="${r.EN||0}" onchange="updReq('${d}','EN',this.value)"></td>
            <td><input type="number" class="req-input" value="${r.LN||0}" onchange="updReq('${d}','LN',this.value)"></td></tr>`;
        });
        document.getElementById('requirementsContainer').innerHTML = html + `</tbody></table>`;
    }
    function updReq(d,s,v) { if(!state.meta.requirements) state.meta.requirements={}; if(!state.meta.requirements[d]) state.meta.requirements[d]={}; state.meta.requirements[d][s]=parseInt(v); }

    function renderEmployees() {
        const list = document.getElementById('employeeList'); list.innerHTML = "";
        state.employees.forEach(e => {
            let weekHtml = WEEKDAYS.map((day,i) => `<div><small>${day}</small><select onchange="updEmpWeek('${e.id}',${i},this.value)" style="width:100%">${SHIFTS.map(s=>`<option ${e.weeklyTemplate[i]===s?'selected':''}>${s}</option>`).join('')}</select></div>`).join('');
            
            let quotas = `<div class="depot-quotas">` + appConfig.depots.map(d => `<div><span>${d}</span><input type="number" style="width:40px" value="${(e.depotQuotas&&e.depotQuotas[d])||0}" onchange="updQuota('${e.id}','${d}',this.value)"></div>`).join('') + `</div>`;
            
            let flex = e.flexCounts || {D:1,EN:2,LN:2,OFF:2};
            let typeHtml = e.patternType === 'rolling' ? 
                `<div class="pattern-block"><div class="flex-counts"><div>D <input type="number" style="width:40px" value="${flex.D}" onchange="updFlex('${e.id}','D',this.value)"></div><div>EN <input type="number" style="width:40px" value="${flex.EN}" onchange="updFlex('${e.id}','EN',this.value)"></div><div>LN <input type="number" style="width:40px" value="${flex.LN}" onchange="updFlex('${e.id}','LN',this.value)"></div><div>OFF <input type="number" style="width:40px" value="${flex.OFF}" onchange="updFlex('${e.id}','OFF',this.value)"></div></div></div>` :
                (e.patternType === 'joker' ? `<div class="pattern-block">ğŸƒ Ø¬ÙˆÙƒØ± (Ø£ÙˆÙ„ÙˆÙŠØ© Ù„ÙŠÙ„ÙŠØ©)</div>` : `<div class="pattern-block" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px;">${weekHtml}</div>`);

            let div = document.createElement('div'); div.className = "emp-card";
            div.innerHTML = `<div class="emp-header"><input value="${e.name}" onchange="updEmp('${e.id}','name',this.value)" style="font-weight:bold"><select onchange="updEmp('${e.id}','patternType',this.value)"><option value="weekly" ${e.patternType==='weekly'?'selected':''}>Ø«Ø§Ø¨Øª</option><option value="rolling" ${e.patternType==='rolling'?'selected':''}>Ø¯ÙˆØ§Ø± (Ø£Ø³Ø¨ÙˆØ¹ÙŠ)</option><option value="joker" ${e.patternType==='joker'?'selected':''}>Ø¬ÙˆÙƒØ±</option></select><button class="danger" onclick="delEmp('${e.id}')">X</button></div>${quotas}${typeHtml}`;
            list.appendChild(div);
        });
    }
    
    // Tiny helpers for UI
    function updEmp(id,k,v){ state.employees.find(x=>x.id===id)[k]=v; if(k==='patternType') renderEmployees(); }
    function updEmpWeek(id,i,v){ state.employees.find(x=>x.id===id).weeklyTemplate[i]=v; }
    function updFlex(id,k,v){ let e=state.employees.find(x=>x.id===id); if(!e.flexCounts) e.flexCounts={}; e.flexCounts[k]=parseInt(v); }
    function updQuota(id,k,v){ let e=state.employees.find(x=>x.id===id); if(!e.depotQuotas) e.depotQuotas={}; e.depotQuotas[k]=parseInt(v); }
    function addEmployee(){ state.employees.push({id:'e'+Math.random(), name:'Ø¬Ø¯ÙŠØ¯', patternType:'weekly', weeklyTemplate:Array(7).fill('D'), flexCounts:{D:1,EN:2,LN:2,OFF:2}}); renderEmployees(); }
    function delEmp(id){ if(confirm('Ø­Ø°ÙØŸ')) state.employees=state.employees.filter(x=>x.id!==id); renderEmployees(); }

    function getMonthKey() { return `${appConfig.year}-${appConfig.month}`; }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }

    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = state.schedule[getMonthKey()] || {};
        let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
        for(let d=1; d<=numDays; d++) html += `<th>${d}<br>${WEEKDAYS[new Date(appConfig.year,appConfig.month-1,d).getDay()]}</th>`;
        html += `</tr></thead><tbody>`;
        
        state.employees.forEach(emp => {
            let prev = 'OFF';
            let row = `<tr><td class="emp-col">${emp.name}</td>`;
            for(let d=1; d<=numDays; d++) {
                let cell = (data[emp.id] && data[emp.id][d]) || {shift:''};
                let s = cell.shift || '';
                
                let violation = '';
                // Check Violation for UI
                if(s && (prev==='LN' && (s==='D'||s==='EN'))) violation = 'violation';
                if(s && (prev==='EN' && s==='D')) violation = 'violation';
                
                row += `<td class="cell shift-${s} ${violation}">${s}${cell.depot?`<span class="depot-tag">${cell.depot}</span>`:''}</td>`;
                if(s!=='OFF' && s!=='X' && s!=='') prev=s; else prev=s; // Strict prev? No, usually breaks reset sequence. Let's keep prev as is.
            }
            html += row + `</tr>`;
        });
        grid.innerHTML = html + `</tbody>`;
        analyzeCoverage();
    }

    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = state.schedule[getMonthKey()] || {};
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());
        let html = "";
        let violations = [];

        // Check Flips
        state.employees.forEach(emp => {
            let prev = 'OFF';
            for(let d=1; d<=numDays; d++) {
                let s = (sched[emp.id] && sched[emp.id][d]) ? sched[emp.id][d].shift : '';
                if(s) {
                    if(prev==='LN' && (s==='D'||s==='EN')) violations.push(`${emp.name} ÙŠÙˆÙ… ${d}: LN->${s}`);
                    if(prev==='EN' && s==='D') violations.push(`${emp.name} ÙŠÙˆÙ… ${d}: EN->${s}`);
                    prev = s;
                }
            }
        });

        if(violations.length > 0) {
            html += `<div class="report-err">ğŸ›‘ <strong>ØªÙ†Ø¨ÙŠÙ‡ Ø®Ø·ÙŠØ±:</strong> ØªÙ… Ø±ØµØ¯ Ù‚Ù„Ø¨Ø§Øª Ø´ÙØª Ø±ØºÙ… Ø§Ù„Ø­Ù…Ø§ÙŠØ©! (Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹):<br>${violations.join('<br>')}</div>`;
        }

        // Check Coverage
        let issues = [];
        for(let d=1; d<=numDays; d++) {
            let counts = {}; cleanDepots.forEach(dep => counts[dep] = {D:0,EN:0,LN:0});
            state.employees.forEach(emp => {
                let cell = (sched[emp.id] && sched[emp.id][d]);
                if(cell && cell.depot && cell.shift) {
                    let dep = cell.depot.trim();
                    if(counts[dep] && counts[dep][cell.shift] !== undefined) counts[dep][cell.shift]++;
                }
            });
            cleanDepots.forEach(dep => {
                let r = reqs[dep] || reqs[dep.trim()];
                if(!r) return;
                ['D','EN','LN'].forEach(s => {
                    if(counts[dep][s] < (r[s]||0)) issues.push(`ÙŠÙˆÙ… ${d} ${dep} (${s}): Ù…Ø·Ù„ÙˆØ¨ ${r[s]}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${counts[dep][s]}`);
                });
            });
        }

        if(issues.length === 0) html += `<div class="report-ok">âœ… Ø§Ù„ØªØºØ·ÙŠØ© Ù…Ù…ØªØ§Ø²Ø© 100%</div>`;
        else html += `<div class="report-warn">âš ï¸ <strong>Ù†ÙˆØ§Ù‚Øµ (Ø¨Ø³Ø¨Ø¨ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø³Ù„Ø§Ù…Ø©):</strong><br>${issues.join('<br>')}</div>`;
        
        report.innerHTML = html;
    }

    function clearMonth() { if(confirm('Ù…Ø³Ø­ØŸ')) { state.schedule[getMonthKey()] = {}; renderSchedule(); saveData(); } }
    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    
    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        let csv = "\uFEFFM,";
        for(let d=1; d<=numDays; d++) csv += d + ","; csv += "\n";
        let data = state.schedule[getMonthKey()] || {};
        state.employees.forEach(e => {
            csv += `"${e.name}",`;
            for(let d=1; d<=numDays; d++) {
                let c = (data[e.id] && data[e.id][d]) || {};
                csv += `"${c.shift || ''} ${c.depot||''}",`;
            }
            csv += "\n";
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'schedule.csv'; a.click();
    }
</script>
</body>
</html>
