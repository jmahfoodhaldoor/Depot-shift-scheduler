<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #cbd5e1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg); font-size: 14px; direction: rtl; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; margin-left: auto; }
        button { cursor: pointer; padding: 8px 15px; border: 1px solid var(--border); background: white; border-radius: 5px; font-weight: bold; }
        button:hover { background: #f1f5f9; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.danger { background: #ef4444; color: white; border-color: #ef4444; }
        input, select { padding: 8px; border: 1px solid var(--border); border-radius: 5px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }
        .view { display: none; }
        .view.active { display: block; }
        .grid-container { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid var(--border); }
        .schedule-table { border-collapse: collapse; width: 100%; min-width: 1000px; }
        .schedule-table th, .schedule-table td { border: 1px solid #e2e8f0; text-align: center; padding: 5px; height: 35px; }
        .schedule-table th { background: #f1f5f9; position: sticky; top: 0; }
        .schedule-table th.emp-col { position: sticky; right: 0; z-index: 20; background: #f1f5f9; width: 160px; }
        .schedule-table td.emp-col { position: sticky; right: 0; z-index: 5; background: white; font-weight: bold; }
        .cell { cursor: pointer; font-size: 0.85rem; user-select: none; }
        .cell.shift-D { background-color: #dbeafe; color: #1e40af; } 
        .cell.shift-EN { background-color: #fef3c7; color: #92400e; } 
        .cell.shift-LN { background-color: #1e293b; color: #f8fafc; } 
        .cell.shift-OFF { background-color: #f0fdf4; color: #166534; } 
        .cell.shift-X { background-color: #fef2f2; color: #991b1b; } 
        .violation { border: 3px solid #ef4444 !important; }
        .emp-card { border: 1px solid var(--border); background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .pattern-editor { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px dashed #cbd5e1; margin-top: 10px; }
        .flex-counts { display: flex; gap: 10px; flex-wrap: wrap; }
        .depot-quotas { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .depot-quotas div { background: #fff7ed; padding: 5px; border: 1px solid #ffedd5; border-radius: 4px; }
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; font-weight: bold; color: var(--primary); display: none; }
        .report-box { margin-top: 20px; padding: 15px; background: white; border: 1px solid var(--border); border-radius: 8px; }
        .report-item { margin-bottom: 5px; padding: 5px; background: #fff1f2; color: #9f1239; border-radius: 4px; }
        .report-ok { background: #ecfdf5; color: #065f46; padding: 10px; text-align: center; font-weight: bold; }
        .alert { background: #e0f2fe; color: #0369a1; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-weight: bold; text-align: center; border: 1px solid #bae6fd; }
    </style>
</head>
<body>

<div id="loader">
    <div style="font-size: 2rem;">ğŸ”„</div>
    <div>Ø¬Ø§Ø±ÙŠ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„...</div>
</div>

<div class="app-container">
    <div class="toolbar">
        <h1>ğŸ—“ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„</h1>
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <button onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸</button>
        <div style="flex-grow:1; text-align:left; font-size:0.8rem; color:gray;">
             <span id="lastUpdated"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>
        <div class="tab" onclick="switchTab('employees')">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <div class="tab" onclick="switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <div id="view-schedule" class="view active">
        <div class="alert">
            âš¡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ù„Ø¬ÙˆÙƒØ± ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ ÙŠÙˆÙ… Ø¥Ø¬Ø§Ø²Ø© ÙˆØ§Ø­Ø¯ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹ (Ù…ØªÙØ±Ù‚ÙŠÙ† Ø¹Ù† Ø¨Ø¹Ø¶) | Ù…Ù†Ø¹ Ù‚Ù„Ø¨Ø© Ø§Ù„Ø´ÙØª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.
        </div>
        <div class="toolbar" style="background:transparent; padding:0; box-shadow:none; justify-content:space-between;">
            <div>
                <button onclick="generateScheduleSafe()" class="primary">âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª</button>
                <button onclick="fillDepots()">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
            </div>
            <div>
                <button onclick="clearMonth()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
                <button onclick="exportCSV()">ğŸ“„ Excel</button>
            </div>
        </div>
        <div class="grid-container">
            <table class="schedule-table" id="scheduleGrid"></table>
        </div>
        <div id="coverageReport" class="report-box"></div>
    </div>

    <div id="view-employees" class="view">
        <button class="primary" onclick="addEmployee()" style="margin-bottom: 15px;">+ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
        <div id="employeeList"></div>
    </div>

    <div id="view-settings" class="view">
        <div class="emp-card">
            <h3>1. Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
            <input type="text" id="settingDepots" style="width: 100%;" onchange="updateDepots()">
        </div>
        <div class="emp-card">
            <h3>2. Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ (Requirements)</h3>
            <div id="requirementsContainer"></div>
        </div>
        <div class="emp-card">
            <h3>3. ØªØ­ÙƒÙ…</h3>
            <button class="danger" onclick="saveData(true)">ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // <--- Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§
    
    // --- STATE ---
    let state = { employees: [], schedule: {}, meta: { requirements: {} } };
    let appConfig = { depots: ["Main"], year: new Date().getFullYear(), month: new Date().getMonth() + 1 };
    const SHIFTS = ["D", "EN", "LN", "OFF", "X"];
    const WEEKDAYS = ["Ø£Ø­Ø¯", "Ø§Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"];

    // --- SAFETY CHECK ---
    function isShiftFlipViolation(prev, next) {
        if (!prev || prev === 'OFF' || prev === 'X') return false;
        if (next === 'OFF' || next === 'X') return false;
        // LN -> Ù…Ù…Ù†ÙˆØ¹ D Ø£Ùˆ EN
        if (prev === 'LN') return (next === 'D' || next === 'EN');
        // EN -> Ù…Ù…Ù†ÙˆØ¹ D
        if (prev === 'EN') return (next === 'D');
        return false;
    }

    // --- INITIALIZATION ---
    window.onload = () => { initDateSelectors(); loadData(); };

    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const curr = new Date().getFullYear();
        for(let i=curr-1; i<=curr+2; i++) ySel.add(new Option(i,i));
        ySel.value = curr;
        ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"].forEach((m,i)=>mSel.add(new Option(m,i+1)));
        mSel.value = new Date().getMonth()+1;
        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderSchedule(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderSchedule(); };
    }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${t}`).classList.add('active');
    }

    // --- API ---
    async function loadData() {
        showLoader(true);
        try {
            let res = await fetch(`${API_URL}?action=load`);
            let json = await res.json();
            if(json.ok) {
                state = json.data;
                if(state.meta && state.meta.depots) appConfig.depots = state.meta.depots;
                else appConfig.depots = ["Budaiya", "IsaTown"];
                document.getElementById('settingDepots').value = appConfig.depots.join(', ');
                renderEmployees(); renderRequirementsTable(); renderSchedule();
                if(state.meta.updatedAt) document.getElementById('lastUpdated').innerText = new Date(state.meta.updatedAt).toLocaleTimeString();
            }
        } catch(e) { console.error(e); alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„."); } finally { showLoader(false); }
    }

    async function saveData(reset=false) {
        showLoader(true);
        if(reset && !confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) { showLoader(false); return; }
        if(reset) state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } };
        state.meta.depots = appConfig.depots;
        try {
            await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "save", payload: state }) });
            if(state.meta.updatedAt) document.getElementById('lastUpdated').innerText = new Date().toLocaleTimeString();
        } catch(e) { alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸"); } finally { showLoader(false); }
    }

    // --- GENERATOR: SMART JOKER OFF DISTRIBUTION ---
    function generateScheduleSafe() {
        if(!confirm("Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª.\n- Ø§Ù„Ø¬ÙˆÙƒØ±: Ø¥Ø¬Ø§Ø²Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹ (Ù…ÙˆØ²Ø¹Ø© Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ø§Ø±Ø¶).\n- Ø§Ù„Ø´ÙØª Ø§Ù„Ø¯ÙˆØ§Ø±: Ø¯Ù„Ùˆ Ø£Ø³Ø¨ÙˆØ¹ÙŠ.\n- Ø§Ù„Ø³Ù„Ø§Ù…Ø©: Ù…Ù†Ø¹ Ù‚Ù„Ø¨Ø© Ø§Ù„Ø´ÙØª.")) return;
        
        showLoader(true);
        setTimeout(() => {
            try {
                const key = getMonthKey();
                state.schedule[key] = {};
                const sched = state.schedule[key];
                const numDays = daysInMonth(appConfig.year, appConfig.month);
                const reqs = state.meta.requirements || {};
                const cleanDepots = appConfig.depots.map(d => d.trim());

                // 1. Daily Needs
                let dailyNeeds = {};
                for(let d=1; d<=numDays; d++) {
                    dailyNeeds[d] = { D:0, EN:0, LN:0 };
                    cleanDepots.forEach(dep => {
                        let r = reqs[dep] || reqs[dep.trim()];
                        if(r) {
                            dailyNeeds[d].D += (r.D||0); dailyNeeds[d].EN += (r.EN||0); dailyNeeds[d].LN += (r.LN||0);
                        }
                    });
                }

                let workStreaks = {}; 
                let prevShifts = {};
                state.employees.forEach(e => { workStreaks[e.id]=0; prevShifts[e.id]='OFF'; });

                // 2. Fixed Weekly
                state.employees.forEach(emp => {
                    if(emp.patternType === 'weekly' || !emp.patternType) {
                        applyFixed(emp, numDays, sched, dailyNeeds, workStreaks, prevShifts);
                    } else {
                        sched[emp.id] = {}; 
                    }
                });

                // 3. Rolling & Joker Loop
                const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
                const jokerEmps = state.employees.filter(e => e.patternType === 'joker');

                let currentDay = 1;
                while(currentDay <= numDays) {
                    // Determine Week (Sun-Sat)
                    let daysInWeek = [];
                    let d = currentDay;
                    while(d <= numDays) {
                        daysInWeek.push(d);
                        let date = new Date(appConfig.year, appConfig.month - 1, d);
                        if(date.getDay() === 6) break; 
                        d++;
                    }

                    // A. PRE-DISTRIBUTE JOKER OFFS (The Staggering Logic)
                    // We need to pick 1 OFF day for each Joker in this week.
                    // We want to minimize overlap.
                    let jokerOffCounts = {}; 
                    daysInWeek.forEach(day => jokerOffCounts[day] = 0);

                    // Shuffle Jokers to randomize who gets which day
                    let shuffledJokers = [...jokerEmps].sort(() => Math.random() - 0.5);
                    
                    shuffledJokers.forEach(emp => {
                        // Check if manual exception forces OFF or WORK
                        const exc = getExceptions(emp);
                        let forcedDay = null;
                        
                        // Try to find a day to be OFF based on least congestion
                        // Filter out days where user forced Work (X) - here assume X is absent/work depending on logic, let's assume exceptions override.
                        
                        // Sort days by current OFF count (ascending)
                        let bestDays = daysInWeek.sort((a,b) => jokerOffCounts[a] - jokerOffCounts[b]);
                        
                        let assignedOffDay = bestDays[0]; // Pick the day with fewest Jokers OFF
                        
                        // Mark this day as PRE-ASSIGNED OFF
                        if(!sched[emp.id]) sched[emp.id] = {};
                        // Check constraints (user forced OFF on another day?)
                        // For simplicity, we assign the algorithmic OFF here.
                        // The daily loop below will respect it if it's set to OFF.
                        
                        // We store the "Planned OFF" in a temp map for the daily loop to use
                        emp.plannedOffDay = assignedOffDay;
                        jokerOffCounts[assignedOffDay]++;
                    });

                    // B. Buckets for Rolling
                    let rollingBuckets = {};
                    rollingEmps.forEach(e => {
                        let f = e.flexCounts || {D:1,EN:2,LN:2,OFF:2};
                        rollingBuckets[e.id] = { ...f };
                    });

                    // Process Days
                    daysInWeek.sort((a,b)=>a-b).forEach(dayNum => {
                        let todaysNeeds = dailyNeeds[dayNum];

                        // 1. Rolling (Day First)
                        let activeRol = [...rollingEmps].sort(() => Math.random() - 0.5);
                        activeRol.forEach(emp => {
                            assignSafe(emp, dayNum, sched, todaysNeeds, rollingBuckets[emp.id], workStreaks, prevShifts, 'rolling');
                        });

                        // 2. Joker (Night First, Respect Planned OFF)
                        let activeJok = [...jokerEmps].sort(() => Math.random() - 0.5);
                        activeJok.forEach(emp => {
                            let isPlannedOff = (emp.plannedOffDay === dayNum);
                            assignJokerSafe(emp, dayNum, sched, todaysNeeds, workStreaks, prevShifts, isPlannedOff);
                        });
                    });

                    currentDay = d + 1;
                }

                renderSchedule();
                saveData();
                alert("ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹.\n- Ø§Ù„Ø¬ÙˆØ§ÙƒØ±: ØªÙ… ØªØ´ØªÙŠØª Ø¥Ø¬Ø§Ø²Ø§ØªÙ‡Ù… Ø¹Ù„Ù‰ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.");
            } catch(e) {
                console.error(e);
                alert("Ø®Ø·Ø£: " + e.message);
            } finally {
                showLoader(false);
            }
        }, 50);
    }

    function applyFixed(emp, numDays, sched, needs, streaks, prevs) {
        const exc = getExceptions(emp);
        for(let d=1; d<=numDays; d++) {
            let shift = "";
            let date = new Date(appConfig.year, appConfig.month - 1, d);
            shift = emp.weeklyTemplate[date.getDay()];

            if(exc.xDates.includes(d)) shift = "X";
            else if(exc.offDates.includes(d)) shift = "OFF";

            if(isShiftFlipViolation(prevs[emp.id], shift) || (streaks[emp.id] >= 5 && shift !== 'OFF')) {
                shift = "OFF";
            }

            sched[emp.id][d] = { shift: shift, depot: "" };
            prevs[emp.id] = shift;
            if(['D','EN','LN'].includes(shift)) {
                if(needs[d][shift] > 0) needs[d][shift]--;
                streaks[emp.id]++;
            } else streaks[emp.id] = 0;
        }
    }

    function assignSafe(emp, d, sched, needs, bucket, streaks, prevs, type) {
        const exc = getExceptions(emp);
        if(exc.xDates.includes(d)) { setShift(emp,d,"X",sched,prevs,streaks); return; }
        if(exc.offDates.includes(d)) { setShift(emp,d,"OFF",sched,prevs,streaks); if(bucket.OFF > 0) bucket.OFF--; return; }

        let prev = prevs[emp.id];
        let streak = streaks[emp.id];
        let assigned = "OFF";

        if(streak >= 5) {
            assigned = "OFF";
        } else {
            let canD = (prev !== 'LN' && prev !== 'EN');
            let canEN = (prev !== 'LN');
            let canLN = true; 

            // Rolling: Priority D > EN > LN
            if(canD && needs.D > 0 && bucket.D > 0) { assigned = 'D'; needs.D--; bucket.D--; }
            else if(canEN && needs.EN > 0 && bucket.EN > 0) { assigned = 'EN'; needs.EN--; bucket.EN--; }
            else if(canLN && needs.LN > 0 && bucket.LN > 0) { assigned = 'LN'; needs.LN--; bucket.LN--; }
            else {
                if(bucket.OFF > 0) { assigned = 'OFF'; bucket.OFF--; }
                else if(canD && bucket.D > 0) { assigned = 'D'; bucket.D--; }
                else if(canEN && bucket.EN > 0) { assigned = 'EN'; bucket.EN--; }
                else if(canLN && bucket.LN > 0) { assigned = 'LN'; bucket.LN--; }
            }
        }
        setShift(emp, d, assigned, sched, prevs, streaks);
    }

    function assignJokerSafe(emp, d, sched, needs, streaks, prevs, isPlannedOff) {
        const exc = getExceptions(emp);
        if(exc.xDates.includes(d)) { setShift(emp,d,"X",sched,prevs,streaks); return; }
        if(exc.offDates.includes(d)) { setShift(emp,d,"OFF",sched,prevs,streaks); return; }

        // If this is the planned OFF day from the staggering algorithm
        if (isPlannedOff) {
            setShift(emp, d, "OFF", sched, prevs, streaks);
            return;
        }

        let prev = prevs[emp.id];
        let streak = streaks[emp.id];
        let assigned = "OFF";

        // Must work unless streak limit or flip violation prevents it
        // Joker Priority: LN > EN > D
        let canD = (prev !== 'LN' && prev !== 'EN');
        let canEN = (prev !== 'LN');
        
        // Check Needs first
        if (needs.LN > 0) { assigned = "LN"; needs.LN--; }
        else if (canEN && needs.EN > 0) { assigned = "EN"; needs.EN--; }
        else if (canD && needs.D > 0) { assigned = "D"; needs.D--; }
        else {
            // No need, but MUST WORK (since it's not the OFF day)
            // Pick any safe shift, prefer Night
            if(true) assigned = "LN"; // Always safe logic-wise
            else if(canEN) assigned = "EN";
            else if(canD) assigned = "D";
            else assigned = "OFF"; // Corner case, stuck
        }

        // Double check flip (Safety Net)
        if(isShiftFlipViolation(prev, assigned)) {
            // Try fallback
            if(!isShiftFlipViolation(prev, 'LN')) assigned = 'LN';
            else if(!isShiftFlipViolation(prev, 'EN')) assigned = 'EN';
            else assigned = 'OFF';
        }

        setShift(emp, d, assigned, sched, prevs, streaks);
    }

    function setShift(emp, d, s, sched, prevs, streaks) {
        sched[emp.id][d] = { shift: s, depot: "" };
        prevs[emp.id] = s;
        if(s === 'OFF' || s === 'X') streaks[emp.id] = 0; else streaks[emp.id]++;
    }

    function getExceptions(emp) {
        const e = emp.exceptions || {};
        return {
            offDates: (e.offDates||"").split(',').map(n=>parseInt(n)).filter(n=>!isNaN(n)),
            xDates: (e.xDates||"").split(',').map(n=>parseInt(n)).filter(n=>!isNaN(n))
        };
    }

    // --- DEPOT ---
    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        if(!sched || !confirm("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ØŸ")) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());

        for(let d=1; d<=numDays; d++) {
            state.employees.forEach(e => {
                if(sched[e.id][d] && ['D','EN','LN'].includes(sched[e.id][d].shift)) sched[e.id][d].depot = "";
            });
        }

        let empUsage = {}; state.employees.forEach(e => empUsage[e.id] = {});
        for(let d=1; d<=numDays; d++) {
            let counts = {}; cleanDepots.forEach(dep => counts[dep] = {D:0,EN:0,LN:0});
            let workers = {D:[], EN:[], LN:[]};
            state.employees.forEach(e => {
                let s = sched[e.id][d].shift;
                if(['D','EN','LN'].includes(s)) workers[s].push(e);
            });

            ['D','EN','LN'].forEach(s => {
                let list = workers[s];
                list.sort((a,b) => Math.random() - 0.5); 
                cleanDepots.forEach(dep => {
                    let r = reqs[dep] || reqs[dep.trim()];
                    let needed = r ? (r[s]||0) : 0;
                    let i = 0;
                    while(i < list.length && counts[dep][s] < needed) {
                        let e = list[i];
                        if(!sched[e.id][d].depot) {
                            sched[e.id][d].depot = dep;
                            counts[dep][s]++;
                        }
                        i++;
                    }
                });
                list.forEach(e => {
                    if(!sched[e.id][d].depot) {
                        let target = cleanDepots.reduce((a,b) => counts[a][s] < counts[b][s] ? a : b);
                        sched[e.id][d].depot = target;
                        counts[target][s]++;
                    }
                });
            });
        }
        renderSchedule(); saveData();
    }

    // --- UI HELPERS ---
    function updateDepots() { appConfig.depots = document.getElementById('settingDepots').value.split(',').map(s=>s.trim()).filter(s=>s); renderRequirementsTable(); }
    function renderRequirementsTable() {
        let html = `<table class="req-table"><thead><tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>D</th><th>EN</th><th>LN</th></tr></thead><tbody>`;
        appConfig.depots.forEach(d => {
            let r = (state.meta.requirements && state.meta.requirements[d]) || {D:0,EN:0,LN:0};
            html += `<tr><td>${d}</td>
            <td><input type="number" class="req-input" value="${r.D||0}" onchange="updReq('${d}','D',this.value)"></td>
            <td><input type="number" class="req-input" value="${r.EN||0}" onchange="updReq('${d}','EN',this.value)"></td>
            <td><input type="number" class="req-input" value="${r.LN||0}" onchange="updReq('${d}','LN',this.value)"></td></tr>`;
        });
        document.getElementById('requirementsContainer').innerHTML = html + `</tbody></table>`;
    }
    function updReq(d,s,v) { if(!state.meta.requirements) state.meta.requirements={}; if(!state.meta.requirements[d]) state.meta.requirements[d]={}; state.meta.requirements[d][s]=parseInt(v); }

    function renderEmployees() {
        const list = document.getElementById('employeeList'); list.innerHTML = "";
        state.employees.forEach(e => {
            let weekHtml = WEEKDAYS.map((day,i) => `<div><small>${day}</small><select onchange="updEmpWeek('${e.id}',${i},this.value)" style="width:100%">${SHIFTS.map(s=>`<option ${e.weeklyTemplate[i]===s?'selected':''}>${s}</option>`).join('')}</select></div>`).join('');
            
            let quotas = `<div class="depot-quotas">` + appConfig.depots.map(d => `<div><span>${d}</span><input type="number" style="width:40px" value="${(e.depotQuotas&&e.depotQuotas[d])||0}" onchange="updQuota('${e.id}','${d}',this.value)"></div>`).join('') + `</div>`;
            
            let flex = e.flexCounts || {D:1,EN:2,LN:2,OFF:2};
            let typeHtml = e.patternType === 'rolling' ? 
                `<div class="pattern-editor"><div class="flex-counts"><div>D <input type="number" style="width:40px" value="${flex.D}" onchange="updFlex('${e.id}','D',this.value)"></div><div>EN <input type="number" style="width:40px" value="${flex.EN}" onchange="updFlex('${e.id}','EN',this.value)"></div><div>LN <input type="number" style="width:40px" value="${flex.LN}" onchange="updFlex('${e.id}','LN',this.value)"></div><div>OFF <input type="number" style="width:40px" value="${flex.OFF}" onchange="updFlex('${e.id}','OFF',this.value)"></div></div></div>` :
                (e.patternType === 'joker' ? `<div class="pattern-editor">ğŸƒ Ø¬ÙˆÙƒØ± (Ø¥Ø¬Ø§Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹)</div>` : `<div class="pattern-editor" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px;">${weekHtml}</div>`);

            let div = document.createElement('div'); div.className = "emp-card";
            div.innerHTML = `<div class="emp-header"><input value="${e.name}" onchange="updEmp('${e.id}','name',this.value)" style="font-weight:bold"><select onchange="updEmp('${e.id}','patternType',this.value)"><option value="weekly" ${e.patternType==='weekly'?'selected':''}>Ø«Ø§Ø¨Øª</option><option value="rolling" ${e.patternType==='rolling'?'selected':''}>Ø¯ÙˆØ§Ø±</option><option value="joker" ${e.patternType==='joker'?'selected':''}>Ø¬ÙˆÙƒØ±</option></select><button class="danger" onclick="delEmp('${e.id}')">X</button></div>${quotas}${typeHtml}`;
            list.appendChild(div);
        });
    }
    
    // UI Helpers
    function updEmp(id,k,v){ state.employees.find(x=>x.id===id)[k]=v; if(k==='patternType') renderEmployees(); }
    function updEmpWeek(id,i,v){ state.employees.find(x=>x.id===id).weeklyTemplate[i]=v; }
    function updFlex(id,k,v){ let e=state.employees.find(x=>x.id===id); if(!e.flexCounts) e.flexCounts={}; e.flexCounts[k]=parseInt(v); }
    function updQuota(id,k,v){ let e=state.employees.find(x=>x.id===id); if(!e.depotQuotas) e.depotQuotas={}; e.depotQuotas[k]=parseInt(v); }
    function addEmployee(){ state.employees.push({id:'e'+Math.random(), name:'Ø¬Ø¯ÙŠØ¯', patternType:'weekly', weeklyTemplate:Array(7).fill('D'), flexCounts:{D:1,EN:2,LN:2,OFF:2}}); renderEmployees(); }
    function delEmp(id){ if(confirm('Ø­Ø°ÙØŸ')) state.employees=state.employees.filter(x=>x.id!==id); renderEmployees(); }
    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function getMonthKey() { return `${appConfig.year}-${appConfig.month}`; }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    function clearMonth() { if(confirm('Ù…Ø³Ø­ØŸ')) { state.schedule[getMonthKey()] = {}; renderSchedule(); saveData(); } }

    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = state.schedule[getMonthKey()] || {};
        let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
        for(let d=1; d<=numDays; d++) html += `<th>${d}<br>${WEEKDAYS[new Date(appConfig.year,appConfig.month-1,d).getDay()]}</th>`;
        html += `</tr></thead><tbody>`;
        
        state.employees.forEach(emp => {
            let prev = 'OFF';
            let row = `<tr><td class="emp-col">${emp.name}</td>`;
            for(let d=1; d<=numDays; d++) {
                let cell = (data[emp.id] && data[emp.id][d]) || {shift:''};
                let s = cell.shift || '';
                let violation = isShiftFlipViolation(prev, s) ? 'violation' : '';
                row += `<td class="cell shift-${s} ${violation}">${s}${cell.depot?`<span class="depot-tag">${cell.depot}</span>`:''}</td>`;
                prev = (s!=='OFF' && s!=='X' && s!=='') ? s : s;
            }
            html += row + `</tr>`;
        });
        grid.innerHTML = html + `</tbody>`;
        analyzeCoverage();
    }

    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = state.schedule[getMonthKey()] || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());
        const reqs = state.meta.requirements || {};
        let issues = [];
        let flips = 0;

        // Check Flips
        state.employees.forEach(emp => {
            let prev = 'OFF';
            for(let d=1; d<=numDays; d++) {
                let s = (sched[emp.id] && sched[emp.id][d]) ? sched[emp.id][d].shift : '';
                if(s) {
                    if(isShiftFlipViolation(prev, s)) {
                        flips++;
                        issues.push(`ğŸš¨ Ù‚Ù„Ø¨Ø© Ø´ÙØª: ${emp.name} ÙŠÙˆÙ… ${d} (${prev}->${s})`);
                    }
                    prev = s;
                }
            }
        });

        // Check Coverage
        for(let d=1; d<=numDays; d++) {
            let counts = {}; cleanDepots.forEach(dep => counts[dep] = {D:0,EN:0,LN:0});
            state.employees.forEach(e => {
                let c = (sched[e.id] && sched[e.id][d]);
                if(c && c.depot && c.shift && ['D','EN','LN'].includes(c.shift)) counts[c.depot.trim()][c.shift]++;
            });
            cleanDepots.forEach(dep => {
                let r = reqs[dep] || reqs[dep.trim()];
                if(r) {
                    ['D','EN','LN'].forEach(s => {
                        if(counts[dep][s] < (r[s]||0)) issues.push(`ÙŠÙˆÙ… ${d} ${dep} (${s}): Ù…Ø·Ù„ÙˆØ¨ ${r[s]}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${counts[dep][s]}`);
                    });
                }
            });
        }

        if(issues.length === 0) report.innerHTML = `<div class="report-ok">âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù…ØªØ§Ø² ÙˆØ®Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡!</div>`;
        else report.innerHTML = (flips>0 ? `<div class="alert" style="background:#fee2e2;color:#991b1b">âš ï¸ ÙŠÙˆØ¬Ø¯ ${flips} Ù‚Ù„Ø¨Ø© Ø´ÙØª!</div>` : '') + 
            issues.map(i => `<div class="report-item">${i}</div>`).join('');
    }

    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        let csv = "\uFEFFM,";
        for(let d=1; d<=numDays; d++) csv += d + ","; csv += "\n";
        let data = state.schedule[getMonthKey()] || {};
        state.employees.forEach(e => {
            csv += `"${e.name}",`;
            for(let d=1; d<=numDays; d++) {
                let c = (data[e.id] && data[e.id][d]) || {};
                csv += `"${c.shift || ''} ${c.depot||''}",`;
            }
            csv += "\n";
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'schedule.csv'; a.click();
    }
</script>
</body>
</html>
