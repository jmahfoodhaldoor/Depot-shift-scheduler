<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„</title>
    <style>
        :root { --primary: #2563eb; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #f8fafc; --border: #cbd5e1; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg); font-size: 14px; direction: rtl; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; align-items: center; }
        h1 { margin: 0; font-size: 1.3rem; margin-left: auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        button { cursor: pointer; padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 6px; font-weight: 600; transition: all 0.2s; font-family: inherit; }
        button:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.success { background: var(--success); color: white; border-color: var(--success); }
        button.danger { background: var(--danger); color: white; border-color: var(--danger); }
        input, select { padding: 8px; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; background: white; border-radius: 8px 8px 0 0; padding: 0 10px; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab:hover { background: #f8fafc; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }
        .view { display: none; }
        .view.active { display: block; }
        .grid-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .schedule-table { border-collapse: collapse; width: 100%; min-width: 1000px; }
        .schedule-table th, .schedule-table td { border: 1px solid #e2e8f0; text-align: center; padding: 6px; height: 38px; font-size: 0.85rem; }
        .schedule-table th { background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%); position: sticky; top: 0; z-index: 10; font-weight: 600; }
        .schedule-table th.emp-col { position: sticky; right: 0; z-index: 20; width: 160px; text-align: right; padding-right: 12px; border-left: 2px solid #cbd5e1; }
        .schedule-table td.emp-col { position: sticky; right: 0; z-index: 5; background: white; text-align: right; padding-right: 12px; font-weight: 600; border-left: 2px solid #cbd5e1; }
        .cell { cursor: pointer; user-select: none; transition: all 0.15s; font-weight: 500; }
        .cell:hover { transform: scale(1.05); box-shadow: inset 0 0 0 2px rgba(0,0,0,0.1); }
        
        .cell.shift-M { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; } 
        .cell.shift-A { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; } 
        .cell.shift-N { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: #f8fafc; } 
        .cell.shift-OFF { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; } 
        .cell.shift-VAC { background: linear-gradient(135deg, #fae8ff 0%, #f3e8ff 100%); color: #7e22ce; font-weight: 700; } 
        .cell.shift-X { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; font-weight: 700; } 
        
        .violation { border: 3px solid var(--danger) !important; animation: pulse 1s infinite; position: relative; }
        .violation::after { content: 'âš ï¸'; position: absolute; top: 1px; right: 2px; font-size: 0.7rem; }
        
        .emp-card { border: 1px solid var(--border); background: white; padding: 16px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .emp-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; margin-bottom: 12px; }
        .pattern-editor { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 12px; border-radius: 8px; border: 1px dashed var(--border); margin-top: 10px; }
        .flex-counts { display: flex; gap: 12px; flex-wrap: wrap; }
        .flex-counts > div { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .flex-counts label { font-size: 0.75rem; font-weight: 700; color: #64748b; }
        .flex-counts input { width: 50px; text-align: center; font-weight: 600; }
        .depot-quotas { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 10px; }
        .depot-quotas > div { background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); padding: 8px; border: 1px solid #fed7aa; border-radius: 6px; }
        .depot-quotas label { font-size: 0.75rem; font-weight: 700; color: #9a3412; display: block; margin-bottom: 4px; }
        .depot-quotas input { width: 100%; text-align: center; font-weight: 600; }
        .vacation-input { background: linear-gradient(135deg, #fae8ff 0%, #f3e8ff 100%); padding: 10px; border-radius: 6px; border: 1px solid #e9d5ff; margin-top: 10px; }
        .vacation-input input { width: 100%; padding: 6px; border: 1px solid #e9d5ff; border-radius: 4px; }

        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .report-box { margin-top: 20px; padding: 16px; background: white; border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .report-item { margin-bottom: 6px; padding: 8px 12px; background: #fff1f2; color: #9f1239; border-radius: 6px; border-left: 3px solid var(--danger); font-size: 0.9rem; }
        .report-ok { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; padding: 16px; text-align: center; font-weight: 700; border-radius: 8px; font-size: 1.1rem; }
        
        .alert-box { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid var(--warning); padding: 14px; border-radius: 8px; margin: 12px 0; color: #92400e; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .alert-box.success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-color: var(--success); color: #065f46; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
        .badge.success { background: var(--success); color: white; }
        .badge.warning { background: var(--warning); color: white; }
        .badge.danger { background: var(--danger); color: white; }
        .badge.info { background: #8b5cf6; color: white; }
        .stat-box { font-size: 0.7rem; color: #64748b; margin-top: 4px; }
        .depot-tag { font-size: 0.65rem; display: block; opacity: 0.7; margin-top: 2px; }
        .req-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .req-table th, .req-table td { border: 1px solid #e2e8f0; padding: 10px; text-align: center; }
        .req-table th { background: #f8fafc; font-weight: 600; }
        .req-input { width: 60px; text-align: center; font-weight: 600; }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-spinner"></div>
    <div style="margin-top: 20px; font-size: 1.1rem; font-weight: 600; color: var(--primary);">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø£ÙØ¶Ù„ ØªÙˆØ²ÙŠØ¹...</div>
</div>

<div class="app-container">
    <div class="toolbar">
        <h1>ğŸ—“ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„</h1>
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <button onclick="loadData()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸</button>
        <div style="flex-grow:1; text-align:left; font-size:0.8rem; color:#64748b;">
             <span id="lastUpdated"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
        <div class="tab" onclick="switchTab('employees')">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <div class="tab" onclick="switchTab('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <div id="view-schedule" class="view active">
        <div class="alert-box success">
            <div>
                <strong>âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯:</strong>
                <span class="badge success">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰: M (Ù†Ù‡Ø§Ø±) Ù„Ù„Ø¯ÙˆØ§Ø±</span>
                <span class="badge success">Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ§Ø³Ù„ (Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¹Ù…Ù„)</span>
                <span class="badge info">Ø§Ù„Ø¬ÙˆÙƒØ±: Ø¢Ø®Ø± Ø®ÙŠØ§Ø± Ù„Ù„Ù†Ù‡Ø§Ø±</span>
            </div>
        </div>
        <div class="toolbar" style="background:transparent; padding:0; box-shadow:none; justify-content:space-between;">
            <div>
                <button onclick="generateScheduleOptimized()" class="primary">âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª </button>
                <button onclick="fillDepots()" class="success">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
            </div>
            <div>
                <button onclick="clearMonth()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ù‡Ø±</button>
                <button onclick="exportCSV()">ğŸ“„ ØªØµØ¯ÙŠØ± Excel</button>
            </div>
        </div>
        <div class="grid-container">
            <table class="schedule-table" id="scheduleGrid"></table>
        </div>
        <div id="coverageReport" class="report-box"></div>
    </div>

    <div id="view-employees" class="view">
        <button class="primary" onclick="addEmployee()" style="margin-bottom: 15px;">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
        <div id="employeeList"></div>
    </div>

    <div id="view-settings" class="view">
        <div class="emp-card">
            <h3>1ï¸âƒ£ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
            <p style="font-size:0.85rem; color:#64748b; margin:8px 0;">Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨ÙØ§ØµÙ„Ø©</p>
            <input type="text" id="settingDepots" style="width: 100%;" onchange="updateDepots()">
        </div>
        <div class="emp-card">
            <h3>2ï¸âƒ£ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (M, A, N)</h3>
            <div id="requirementsContainer"></div>
        </div>
        <div class="emp-card">
            <h3>3ï¸âƒ£ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            <button class="danger" onclick="saveData(true)">âš ï¸ Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø¡</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // === CONFIGURATION ===
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // â¬…ï¸âš ï¸ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ù‡Ù†Ø§ âš ï¸
    
    // ==========================================
    // === STATE MANAGEMENT ===
    // ==========================================
    let state = { 
        employees: [], 
        schedule: {}, 
        meta: { requirements: {}, depots: [] } 
    };
    let appConfig = { 
        depots: ["Budaiya", "IsaTown"], 
        year: new Date().getFullYear(), 
        month: new Date().getMonth() + 1 
    };
    
    const SHIFTS = ["M", "A", "N", "OFF", "VAC", "X"];
    const WEEKDAYS = ["Ø£Ø­Ø¯", "Ø§Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"];
    const MAX_CONSECUTIVE_DAYS = 6;

    // ==========================================
    // === STRICT RULES ===
    // ==========================================
    function isShiftFlipViolation(previousShift, nextShift) {
        if (!previousShift || ['OFF', 'X', 'VAC'].includes(previousShift)) return false;
        if (nextShift === 'OFF' || nextShift === 'X' || nextShift === 'VAC') return false;
        
        // N -> M/A Forbidden
        if (previousShift === 'N') return (nextShift === 'M' || nextShift === 'A');
        
        // A -> M Forbidden
        if (previousShift === 'A') return (nextShift === 'M');
        
        return false;
    }

    // ==========================================
    // === INITIALIZATION & API ===
    // ==========================================
    window.onload = () => { initDateSelectors(); loadData(); };

    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const currYear = new Date().getFullYear();
        for(let y = currYear - 1; y <= currYear + 2; y++) ySel.add(new Option(y, y));
        ySel.value = currYear;
        const monthsAr = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        monthsAr.forEach((m, i) => mSel.add(new Option(m, i+1)));
        mSel.value = new Date().getMonth() + 1;
        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderSchedule(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderSchedule(); };
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${tabName}`).classList.add('active');
    }

    async function loadData() {
        showLoader(true);
        try {
            const res = await fetch(`${API_URL}?action=load`);
            const json = await res.json();
            if(json.ok) {
                const loadedState = json.data || {};
                state.employees = Array.isArray(loadedState.employees) ? loadedState.employees : [];
                state.schedule = loadedState.schedule || {};
                state.meta = loadedState.meta || { requirements: {}, depots: [] };
                
                if(state.meta.depots && state.meta.depots.length > 0) appConfig.depots = state.meta.depots;
                document.getElementById('settingDepots').value = appConfig.depots.join(', ');

                // Normalize Data
                state.employees.forEach(emp => {
                    if(!emp.id) emp.id = 'emp_' + Math.random().toString(36).substr(2, 9);
                    if(!emp.patternType) emp.patternType = 'weekly';
                    if(!emp.weeklyTemplate) emp.weeklyTemplate = Array(7).fill("M");
                    if(!emp.flexCounts) emp.flexCounts = { M: 1, A: 2, N: 2, OFF: 2 };
                    if(!emp.depotQuotas) emp.depotQuotas = {};
                    if(!emp.vacationDates) emp.vacationDates = "";
                });

                // Fix Requirements keys
                const reqs = state.meta.requirements;
                for(let d in reqs) {
                    if(reqs[d].D !== undefined) {
                        reqs[d].M = reqs[d].D; reqs[d].A = reqs[d].EN; reqs[d].N = reqs[d].LN;
                        delete reqs[d].D; delete reqs[d].EN; delete reqs[d].LN;
                    }
                }

                renderEmployees(); renderRequirementsTable(); renderSchedule();
                if(state.meta.updatedAt) document.getElementById('lastUpdated').innerText = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date(state.meta.updatedAt).toLocaleTimeString();
            } else { alert("Ø®Ø·Ø£: " + json.error); }
        } catch(e) { console.error(e); alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„."); } finally { showLoader(false); }
    }

    async function saveData(reset = false) {
        showLoader(true);
        if(reset) {
            if(!confirm("âš ï¸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!")) { showLoader(false); return; }
            state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } };
            appConfig.depots = ["Budaiya", "IsaTown"];
        }
        state.meta.depots = appConfig.depots;
        state.meta.updatedAt = new Date().toISOString();
        try {
            await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "save", payload: { employees: state.employees, schedule: state.schedule, meta: state.meta } }) });
            if(reset) { renderEmployees(); renderRequirementsTable(); renderSchedule(); document.getElementById('settingDepots').value = "Budaiya, IsaTown"; }
            document.getElementById('lastUpdated').innerText = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date().toLocaleTimeString();
        } catch(e) { alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸."); } finally { showLoader(false); }
    }

    // ==========================================
    // === UI RENDERING ===
    // ==========================================
    function renderRequirementsTable() {
        const container = document.getElementById('requirementsContainer');
        if(!container) return;
        if(!state.meta.requirements) state.meta.requirements = {};
        let html = `<table class="req-table"><thead><tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>M</th><th>A</th><th>N</th></tr></thead><tbody>`;
        appConfig.depots.forEach(depot => {
            const req = state.meta.requirements[depot] || { M:0, A:0, N:0 };
            html += `<tr><td style="font-weight:700;">${depot}</td>
                <td><input type="number" min="0" class="req-input" value="${req.M || 0}" onchange="updateReq('${depot}', 'M', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.A || 0}" onchange="updateReq('${depot}', 'A', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.N || 0}" onchange="updateReq('${depot}', 'N', this.value)"></td></tr>`;
        });
        container.innerHTML = html + `</tbody></table>`;
    }
    function updateReq(depot, shift, value) { if(!state.meta.requirements[depot]) state.meta.requirements[depot] = {}; state.meta.requirements[depot][shift] = parseInt(value) || 0; }

    function renderEmployees() {
        const container = document.getElementById('employeeList'); container.innerHTML = "";
        state.employees.forEach(emp => {
            const div = document.createElement('div'); div.className = "emp-card";
            let weekHtml = "<div style='display:grid; grid-template-columns:repeat(7,1fr); gap:6px;'>";
            WEEKDAYS.forEach((day, i) => {
                const opts = SHIFTS.filter(s => s !== 'VAC' && s !== 'X').map(s => `<option value="${s}" ${emp.weeklyTemplate[i] === s ? 'selected' : ''}>${s}</option>`).join('');
                weekHtml += `<div style="text-align:center;"><label style="font-size:0.7rem; color:#64748b;">${day}</label><select onchange="updateWeeklyTemplate('${emp.id}', ${i}, this.value)" style="width:100%; font-size:0.85rem;">${opts}</select></div>`;
            });
            weekHtml += "</div>";
            
            let quotasHtml = `<div class="depot-quotas">`;
            appConfig.depots.forEach(depot => {
                const val = (emp.depotQuotas && emp.depotQuotas[depot]) || 0;
                quotasHtml += `<div><label>${depot}</label><input type="number" min="0" value="${val}" onchange="updateDepotQuota('${emp.id}', '${depot}', this.value)"></div>`;
            });
            quotasHtml += `</div>`;
            
            let vacationHtml = `<div class="vacation-input"><label>ğŸ–ï¸ Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (Ù…Ø«Ø§Ù„: 5, 6)</label><input type="text" value="${emp.vacationDates || ''}" onchange="updateVacationDates('${emp.id}', this.value)"></div>`;
            const flex = emp.flexCounts || { M: 1, A: 2, N: 2, OFF: 2 };
            let patternHtml = "";
            
            if(emp.patternType === 'rolling') {
                patternHtml = `<div class="pattern-editor"><div class="flex-counts">
                        <div><label>M</label><input type="number" value="${flex.M}" onchange="updateFlexCount('${emp.id}', 'M', this.value)"></div>
                        <div><label>A</label><input type="number" value="${flex.A}" onchange="updateFlexCount('${emp.id}', 'A', this.value)"></div>
                        <div><label>N</label><input type="number" value="${flex.N}" onchange="updateFlexCount('${emp.id}', 'N', this.value)"></div>
                        <div><label>OFF</label><input type="number" value="${flex.OFF}" onchange="updateFlexCount('${emp.id}', 'OFF', this.value)"></div>
                    </div></div>`;
            } else if(emp.patternType === 'joker') {
                patternHtml = `<div class="pattern-editor"><div style="color:#d97706; font-weight:700;">ğŸƒ Ø¬ÙˆÙƒØ±</div><p style="font-size:0.8rem;">ÙŠØºØ·ÙŠ Ø§Ù„Ù†Ù‚Øµ. Ø¢Ø®Ø± Ø®ÙŠØ§Ø± Ù„Ù„Ù†Ù‡Ø§Ø±. 6 Ø¹Ù…Ù„ + 1 Ø±Ø§Ø­Ø©.</p></div>`;
            } else {
                patternHtml = `<div class="pattern-editor">${weekHtml}</div>`;
            }
            
            div.innerHTML = `<div class="emp-header"><input type="text" value="${emp.name}" onchange="updateEmployee('${emp.id}', 'name', this.value)" style="font-weight:700; flex:1; border:none;"><select onchange="updateEmployee('${emp.id}', 'patternType', this.value)" style="margin:0 10px;"><option value="weekly" ${emp.patternType === 'weekly' ? 'selected' : ''}>Ø«Ø§Ø¨Øª</option><option value="rolling" ${emp.patternType === 'rolling' ? 'selected' : ''}>Ø¯ÙˆØ§Ø±</option><option value="joker" ${emp.patternType === 'joker' ? 'selected' : ''}>Ø¬ÙˆÙƒØ±</option></select><button class="danger" onclick="deleteEmployee('${emp.id}')">ğŸ—‘ï¸</button></div>${vacationHtml}<div style="margin:10px 0;"><strong style="font-size:0.85rem; color:#64748b;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:</strong>${quotasHtml}</div>${patternHtml}`;
            container.appendChild(div);
        });
    }

    // --- HELPERS ---
    function addEmployee() { state.employees.push({ id: 'emp_'+Math.random().toString(36).substr(2,9), name: "Ø¬Ø¯ÙŠØ¯", patternType: "weekly", weeklyTemplate: Array(7).fill("M"), flexCounts: { M:1, A:2, N:2, OFF:2 }, depotQuotas: {}, vacationDates: "" }); renderEmployees(); }
    function updateEmployee(id, k, v) { const e = state.employees.find(x=>x.id===id); if(e){e[k]=v; if(k==='patternType') renderEmployees();} }
    function updateWeeklyTemplate(id, i, v) { const e = state.employees.find(x=>x.id===id); if(e) e.weeklyTemplate[i]=v; }
    function updateFlexCount(id, s, v) { const e = state.employees.find(x=>x.id===id); if(e){if(!e.flexCounts) e.flexCounts={}; e.flexCounts[s]=parseInt(v)||0;} }
    function updateDepotQuota(id, d, v) { const e = state.employees.find(x=>x.id===id); if(e){if(!e.depotQuotas) e.depotQuotas={}; e.depotQuotas[d]=parseInt(v)||0;} }
    function updateVacationDates(id, v) { const e = state.employees.find(x=>x.id===id); if(e) e.vacationDates=v; }
    function deleteEmployee(id) { if(confirm('Ø­Ø°ÙØŸ')) { state.employees=state.employees.filter(x=>x.id!==id); renderEmployees(); renderSchedule(); saveData(); } }
    function updateDepots() { appConfig.depots = document.getElementById('settingDepots').value.split(',').map(s=>s.trim()).filter(s=>s); renderRequirementsTable(); renderEmployees(); }

    // ==========================================
    // === OPTIMIZED GENERATOR (MORNING FORCE) ===
    // ==========================================
    function generateScheduleOptimized() {
        if(!confirm("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹ØŸ\n\nâœ… Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø± Ù„Ù„Ø¯ÙˆØ§Ø±\nâœ… Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ§Ø³Ù„ (Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø¹Ù…Ù„)\nâœ… ØªÙˆØ²ÙŠØ¹ Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø¬ÙˆÙƒØ±")) return;
        showLoader(true);
        setTimeout(() => {
            try {
                const key = getMonthKey();
                const numDays = daysInMonth(appConfig.year, appConfig.month);
                if(!state.schedule[key]) state.schedule[key] = {};
                const sched = state.schedule[key];
                
                state.employees.forEach(e => { if(!sched[e.id]) sched[e.id] = {}; });
                
                // 0. Apply Vacations
                applyVacations(numDays, sched);
                
                // 1. Calculate Needs
                const dailyNeeds = calculateDailyNeeds(numDays);
                const workStreaks = {};
                const empPrevShift = {};
                state.employees.forEach(emp => { workStreaks[emp.id] = 0; empPrevShift[emp.id] = 'OFF'; });

                // 2. Fixed Employees
                applyFixedEmployees(numDays, sched, dailyNeeds, workStreaks, empPrevShift);

                // 3. Rolling & Joker Loop
                const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
                const jokerEmps = state.employees.filter(e => e.patternType === 'joker');

                // Joker Staggering Logic (Distributed OFFs)
                const jokerOffMap = {};
                jokerEmps.forEach((e, idx) => {
                    jokerOffMap[e.id] = [];
                    let base = (idx % 7) + 1;
                    for(let x=base; x<=numDays; x+=7) jokerOffMap[e.id].push(x);
                });

                let currentDay = 1;
                while(currentDay <= numDays) {
                    // Determine Week
                    let weekEnd = Math.min(currentDay + 6 - new Date(appConfig.year, appConfig.month-1, currentDay).getDay(), numDays);
                    let daysInWeek = [];
                    for(let i=currentDay; i<=weekEnd; i++) daysInWeek.push(i);

                    // Reset Buckets on Week Start
                    if(new Date(appConfig.year, appConfig.month-1, currentDay).getDay() === 0 || currentDay === 1) {
                        rollingEmps.forEach(e => {
                            let f = e.flexCounts || {M:1,A:2,N:2,OFF:2};
                            e._bucket = { ...f };
                            // Calculate total work capacity for the week
                            e._totalWorkNeeded = f.M + f.A + f.N;
                            e._daysWorkedThisWeek = 0;
                        });
                    }

                    daysInWeek.forEach(d => {
                        let todaysNeeds = dailyNeeds[d];
                        let rollingList = [...rollingEmps].sort(() => Math.random() - 0.5);
                        let jokerList = [...jokerEmps].sort(() => Math.random() - 0.5);

                        // --- STEP 1: FORCE MORNING (Rolling) ---
                        // If M needed, grab Rolling emps who are safe
                        if(todaysNeeds.M > 0) {
                            rollingList.forEach(emp => {
                                if(todaysNeeds.M <= 0) return;
                                if(isAssigned(emp, d, sched)) return;
                                
                                let prev = empPrevShift[emp.id];
                                if(!isShiftFlipViolation(prev, 'M')) {
                                    assignShift(emp, d, 'M', sched, todaysNeeds, workStreaks, empPrevShift);
                                    if(emp._bucket.M > 0) emp._bucket.M--; // Reduce preferred M
                                    else if(emp._bucket.A > 0) emp._bucket.A--; // Steal from A
                                    else if(emp._bucket.N > 0) emp._bucket.N--; // Steal from N
                                    emp._daysWorkedThisWeek++;
                                }
                            });
                        }

                        // --- STEP 2: FILL A/N (Rolling) ---
                        rollingList.forEach(emp => {
                            if(isAssigned(emp, d, sched)) return;
                            
                            // Anti-Slacking Check
                            let daysLeftInWeek = (daysInWeek[daysInWeek.length-1] - d) + 1;
                            let workLeft = emp._totalWorkNeeded - emp._daysWorkedThisWeek;
                            let mustWork = (workLeft >= daysLeftInWeek); // Must work today to finish quota

                            let prev = empPrevShift[emp.id];
                            let bucket = emp._bucket;
                            let assigned = 'OFF';

                            // Determine safe options
                            let canA = !isShiftFlipViolation(prev, 'A');
                            let canN = !isShiftFlipViolation(prev, 'N');
                            let canM = !isShiftFlipViolation(prev, 'M'); // Last resort

                            if(mustWork) {
                                // Forced Mode
                                if(canN && (todaysNeeds.N > 0 || bucket.N > 0)) assigned = 'N';
                                else if(canA && (todaysNeeds.A > 0 || bucket.A > 0)) assigned = 'A';
                                else if(canM) assigned = 'M';
                                else if(canN) assigned = 'N'; // Force N if nothing else
                                else assigned = 'OFF'; // Physical flip violation
                            } else {
                                // Normal Mode (Needs based)
                                if(todaysNeeds.N > 0 && canN && bucket.N > 0) { assigned='N'; bucket.N--; }
                                else if(todaysNeeds.A > 0 && canA && bucket.A > 0) { assigned='A'; bucket.A--; }
                                else if(bucket.OFF > 0) { assigned='OFF'; bucket.OFF--; } // Take OFF if available
                                else {
                                    // Empty bucket fill
                                    if(canN) assigned='N'; else if(canA) assigned='A';
                                }
                            }

                            if(assigned !== 'OFF') {
                                assignShift(emp, d, assigned, sched, todaysNeeds, workStreaks, empPrevShift);
                                emp._daysWorkedThisWeek++;
                            } else {
                                setOff(emp, d, sched, workStreaks, empPrevShift);
                            }
                        });

                        // --- STEP 3: JOKER (Cleanup) ---
                        jokerList.forEach(emp => {
                            if(isAssigned(emp, d, sched)) return;
                            
                            let prev = empPrevShift[emp.id];
                            let assigned = 'OFF';
                            let isOffDay = jokerOffMap[emp.id].includes(d);

                            if(isOffDay) {
                                assigned = 'OFF';
                            } else {
                                // Priority N -> A -> M
                                if(todaysNeeds.N > 0 && !isShiftFlipViolation(prev, 'N')) assigned = 'N';
                                else if(todaysNeeds.A > 0 && !isShiftFlipViolation(prev, 'A')) assigned = 'A';
                                else if(todaysNeeds.M > 0 && !isShiftFlipViolation(prev, 'M')) assigned = 'M';
                                else {
                                    // No need, but must work (6 days rule)
                                    // Fill any safe slot (Prefer N)
                                    if(!isShiftFlipViolation(prev, 'N')) assigned = 'N';
                                    else if(!isShiftFlipViolation(prev, 'A')) assigned = 'A';
                                    else if(!isShiftFlipViolation(prev, 'M')) assigned = 'M';
                                }
                            }
                            
                            if(assigned !== 'OFF') assignShift(emp, d, assigned, sched, todaysNeeds, workStreaks, empPrevShift);
                            else setOff(emp, d, sched, workStreaks, empPrevShift);
                        });
                    });

                    currentDay = daysInWeek[daysInWeek.length-1] + 1;
                }

                renderSchedule(); saveData(); showLoader(false);
                alert("âœ… ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
            } catch(e) { console.error(e); showLoader(false); alert("Ø®Ø·Ø£: " + e.message); }
        }, 100);
    }

    function isAssigned(emp, d, sched) { return !!(sched[emp.id] && sched[emp.id][d]); }

    function assignShift(emp, d, s, sched, needs, streaks, prevs) {
        sched[emp.id][d] = { shift: s, depot: "" };
        prevs[emp.id] = s;
        if(needs[s] > 0) needs[s]--;
        streaks[emp.id]++;
    }

    function setOff(emp, d, sched, streaks, prevs) {
        sched[emp.id][d] = { shift: 'OFF', depot: "" };
        prevs[emp.id] = 'OFF';
        streaks[emp.id] = 0;
    }

    function applyVacations(numDays, sched) {
        state.employees.forEach(emp => {
            if(emp.vacationDates) {
                emp.vacationDates.split(',').map(d=>parseInt(d.trim())).filter(d=>!isNaN(d)).forEach(d => {
                    if(d<=numDays) sched[emp.id][d] = { shift: 'VAC', depot: '' };
                });
            }
        });
    }

    function calculateDailyNeeds(numDays) {
        const needs = {};
        const depots = appConfig.depots.map(d=>d.trim());
        const reqs = state.meta.requirements || {};
        for(let d=1; d<=numDays; d++) {
            needs[d] = { M:0, A:0, N:0 };
            depots.forEach(dep => {
                const r = reqs[dep] || {};
                needs[d].M += (r.M||0); needs[d].A += (r.A||0); needs[d].N += (r.N||0);
            });
        }
        return needs;
    }

    function applyFixedEmployees(numDays, sched, dailyNeeds, streaks, prevs) {
        state.employees.filter(e => e.patternType === 'weekly').forEach(emp => {
            for(let d=1; d<=numDays; d++) {
                if(isAssigned(emp, d, sched)) { // Vacation handling
                    prevs[emp.id] = 'VAC'; streaks[emp.id] = 0; continue;
                }
                const dayOfWeek = new Date(appConfig.year, appConfig.month-1, d).getDay();
                let shift = emp.weeklyTemplate[dayOfWeek];
                const prev = prevs[emp.id];
                
                if(isShiftFlipViolation(prev, shift)) shift = 'OFF';
                
                if(shift !== 'OFF') assignShift(emp, d, shift, sched, dailyNeeds, streaks, prevs);
                else setOff(emp, d, sched, streaks, prevs);
            }
        });
    }

    // --- DEPOT FILL ---
    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        if(!sched || !confirm("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ØŸ")) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const depots = appConfig.depots.map(d=>d.trim());

        for(let d=1; d<=numDays; d++) {
            state.employees.forEach(e => { if(sched[e.id][d] && ['M','A','N'].includes(sched[e.id][d].shift)) sched[e.id][d].depot = ""; });
        }

        const usage = {}; state.employees.forEach(e=>usage[e.id]={});

        for(let d=1; d<=numDays; d++) {
            const counts = {}; depots.forEach(dp=>counts[dp]={M:0,A:0,N:0});
            const workers = {M:[],A:[],N:[]};
            state.employees.forEach(e => {
                let s = sched[e.id][d].shift;
                if(['M','A','N'].includes(s)) workers[s].push(e);
            });

            ['M','A','N'].forEach(s => {
                let list = workers[s];
                list.sort((a,b) => ((b.depotQuotas[depots[0]]||0) - (a.depotQuotas[depots[0]]||0))); 
                depots.forEach(dep => {
                    let need = (reqs[dep]||{})[s] || 0;
                    let i = 0;
                    while(i<list.length && counts[dep][s] < need) {
                        let e = list[i];
                        if(!sched[e.id][d].depot) {
                            sched[e.id][d].depot = dep;
                            counts[dep][s]++;
                        }
                        i++;
                    }
                });
                list.forEach(e => {
                    if(!sched[e.id][d].depot) {
                        let target = depots.reduce((a,b)=>counts[a][s]<counts[b][s]?a:b);
                        sched[e.id][d].depot = target;
                        counts[target][s]++;
                    }
                });
            });
        }
        renderSchedule(); saveData();
    }

    // --- RENDER & EXPORT ---
    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        if(!grid) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = state.schedule[getMonthKey()] || {};
        let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
        for(let d=1; d<=numDays; d++) {
            const date = new Date(appConfig.year, appConfig.month-1, d);
            const isWeekend = (date.getDay()===5 || date.getDay()===6);
            html += `<th style="${isWeekend?'background:#e2e8f0':''}">${d}<br>${WEEKDAYS[date.getDay()]}</th>`;
        }
        html += `</tr></thead><tbody>`;
        state.employees.forEach(e => {
            let row = `<tr><td class="emp-col">${e.name}</td>`;
            let prev='OFF';
            for(let d=1; d<=numDays; d++) {
                let c = (data[e.id] && data[e.id][d]) || {shift:''};
                let s = c.shift||'';
                let v = isShiftFlipViolation(prev, s) ? 'violation' : '';
                row += `<td class="cell shift-${s} ${v}">${s}${c.depot?`<span class="depot-tag">${c.depot}</span>`:''}</td>`;
                if(['M','A','N','VAC','X'].includes(s)) prev=s; else prev='OFF';
            }
            html += row + `</tr>`;
        });
        grid.innerHTML = html + `</tbody>`;
        analyzeCoverage();
    }

    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        if(!report) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = state.schedule[getMonthKey()] || {};
        const depots = appConfig.depots.map(d=>d.trim());
        const reqs = state.meta.requirements || {};
        let issues = [];
        let flips = 0;

        state.employees.forEach(emp => {
            let prev = 'OFF';
            for(let d=1; d<=numDays; d++) {
                let s = (sched[emp.id] && sched[emp.id][d]) ? sched[emp.id][d].shift : '';
                if(s) {
                    if(isShiftFlipViolation(prev, s)) {
                        flips++;
                        issues.push(`ğŸš¨ Ù‚Ù„Ø¨Ø© Ø´ÙØª: ${emp.name} ÙŠÙˆÙ… ${d} (${prev}->${s})`);
                    }
                    if(['M','A','N','VAC','X'].includes(s)) prev=s; else prev='OFF';
                }
            }
        });

        for(let d=1; d<=numDays; d++) {
            let counts = {}; depots.forEach(dp=>counts[dp]={M:0,A:0,N:0});
            state.employees.forEach(e => {
                let c = sched[e.id] && sched[e.id][d];
                if(c && c.depot && ['M','A','N'].includes(c.shift)) counts[c.depot.trim()][c.shift]++;
            });
            depots.forEach(dep => {
                let r = reqs[dep] || {};
                ['M','A','N'].forEach(s => {
                    let req = r[s]||0;
                    let act = counts[dep][s]||0;
                    if(act < req) issues.push(`ÙŠÙˆÙ… ${d} ${dep} (${s}): Ù…Ø·Ù„ÙˆØ¨ ${req}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${act}`);
                });
            });
        }

        let html = "";
        if(flips > 0) html += `<div class="alert-box danger">âš ï¸ ÙŠÙˆØ¬Ø¯ ${flips} Ù‚Ù„Ø¨Ø© Ø´ÙØª!</div>`;
        if(issues.length === 0) html += `<div class="report-ok">âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù…ØªØ§Ø²!</div>`;
        else html += issues.map(i=>`<div class="report-item">${i}</div>`).join('');
        report.innerHTML = html;
    }

    // UTILS
    function getMonthKey() { return `${appConfig.year}-${appConfig.month}`; }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    function clearMonth() { if(confirm('Ù…Ø³Ø­ØŸ')) { state.schedule[getMonthKey()] = {}; renderSchedule(); saveData(); } }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        let csv = "\uFEFFM,";
        for(let d=1; d<=numDays; d++) csv += `${d},`; csv += "\n";
        let data = state.schedule[getMonthKey()] || {};
        state.employees.forEach(e => {
            csv += `"${e.name}",`;
            for(let d=1; d<=numDays; d++) {
                let c = (data[e.id] && data[e.id][d]) || {};
                csv += `"${c.shift||''} ${c.depot||''}",`;
            }
            csv += "\n";
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'schedule.csv'; a.click();
    }
</script>
</body>
</html>
