<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // <--- ضع رابط Google Web App هنا
    
    // --- STATE ---
    let state = {
        employees: [],
        schedule: {}, 
        meta: { requirements: {} } 
    };
    
    let appConfig = {
        depots: ["Main", "North"],
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1 
    };

    const SHIFTS = ["D", "EN", "LN", "OFF", "X"];
    const WEEKDAYS = ["أحد", "اثنين", "ثلاثاء", "أربعاء", "خميس", "جمعة", "سبت"];

    // --- INITIALIZATION ---
    window.onload = () => {
        initDateSelectors();
        loadData();
    };

    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const currYear = new Date().getFullYear();
        
        for(let y = currYear - 1; y <= currYear + 2; y++) {
            ySel.add(new Option(y, y));
        }
        ySel.value = currYear;

        const monthsAr = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
        monthsAr.forEach((m, i) => {
            mSel.add(new Option(m, i+1));
        });
        mSel.value = new Date().getMonth() + 1;

        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderSchedule(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderSchedule(); };
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${tabName}`).classList.add('active');
    }

    // --- API CALLS ---
    async function loadData() {
        showLoader(true);
        try {
            const res = await fetch(`${API_URL}?action=load`);
            const json = await res.json();
            if (json.ok) {
                state = json.data;
                
                // استرجاع الإعدادات
                if (state.meta && state.meta.depots && state.meta.depots.length > 0) {
                    appConfig.depots = state.meta.depots;
                } else {
                    appConfig.depots = ["Budaiya", "IsaTown"]; 
                }

                if (!state.meta) state.meta = {};
                if (!state.meta.requirements) state.meta.requirements = {};

                document.getElementById('settingDepots').value = appConfig.depots.join(', ');
                
                state.employees.forEach(emp => {
                    if(!emp.patternType) emp.patternType = 'weekly';
                    if(!emp.rollingPattern) emp.rollingPattern = "D,D,EN,EN,LN,LN,OFF,OFF"; 
                });

                renderEmployees();
                renderRequirementsTable();
                renderSchedule();
                updateLastUpdated();
            } else {
                alert("خطأ في التحميل: " + json.error);
            }
        } catch (e) {
            console.error(e);
            alert("فشل الاتصال. تأكد من الإنترنت.");
        } finally {
            showLoader(false);
        }
    }

    async function saveData(reset = false) {
        showLoader(true);
        if(reset) {
            if(!confirm("تحذير: سيتم مسح قاعدة البيانات بالكامل! هل أنت متأكد؟")) { showLoader(false); return; }
            state.employees = [];
            state.schedule = {};
            state.meta = { requirements: {}, depots: [] };
        }

        state.meta.depots = appConfig.depots; 

        try {
            const payload = { action: "save", payload: { employees: state.employees, schedule: state.schedule, meta: state.meta } };
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (json.ok) {
                state.meta.updatedAt = json.meta.updatedAt;
                updateLastUpdated();
                // لا نحدث الجدول هنا لتجنب وميض الشاشة، التحديث محلي كافٍ
            } else {
                alert("فشل الحفظ: " + json.error);
            }
        } catch (e) {
            console.error(e);
            alert("خطأ أثناء الحفظ.");
        } finally {
            showLoader(false);
        }
    }

    function updateLastUpdated() {
        if(state.meta.updatedAt) {
            const date = new Date(state.meta.updatedAt);
            document.getElementById('lastUpdated').innerText = "آخر مزامنة: " + date.toLocaleTimeString();
        }
    }

    // --- UI RENDERING ---
    function renderRequirementsTable() {
        const container = document.getElementById('requirementsContainer');
        let html = `<table class="req-table"><thead><tr><th>الموقع</th><th>نهار (D)</th><th>أول ليل (EN)</th><th>آخر ليل (LN)</th></tr></thead><tbody>`;
        
        appConfig.depots.forEach(depot => {
            const req = state.meta.requirements[depot] || { D:0, EN:0, LN:0 };
            html += `<tr>
                <td style="font-weight:bold;">${depot}</td>
                <td><input type="number" min="0" class="req-input" value="${req.D || 0}" onchange="updateReq('${depot}', 'D', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.EN || 0}" onchange="updateReq('${depot}', 'EN', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.LN || 0}" onchange="updateReq('${depot}', 'LN', this.value)"></td>
            </tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function updateReq(depot, shift, val) {
        if(!state.meta.requirements) state.meta.requirements = {};
        if(!state.meta.requirements[depot]) state.meta.requirements[depot] = {};
        state.meta.requirements[depot][shift] = parseInt(val) || 0;
    }

    function renderEmployees() {
        const container = document.getElementById('employeeList');
        container.innerHTML = "";
        
        state.employees.forEach(emp => {
            const div = document.createElement('div');
            div.className = "emp-card";
            
            let weekHtml = "";
            WEEKDAYS.forEach((day, i) => {
                const opts = SHIFTS.map(s => `<option value="${s}" ${emp.weeklyTemplate[i] === s ? 'selected' : ''}>${s}</option>`).join('');
                weekHtml += `
                    <div style="text-align:center;">
                        <label style="font-size:0.7rem; color:#666;">${day}</label>
                        <select onchange="updateWeeklyTemplate('${emp.id}', ${i}, this.value)" style="width:100%">${opts}</select>
                    </div>`;
            });

            let patternEditorHtml = "";
            if(emp.patternType === 'rolling') {
                patternEditorHtml = `
                    <div class="pattern-editor">
                        <div class="note" style="color:#2563eb; font-weight:bold;"> وضع "الجوكر" (تغطية النقص):</div>
                        <div class="note">سيقوم النظام بتجاهل النمط الثابت لهذا الموظف واستخدامه لسد النقص في الجدول (نهار، أول ليل، آخر ليل) حسب الحاجة اليومية.</div>
                    </div>
                `;
            } else {
                patternEditorHtml = `
                    <div class="pattern-editor">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">الأيام الأسبوعية الثابتة:</label>
                        <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:5px;">${weekHtml}</div>
                    </div>
                `;
            }

            const exc = emp.exceptions || { offDates:"", xDates:"" };

            div.innerHTML = `
                <div class="emp-header">
                    <input type="text" value="${emp.name}" onchange="updateEmployee('${emp.id}', 'name', this.value)" style="font-weight:bold; font-size:1.1rem;">
                    <select onchange="updateEmployee('${emp.id}', 'patternType', this.value)" style="font-size:0.9rem;">
                        <option value="weekly" ${emp.patternType === 'weekly' ? 'selected' : ''}>أيام أسبوعية ثابتة</option>
                        <option value="rolling" ${emp.patternType === 'rolling' ? 'selected' : ''}>شفت دوار (تغطية النقص)</option>
                    </select>
                    <button class="danger" onclick="deleteEmployee('${emp.id}')">حذف</button>
                </div>
                ${patternEditorHtml}
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <div>
                        <label style="font-size:0.75rem">إجبار إجازة (تواريخ):</label>
                        <input type="text" style="width:95%" value="${exc.offDates || ''}" placeholder="مثال: 5, 12, 20" onchange="updateExceptions('${emp.id}', 'offDates', this.value)">
                    </div>
                    <div>
                        <label style="font-size:0.75rem">إجبار غياب (تواريخ):</label>
                        <input type="text" style="width:95%" value="${exc.xDates || ''}" placeholder="مثال: 15" onchange="updateExceptions('${emp.id}', 'xDates', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function addEmployee() {
        const id = "emp_" + Math.random().toString(36).substr(2, 9);
        state.employees.push({
            id: id,
            name: "موظف جديد",
            patternType: "weekly", 
            weeklyTemplate: ["OFF", "D", "D", "D", "D", "D", "OFF"], 
            rollingPattern: "D,D,EN,EN,LN,LN,OFF,OFF", 
            exceptions: { offDates: "", xDates: "" }
        });
        renderEmployees();
    }

    function updateEmployee(id, field, value) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) {
            emp[field] = value;
            if(field === 'name' || field === 'patternType') renderEmployees(); 
        }
    }

    function updateWeeklyTemplate(id, dayIndex, val) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) emp.weeklyTemplate[dayIndex] = val;
    }

    function updateExceptions(id, type, val) {
         const emp = state.employees.find(e => e.id === id);
         if(emp) {
             if(!emp.exceptions) emp.exceptions = { offDates:"", xDates:"" };
             emp.exceptions[type] = val;
         }
    }

    function deleteEmployee(id) {
        if(!confirm("حذف الموظف؟")) return;
        state.employees = state.employees.filter(e => e.id !== id);
        renderEmployees();
        renderSchedule();
        saveData(); 
    }

    // --- SCHEDULE LOGIC ---
    function getMonthKey() { return `${appConfig.year}-${appConfig.month}`; }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    
    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = (state.schedule[getMonthKey()] || {});
        
        let html = `<thead><tr><th class="emp-col">الموظف</th>`;
        for(let d=1; d<=numDays; d++) {
            const date = new Date(appConfig.year, appConfig.month - 1, d);
            const dayName = WEEKDAYS[date.getDay()];
            const isWeekend = (date.getDay() === 5 || date.getDay() === 6); 
            html += `<th style="${isWeekend ? 'background:#e2e8f0' : ''}">${d}<br>${dayName}</th>`;
        }
        html += `</tr></thead><tbody>`;

        state.employees.forEach(emp => {
            const empData = data[emp.id] || {};
            let counts = { D:0, EN:0, LN:0, OFF:0, X:0 };
            
            let rowHtml = `<tr><td class="emp-col">
                <div>${emp.name}</div>
                <div class="stat-box" id="stats-${emp.id}"></div>
            </td>`;
            
            let prevShift = null;

            for(let d=1; d<=numDays; d++) {
                const cellData = empData[d] || { shift: "" };
                const shift = cellData.shift || "";
                const depot = cellData.depot || "";
                
                if(counts[shift] !== undefined) counts[shift]++;

                let violation = "";
                if (prevShift === 'LN' && shift === 'D') violation = "violation";
                if (prevShift === 'LN' && shift === 'EN') violation = "violation";
                
                if(shift !== 'OFF' && shift !== 'X' && shift !== '') prevShift = shift;
                if(shift === 'OFF' || shift === 'X') prevShift = 'OFF'; 

                const display = (shift === "OFF" || shift === "X") ? shift : (shift ? `${shift}<span class="depot-tag">${depot}</span>` : "");
                
                rowHtml += `<td class="cell shift-${shift} ${violation}" onclick="cycleCell('${emp.id}', ${d})">${display}</td>`;
            }
            rowHtml += `</tr>`;
            html += rowHtml;

            setTimeout(() => {
                const el = document.getElementById(`stats-${emp.id}`);
                if(el) el.innerText = `D:${counts.D} EN:${counts.EN} LN:${counts.LN}`;
            }, 0);
        });

        html += `</tbody>`;
        grid.innerHTML = html;
        analyzeCoverage();
    }

    function cycleCell(empId, day) {
        const key = getMonthKey();
        if(!state.schedule[key]) state.schedule[key] = {};
        if(!state.schedule[key][empId]) state.schedule[key][empId] = {};
        
        const current = state.schedule[key][empId][day] || { shift: "" };
        let idx = SHIFTS.indexOf(current.shift);
        
        if (idx === -1) idx = 0; 
        else idx++; 
        
        let newShift = "";
        let newDepot = "";

        if (idx < SHIFTS.length) {
            newShift = SHIFTS[idx];
            if(["D","EN","LN"].includes(newShift)) {
                newDepot = current.depot || appConfig.depots[0];
            }
        } else {
            newShift = ""; 
        }

        state.schedule[key][empId][day] = { shift: newShift, depot: newDepot };
        renderSchedule();
        saveData();
    }

    // --- NEW: COVERAGE-FIRST GENERATOR ---
    function generateSchedule() {
        if(!confirm("سيقوم النظام الآن بتوزيع 'الشفتات الدوارة' لسد النقص في الجدول تماماً (سيتجاهل الترتيب المعتاد).\nهل تريد الاستمرار؟")) return;
        
        const key = getMonthKey();
        if(!state.schedule[key]) state.schedule[key] = {};
        const sched = state.schedule[key];
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());

        // 1. حساب إجمالي المطلوب يومياً (Inventory)
        let dailyNeeds = {}; // { 1: {D:4, EN:2, LN:2}, ... }
        
        for(let d=1; d<=numDays; d++) {
            dailyNeeds[d] = { D:0, EN:0, LN:0 };
            cleanDepots.forEach(dep => {
                let r = reqs[dep] || reqs[dep.trim()];
                if(r) {
                    dailyNeeds[d].D += (r.D || 0);
                    dailyNeeds[d].EN += (r.EN || 0);
                    dailyNeeds[d].LN += (r.LN || 0);
                }
            });
        }

        // 2. تطبيق الموظفين الثابتين (Weekly) وخصمهم من الاحتياج
        state.employees.forEach(emp => {
            if(!sched[emp.id]) sched[emp.id] = {};
            
            if (emp.patternType !== 'rolling') {
                const exc = emp.exceptions || {};
                const offDates = (exc.offDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                const xDates = (exc.xDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));

                for(let d=1; d<=numDays; d++) {
                    let shift = sched[emp.id][d] ? sched[emp.id][d].shift : "";
                    if (shift === "") {
                        const date = new Date(appConfig.year, appConfig.month - 1, d);
                        shift = emp.weeklyTemplate[date.getDay()];
                        if (xDates.includes(d)) shift = "X";
                        else if (offDates.includes(d)) shift = "OFF";
                        
                        sched[emp.id][d] = { shift: shift, depot: "" };
                    }
                    
                    // خصم من الاحتياج
                    if (["D","EN","LN"].includes(shift)) {
                        if(dailyNeeds[d][shift] > 0) dailyNeeds[d][shift]--;
                    }
                }
            } else {
                // تصفير جدول الدوارين بالكامل
                for(let d=1; d<=numDays; d++) {
                     sched[emp.id][d] = { shift: "", depot: "" };
                }
            }
        });

        // 3. توزيع الموظفين الدوارين (Rolling) يوماً بيوم لسد النقص
        const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
        
        // تتبع حالة الموظفين (ماذا عملوا بالأمس؟)
        let empStatus = {}; 
        rollingEmps.forEach(e => empStatus[e.id] = "OFF"); // البداية

        for(let d=1; d<=numDays; d++) {
            // خلط الموظفين عشوائياً كل يوم للعدالة في التوزيع
            let availableWorkers = [...rollingEmps].sort(() => Math.random() - 0.5);
            
            // قائمة الاحتياجات المتبقية لهذا اليوم
            let needs = dailyNeeds[d]; // {D: x, EN: y, LN: z}

            availableWorkers.forEach(emp => {
                // التحقق من الاستثناءات
                const exc = emp.exceptions || {};
                const offDates = (exc.offDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                const xDates = (exc.xDates || "").split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));

                if (xDates.includes(d)) {
                    sched[emp.id][d] = { shift: "X", depot: "" };
                    empStatus[emp.id] = "X";
                    return;
                }
                if (offDates.includes(d)) {
                    sched[emp.id][d] = { shift: "OFF", depot: "" };
                    empStatus[emp.id] = "OFF";
                    return;
                }

                // تحديد الشفت المناسب (Greedy Allocation)
                let prevShift = empStatus[emp.id];
                let assignedShift = "OFF";

                // قاعدة صارمة: إذا كان أمس LN، اليوم إما OFF أو LN (ممنوع D أو EN)
                let canWorkMorning = (prevShift !== "LN");
                
                if (needs.D > 0 && canWorkMorning) {
                    assignedShift = "D";
                    needs.D--;
                } else if (needs.EN > 0 && canWorkMorning) {
                    assignedShift = "EN";
                    needs.EN--;
                } else if (needs.LN > 0) {
                    // الـ LN مسموح للجميع
                    assignedShift = "LN";
                    needs.LN--;
                } else {
                    // لا يوجد احتياج، أو الموظف لا يمكنه العمل (بسبب قاعدة LN)
                    assignedShift = "OFF";
                }

                sched[emp.id][d] = { shift: assignedShift, depot: "" };
                empStatus[emp.id] = assignedShift;
            });
        }
        
        renderSchedule();
        saveData();
        alert("تم توزيع الموظفين بنجاح لسد النقص.\nاضغط الآن على زر 'توزيع المواقع' لتثبيت أماكنهم.");
    }

    // --- DEPOT DISTRIBUTOR ---
    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        if(!sched) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());

        // التحقق من الإعدادات
        let totalReqs = 0;
        cleanDepots.forEach(d => {
            let r = reqs[d] || reqs[d.trim()];
            if(r) totalReqs += (r.D||0) + (r.EN||0) + (r.LN||0);
        });

        if(totalReqs === 0) {
            alert("تنبيه: يرجى إدخال الأعداد المطلوبة في الإعدادات أولاً.");
            return;
        }

        if(!confirm("سيتم توزيع المواقع بدقة حسب العدد المطلوب.")) return;

        for(let d=1; d<=numDays; d++) {
            let currentCounts = {}; 
            cleanDepots.forEach(dep => { currentCounts[dep] = { D:0, EN:0, LN:0 }; });
            let unassigned = { D: [], EN: [], LN: [] };

            state.employees.forEach(emp => {
                if(sched[emp.id] && sched[emp.id][d]) {
                    const cell = sched[emp.id][d];
                    if(["D","EN","LN"].includes(cell.shift)) {
                        cell.depot = ""; 
                        unassigned[cell.shift].push(cell);
                    }
                }
            });

            ["D", "EN", "LN"].forEach(shiftType => {
                let workers = unassigned[shiftType];
                if(workers.length === 0) return;

                cleanDepots.forEach(dep => {
                    let needed = 0;
                    if(reqs[dep]) needed = reqs[dep][shiftType] || 0;
                    else if(reqs[dep.trim()]) needed = reqs[dep.trim()][shiftType] || 0;
                    
                    while (workers.length > 0 && currentCounts[dep][shiftType] < needed) {
                        let cell = workers.pop(); 
                        cell.depot = dep;      
                        currentCounts[dep][shiftType]++;
                    }
                });

                // الفائض
                while (workers.length > 0) {
                    let targetDepot = cleanDepots.reduce((a, b) => 
                        currentCounts[a][shiftType] < currentCounts[b][shiftType] ? a : b
                    );
                    let cell = workers.pop();
                    cell.depot = targetDepot;
                    currentCounts[targetDepot][shiftType]++;
                }
            });
        }
        
        renderSchedule();
        saveData();
    }

    // --- FIX: CLEAR MONTH ---
    function clearMonth() {
        if(!confirm("هل أنت متأكد من مسح جدول هذا الشهر بالكامل؟")) return;
        
        const key = getMonthKey();
        // 1. تصفير الذاكرة المحلية
        state.schedule[key] = {};
        
        // 2. تحديث الشاشة فوراً
        renderSchedule();
        
        // 3. الحفظ في السيرفر
        saveData();
        
        // 4. رسالة تأكيد (اختياري)
        // alert("تم مسح الشهر.");
    }

    // --- UTILS ---
    function updateDepots() {
        const val = document.getElementById('settingDepots').value;
        appConfig.depots = val.split(',').map(s => s.trim()).filter(s => s);
        renderRequirementsTable();
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const key = getMonthKey();
        const sched = state.schedule[key] || {};
        const requirements = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());
        
        let issues = [];

        for(let d=1; d<=numDays; d++) {
            let dailyCounts = {}; 
            cleanDepots.forEach(dep => dailyCounts[dep] = {D:0, EN:0, LN:0});

            state.employees.forEach(emp => {
                const cell = (sched[emp.id] && sched[emp.id][d]) ? sched[emp.id][d] : null;
                if(cell && cell.shift && cell.depot) {
                    let cellDepot = cell.depot.trim(); 
                    if(dailyCounts[cellDepot] && dailyCounts[cellDepot][cell.shift] !== undefined) {
                        dailyCounts[cellDepot][cell.shift]++;
                    }
                }
            });

            cleanDepots.forEach(dep => {
                let req = requirements[dep] || requirements[dep.trim()];
                if(!req) return;

                ["D","EN","LN"].forEach(shift => {
                    const required = req[shift] || 0;
                    const actual = dailyCounts[dep][shift];
                    if(actual < required) {
                        issues.push(`يوم ${d}: <b>${dep}</b> (شفت ${shift}) - المطلوب ${required}، الموجود ${actual}`);
                    }
                });
            });
        }

        if(issues.length === 0) {
            report.innerHTML = `<div class="report-ok">✅ التغطية مكتملة (100%) - لا يوجد نقص.</div>`;
        } else {
            report.innerHTML = `<h4 style="margin:0 0 10px 0;">⚠️ تقرير النقص الحقيقي (Missing Staff):</h4>` + 
                issues.map(i => `<div class="report-item">❌ ${i}</div>`).join('');
        }
    }

    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        let csv = "\uFEFF"; 
        csv += "الموظف,";
        for(let d=1; d<=numDays; d++) csv += d + ",";
        csv += "\n";

        const key = getMonthKey();
        const data = state.schedule[key] || {};

        state.employees.forEach(emp => {
            csv += `"${emp.name}",`;
            for(let d=1; d<=numDays; d++) {
                const cell = (data[emp.id] && data[emp.id][d]) ? data[emp.id][d] : {shift:""};
                let val = cell.shift;
                if(val && cell.depot) val += ` (${cell.depot})`;
                csv += `"${val}",`;
            }
            csv += "\n";
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Schedule_${appConfig.year}_${appConfig.month}.csv`;
        a.click();
    }
</script>
