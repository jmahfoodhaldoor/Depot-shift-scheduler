<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© (V11 - UI + Ø¹Ø±Ø¶ÙŠÙ†)</title>
  <style>
    :root{
      --primary:#2563eb; --success:#10b981; --danger:#ef4444; --warning:#f59e0b;
      --bg:#f6f8fc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0;
      --shadow: 0 6px 18px rgba(15,23,42,.08);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      margin:0; background:var(--bg); color:var(--text);
      font-size:13.5px; direction:rtl;
    }
    .app-container{ max-width:1480px; margin:0 auto; padding:14px; }
    .topbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:linear-gradient(180deg,#fff, #fbfdff);
      padding:14px; border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; margin-left:auto;
    }
    .brand .logo{
      width:40px; height:40px; border-radius:12px;
      background:linear-gradient(135deg, #2563eb, #60a5fa);
      display:grid; place-items:center; color:#fff; font-weight:900;
      box-shadow:0 8px 18px rgba(37,99,235,.25);
    }
    .brand h1{ margin:0; font-size:1.15rem; font-weight:900; }
    .subnote{ font-size:.8rem; color:var(--muted); font-weight:700; margin-top:2px; }
    .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button{
      cursor:pointer; padding:9px 14px; border:1px solid var(--border); background:#fff;
      border-radius:12px; font-weight:900; transition:.15s; font-family:inherit;
      box-shadow:0 1px 0 rgba(15,23,42,.02);
    }
    button:hover{ transform:translateY(-1px); box-shadow:0 10px 18px rgba(15,23,42,.08); }
    button.primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
    button.success{ background:var(--success); color:#fff; border-color:var(--success); }
    button.danger{ background:var(--danger); color:#fff; border-color:var(--danger); }
    button.ghost{ background:transparent; }
    input,select{
      padding:9px 10px; border:1px solid var(--border); border-radius:12px;
      font-family:inherit; font-weight:800; background:#fff;
    }

    .tabs{
      display:flex; gap:8px; margin:12px 0 10px;
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:8px; box-shadow:var(--shadow);
    }
    .tab{
      padding:10px 14px; cursor:pointer; border-radius:12px;
      color:var(--muted); font-weight:900; transition:.15s;
      border:1px solid transparent;
    }
    .tab:hover{ background:#f1f5ff; color:var(--primary); }
    .tab.active{
      background:#eef2ff; color:var(--primary);
      border-color:#c7d2fe;
    }
    .view{ display:none; }
    .view.active{ display:block; }

    .panel{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:12px; margin-bottom:12px;
    }
    .alert{
      background:#eff6ff; border:1px solid #bfdbfe; color:#1e40af;
      padding:12px; border-radius:12px; font-weight:900;
      display:flex; gap:10px; align-items:flex-start;
    }
    .alert .dot{
      width:10px; height:10px; border-radius:999px; background:#2563eb; margin-top:4px;
      box-shadow:0 0 0 5px rgba(37,99,235,.12);
    }

    .rowbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      justify-content:space-between;
    }
    .seg{
      display:flex; background:#f1f5f9; border:1px solid var(--border);
      border-radius:999px; padding:4px; gap:4px;
    }
    .seg button{
      border-radius:999px; border:1px solid transparent;
      background:transparent; box-shadow:none;
      padding:8px 12px; font-weight:900; color:var(--muted);
    }
    .seg button.active{
      background:#fff; border-color:#cbd5e1; color:#0f172a;
      box-shadow:0 6px 14px rgba(15,23,42,.08);
    }

    .grid-container{
      overflow:auto; background:#fff; border-radius:var(--radius);
      border:1px solid var(--border); box-shadow:var(--shadow);
    }

    .schedule-table{
      border-collapse:separate; border-spacing:0;
      width:100%; min-width:1150px; table-layout:fixed;
    }
    .schedule-table th,.schedule-table td{
      border-bottom:1px solid #eef2f7;
      border-left:1px solid #eef2f7;
      text-align:center; padding:6px; height:42px;
      font-size:.84rem;
    }
    .schedule-table th{
      background:#fbfdff; position:sticky; top:0; z-index:10;
      font-weight:900; color:#334155;
      white-space:nowrap;
    }
    .schedule-table th.emp-col{
      position:sticky; right:0; z-index:20;
      width:210px; text-align:right; padding-right:12px;
      border-left:1px solid #e2e8f0;
      background:#fbfdff;
    }
    .schedule-table td.emp-col{
      position:sticky; right:0; z-index:5; background:#fff;
      text-align:right; padding-right:12px; font-weight:900;
      border-left:1px solid #e2e8f0;
      white-space:nowrap;
    }

    .cell{
      cursor:pointer; user-select:none; transition:.12s;
      font-weight:900;
      border-radius:10px;
    }
    .cell:hover{ filter:brightness(.98); transform:translateY(-.5px); }
    .shift-pill{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:44px; padding:6px 10px; border-radius:999px;
      font-weight:1000; letter-spacing:.2px;
    }
    .badge-depot{
      display:inline-block; margin-top:4px;
      padding:2px 8px; border-radius:999px; font-size:.72rem; font-weight:1000;
      background:#f1f5f9; color:#334155; border:1px solid #e2e8f0;
    }

    .shift-M .shift-pill{ background:#dbeafe; color:#1e40af; }
    .shift-A .shift-pill{ background:#fef3c7; color:#92400e; }
    .shift-N .shift-pill{ background:#0f172a; color:#f8fafc; }
    .shift-OFF .shift-pill{ background:#dcfce7; color:#166534; }
    .shift-VAC .shift-pill{ background:#f3e8ff; color:#7e22ce; }
    .shift-X .shift-pill{ background:#fee2e2; color:#991b1b; }

    .violation{ outline:3px solid var(--danger); outline-offset:-3px; }

    /* Shift view table */
    .shift-table{ min-width:1150px; }
    .shift-table td{ vertical-align:top; }
    .names{
      display:flex; flex-direction:column; gap:4px;
      max-height:88px; overflow:auto;
      padding:4px;
    }
    .name-chip{
      display:inline-flex; align-items:center; gap:6px;
      background:#f8fafc; border:1px solid #e2e8f0;
      border-radius:999px; padding:4px 8px; font-weight:900;
      font-size:.78rem; color:#0f172a;
      justify-content:space-between;
    }
    .mini-tag{
      font-size:.7rem; font-weight:1000; padding:2px 6px; border-radius:999px;
      border:1px solid #e2e8f0; background:#fff; color:#334155;
      white-space:nowrap;
    }

    .report-box{ margin-top:12px; }
    .report-item{
      margin-bottom:6px; padding:8px 10px; border-radius:12px;
      background:#fff1f2; color:#9f1239; border:1px solid #fecdd3;
      font-weight:900;
    }
    .report-ok{
      background:#d1fae5; color:#065f46; padding:14px;
      text-align:center; font-weight:1000; border-radius:12px;
      border:1px solid #a7f3d0;
    }

    /* Loader */
    #loader{ position:fixed; inset:0; background:rgba(255,255,255,.92);
      display:none; flex-direction:column; justify-content:center; align-items:center; z-index:9999;
      backdrop-filter: blur(3px);
    }
    #loader .spin{
      width:56px; height:56px; border-radius:999px;
      border:6px solid #e2e8f0; border-top-color:#2563eb;
      animation:rot 1s linear infinite;
      margin-bottom:10px;
    }
    @keyframes rot{ to{ transform:rotate(360deg);} }

    /* Manual editor modal */
    #cellEditorOverlay{
      position:fixed; inset:0; background:rgba(15,23,42,.35);
      display:none; align-items:center; justify-content:center; z-index:10000;
    }
    #cellEditor{
      width:min(640px,94vw);
      background:#fff; border:1px solid var(--border); border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,.22); padding:14px;
    }
    #cellEditor h3{ margin:0 0 10px; font-size:1rem; font-weight:1000; }
    .ce-row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .ce-row > div{ flex:1; min-width:170px; }
    .ce-row label{ display:block; font-size:.8rem; font-weight:1000; color:#475569; margin-bottom:6px; }
    .ce-actions{ display:flex; gap:10px; justify-content:flex-start; margin-top:8px; flex-wrap:wrap; }
    .ce-hint{ font-size:.78rem; color:#64748b; margin-top:8px; line-height:1.6; font-weight:800; }
    .ce-warn{ background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px; border-radius:12px; font-weight:1000; font-size:.82rem; display:none; }
  </style>
</head>
<body>

<div id="loader">
  <div class="spin"></div>
  <div style="font-weight:1000; color:#0f172a;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...</div>
</div>

<!-- Manual Editor -->
<div id="cellEditorOverlay" onclick="closeCellEditor(event)">
  <div id="cellEditor" onclick="event.stopPropagation()">
    <h3 id="ceTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØª</h3>
    <div class="ce-warn" id="ceWarn"></div>
    <div class="ce-row">
      <div>
        <label>Ø§Ù„Ø´ÙØª</label>
        <select id="ceShift"></select>
      </div>
      <div>
        <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Depot)</label>
        <select id="ceDepot"></select>
      </div>
    </div>
    <div class="ce-actions">
      <button class="primary" onclick="saveCellEdit()">Ø­ÙØ¸</button>
      <button onclick="closeCellEditor()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="danger" onclick="clearCellEdit()">Ù…Ø³Ø­</button>
      <button class="ghost" onclick="applyWeekdayToMonth()">ğŸ“Œ ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ù†ÙØ³ ÙŠÙˆÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ù‡Ø±</button>
    </div>
    <div class="ce-hint">
      - Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙŠØ³Ù…Ø­ Ù„Ùƒ ØªØ³ÙˆÙŠ â€œØ§Ø³ØªØ«Ù†Ø§Ø¡â€ Ø¥Ø°Ø§ Ø§Ù„Ù…ÙˆÙ„Ø¯ Ù…Ø§ Ù‚Ø¯Ø± ÙŠØ­Ù„ Ø­Ø§Ù„Ø© Ù…Ø¹ÙŠÙ†Ø©.<br>
      - Ø²Ø± ğŸ“Œ ÙŠÙƒØ±Ø± Ù†ÙØ³ Ø§Ù„Ø´ÙØª (ÙˆÙ†ÙØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Work) Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù€ weekday Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¸Ù.
    </div>
  </div>
</div>

<div class="app-container">

  <div class="topbar">
    <div class="brand">
      <div class="logo">ğŸ—“ï¸</div>
      <div>
        <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ (V11)</h1>
        <div class="subnote">UI Ø¬Ø¯ÙŠØ¯ + Ø¹Ø±Ø¶ÙŠÙ†: Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù / Ø­Ø³Ø¨ Ø§Ù„Ø´ÙØªØ§Øª</div>
      </div>
    </div>

    <div class="controls">
      <select id="selYear"></select>
      <select id="selMonth"></select>
      <button onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸</button>
      <span style="font-size:.8rem; color:var(--muted); font-weight:900;" id="lastUpdated"></span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('schedule')">Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>
    <div class="tab" onclick="switchTab('employees')">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
    <div class="tab" onclick="switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
  </div>

  <div id="view-schedule" class="view active">

    <div class="panel">
      <div class="alert">
        <div class="dot"></div>
        <div>
          <div style="font-weight:1000;">V11</div>
          <div style="margin-top:4px;">
            Template Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙŠØªÙƒØ±Ø± â€¢ ØªÙˆØ²ÙŠØ¹ OFF Ù„Ù„Ø¯ÙˆÙ‘Ø§Ø± Ø¨Ø¯ÙˆÙ† ØªÙƒØ¯Ù‘Ø³ â€¢ Ù…Ù†Ø¹ Friday OFF Ù„Ù„Ø¯ÙˆÙ‘Ø§Ø±/Ø§Ù„Ø¬ÙˆÙƒØ± (Ø¢Ù„ÙŠØ§Ù‹) â€¢ Ø§Ù„Ø¬ÙˆÙƒØ± ÙŠÙØ¶Ù‘Ù„ N â€¢ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ + ØªÙƒØ±Ø§Ø± weekday
          </div>
        </div>
      </div>

      <div class="rowbar" style="margin-top:12px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="primary" onclick="generateScheduleV11()">âš¡ ØªÙˆÙ„ÙŠØ¯ (V11)</button>
          <button class="success" onclick="fillDepots()">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
          <button class="danger" onclick="clearMonth()">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
          <button onclick="exportCSV()">ğŸ“„ Excel</button>
        </div>

        <div class="seg" title="Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶">
          <button id="btnViewEmp" class="active" onclick="setScheduleView('emp')">ğŸ‘¤ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù</button>
          <button id="btnViewShift" onclick="setScheduleView('shift')">ğŸ§© Ø­Ø³Ø¨ Ø§Ù„Ø´ÙØªØ§Øª</button>
        </div>
      </div>
    </div>

    <!-- View 1 -->
    <div id="scheduleByEmployee" class="grid-container">
      <table class="schedule-table" id="scheduleGrid"></table>
    </div>

    <!-- View 2 -->
    <div id="scheduleByShift" class="grid-container" style="display:none;">
      <table class="schedule-table shift-table" id="shiftGrid"></table>
    </div>

    <div id="coverageReport" class="report-box panel"></div>
  </div>

  <div id="view-employees" class="view">
    <div class="panel">
      <button class="primary" onclick="addEmployee()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
    </div>
    <div id="employeeList"></div>
  </div>

  <div id="view-settings" class="view">
    <div class="panel">
      <h3 style="margin:0 0 10px; font-weight:1000;">1ï¸âƒ£ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
      <input type="text" id="settingDepots" style="width:100%;" onchange="updateDepots()">
    </div>

    <div class="panel">
      <h3 style="margin:0 0 10px; font-weight:1000;">2ï¸âƒ£ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (M, A, N)</h3>
      <div id="requirementsContainer"></div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 10px; font-weight:1000;">3ï¸âƒ£ ØªØ­ÙƒÙ…</h3>
      <button class="danger" onclick="saveData(true)">âš ï¸ ØªØµÙÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
  </div>

</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec";

  let state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } };
  let appConfig = { depots: ["Budaiya","IsaTown"], year:new Date().getFullYear(), month:new Date().getMonth()+1 };

  const SHIFTS = ["M","A","N","OFF","VAC","X"];
  const WORK_SHIFTS = ["M","A","N"];
  const WEEKDAYS = ["Ø£Ø­Ø¯","Ø§Ø«Ù†ÙŠÙ†","Ø«Ù„Ø§Ø«Ø§Ø¡","Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø®Ù…ÙŠØ³","Ø¬Ù…Ø¹Ø©","Ø³Ø¨Øª"];
  const MAX_CONSECUTIVE = 6;
  const FRIDAY = 5; // 0 Sun..5 Fri..6 Sat

  let currentScheduleView = "emp"; // emp | shift

  // =========================
  // SAFETY GATE
  // =========================
  function isShiftFlipViolation(prev, next){
    if(!prev || ["OFF","VAC","X",""].includes(prev)) return false;
    if(!next || ["OFF","VAC","X",""].includes(next)) return false;
    if(prev==="N") return (next==="M" || next==="A");
    if(prev==="A") return (next==="M");
    return false;
  }
  function breaksStreak(shift){ return shift === "OFF"; } // ÙÙ‚Ø· OFF ÙŠÙƒØ³Ø±

  // =========================
  // INIT
  // =========================
  window.onload = () => { initDateSelectors(); loadData(); };

  function initDateSelectors(){
    const ySel = document.getElementById("selYear");
    const mSel = document.getElementById("selMonth");
    const curr = new Date().getFullYear();
    for(let y=curr-1;y<=curr+2;y++) ySel.add(new Option(y,y));
    ySel.value = curr;
    ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"]
      .forEach((m,i)=>mSel.add(new Option(m,i+1)));
    mSel.value = new Date().getMonth()+1;
    ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderAll(); };
    mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderAll(); };
  }

  function switchTab(t){
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".view").forEach(x=>x.classList.remove("active"));
    event.target.classList.add("active");
    document.getElementById(`view-${t}`).classList.add("active");
  }

  function showLoader(s){ document.getElementById("loader").style.display = s ? "flex" : "none"; }

  function setScheduleView(mode){
    currentScheduleView = mode;
    document.getElementById("btnViewEmp").classList.toggle("active", mode==="emp");
    document.getElementById("btnViewShift").classList.toggle("active", mode==="shift");
    document.getElementById("scheduleByEmployee").style.display = (mode==="emp") ? "" : "none";
    document.getElementById("scheduleByShift").style.display = (mode==="shift") ? "" : "none";
    if(mode==="shift") renderShiftView();
  }

  // =========================
  // API
  // =========================
  async function loadData(){
    showLoader(true);
    try{
      const res = await fetch(`${API_URL}?action=load`);
      const json = await res.json();
      if(json.ok){
        const data = json.data || {};
        state.employees = data.employees || [];
        state.schedule  = data.schedule  || {};
        state.meta      = data.meta      || { requirements:{}, depots:[] };

        if(state.meta.depots && state.meta.depots.length) appConfig.depots = state.meta.depots;
        document.getElementById("settingDepots").value = appConfig.depots.join(", ");

        state.employees.forEach(emp=>{
          if(!emp.id) emp.id = "emp_"+Math.random().toString(36).slice(2,10);
          if(!emp.patternType) emp.patternType = "weekly";
          if(!emp.weeklyTemplate) emp.weeklyTemplate = Array(7).fill("M");
          if(!emp.flexCounts) emp.flexCounts = {M:1,A:2,N:2,OFF:2};
          if(!emp.depotQuotas) emp.depotQuotas = {};
          if(!emp.vacationDates) emp.vacationDates = "";
        });

        renderAll();
        if(state.meta.updatedAt){
          document.getElementById("lastUpdated").innerText = "Ø¢Ø®Ø± Ø­ÙØ¸: " + new Date(state.meta.updatedAt).toLocaleTimeString();
        }
      }
    }catch(e){
      console.error(e);
      alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„.");
    }finally{
      showLoader(false);
    }
  }

  async function saveData(reset=false){
    showLoader(true);
    if(reset && !confirm("âš ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")){ showLoader(false); return; }
    if(reset) state = { employees:[], schedule:{}, meta:{ requirements:{}, depots:[] } };
    state.meta.depots = appConfig.depots;
    state.meta.updatedAt = new Date().toISOString();
    try{
      await fetch(API_URL, { method:"POST", body: JSON.stringify({ action:"save", payload:{ employees:state.employees, schedule:state.schedule, meta:state.meta } }) });
      document.getElementById("lastUpdated").innerText = "Ø¢Ø®Ø± Ø­ÙØ¸: " + new Date().toLocaleTimeString();
      if(reset) renderAll();
    }catch(e){
      alert("Ø®Ø·Ø£ Ø­ÙØ¸.");
    }finally{
      showLoader(false);
    }
  }

  // =========================
  // UI RENDER
  // =========================
  function renderAll(){
    renderEmployees();
    renderRequirementsTable();
    renderSchedule();
    if(currentScheduleView==="shift") renderShiftView();
  }

  function renderRequirementsTable(){
    const container = document.getElementById("requirementsContainer");
    if(!state.meta.requirements) state.meta.requirements = {};
    let html = `<table class="req-table"><thead><tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>M</th><th>A</th><th>N</th></tr></thead><tbody>`;
    appConfig.depots.forEach(dep=>{
      const r = state.meta.requirements[dep] || {M:0,A:0,N:0};
      html += `<tr>
        <td style="font-weight:1000;">${dep}</td>
        <td><input type="number" min="0" class="req-input" value="${r.M||0}" onchange="updateReq('${dep}','M',this.value)"></td>
        <td><input type="number" min="0" class="req-input" value="${r.A||0}" onchange="updateReq('${dep}','A',this.value)"></td>
        <td><input type="number" min="0" class="req-input" value="${r.N||0}" onchange="updateReq('${dep}','N',this.value)"></td>
      </tr>`;
    });
    container.innerHTML = html + `</tbody></table>`;
  }
  function updateReq(dep,shift,value){
    if(!state.meta.requirements[dep]) state.meta.requirements[dep] = {};
    state.meta.requirements[dep][shift] = parseInt(value)||0;
  }

  function renderEmployees(){
    const container = document.getElementById("employeeList");
    container.innerHTML = "";

    state.employees.forEach(emp=>{
      const div = document.createElement("div");
      div.className = "panel";

      let weekHtml = "<div style='display:grid; grid-template-columns:repeat(7,1fr); gap:8px;'>";
      WEEKDAYS.forEach((day,i)=>{
        const opts = SHIFTS.filter(s=>!["VAC","X"].includes(s)).map(s=>`<option value="${s}" ${emp.weeklyTemplate[i]===s?'selected':''}>${s}</option>`).join("");
        weekHtml += `<div style="text-align:center;">
          <div style="font-size:.72rem;color:var(--muted);font-weight:1000;margin-bottom:6px;">${day}</div>
          <select onchange="updateWeeklyTemplate('${emp.id}',${i},this.value)" style="width:100%;">${opts}</select>
        </div>`;
      });
      weekHtml += "</div>";

      let quotasHtml = `<div class="depot-quotas">`;
      appConfig.depots.forEach(dep=>{
        const val = (emp.depotQuotas && emp.depotQuotas[dep]) || 0;
        quotasHtml += `<div><label>${dep}</label><input type="number" min="0" value="${val}" onchange="updateDepotQuota('${emp.id}','${dep}',this.value)"></div>`;
      });
      quotasHtml += `</div>`;

      let vacationHtml = `<div class="vacation-input">
        <label style="font-weight:1000;">ğŸ–ï¸ Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (Ù…Ø«Ø§Ù„: 5, 6)</label>
        <input type="text" value="${emp.vacationDates||''}" onchange="updateVacationDates('${emp.id}',this.value)">
      </div>`;

      const flex = emp.flexCounts || {M:1,A:2,N:2,OFF:2};
      let patternHtml = "";
      if(emp.patternType==="rolling"){
        patternHtml = `<div class="pattern-editor"><div class="flex-counts">
          <div><label>M</label><input type="number" value="${flex.M}" onchange="updateFlexCount('${emp.id}','M',this.value)"></div>
          <div><label>A</label><input type="number" value="${flex.A}" onchange="updateFlexCount('${emp.id}','A',this.value)"></div>
          <div><label>N</label><input type="number" value="${flex.N}" onchange="updateFlexCount('${emp.id}','N',this.value)"></div>
          <div><label>OFF</label><input type="number" value="${flex.OFF}" onchange="updateFlexCount('${emp.id}','OFF',this.value)"></div>
        </div></div>`;
      } else if(emp.patternType==="joker"){
        patternHtml = `<div class="pattern-editor" style="border-style:solid;">
          <div style="color:#b45309; font-weight:1000;">ğŸƒ Ø¬ÙˆÙƒØ±</div>
          <div style="font-size:.82rem; margin-top:6px; font-weight:900; color:#92400e;">
            Ø¢Ù„ÙŠØ§Ù‹: N Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… A Ø¹Ù†Ø¯ Ø§Ù„Ø¶Ø±ÙˆØ±Ø©ØŒ Ùˆ M Ù…Ù…Ù†ÙˆØ¹.
          </div>
        </div>`;
      } else {
        patternHtml = `<div class="pattern-editor">${weekHtml}</div>`;
      }

      div.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <input type="text" value="${emp.name}" onchange="updateEmployee('${emp.id}','name',this.value)" style="font-weight:1000; flex:1; min-width:220px;">
          <select onchange="updateEmployee('${emp.id}','patternType',this.value)">
            <option value="weekly" ${emp.patternType==='weekly'?'selected':''}>Ø«Ø§Ø¨Øª</option>
            <option value="rolling" ${emp.patternType==='rolling'?'selected':''}>Ø¯ÙˆØ§Ø±</option>
            <option value="joker" ${emp.patternType==='joker'?'selected':''}>Ø¬ÙˆÙƒØ±</option>
          </select>
          <button class="danger" onclick="deleteEmployee('${emp.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
        ${vacationHtml}
        <div style="margin:10px 0; font-weight:1000; color:var(--muted);">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:</div>
        ${quotasHtml}
        ${patternHtml}
      `;
      container.appendChild(div);
    });
  }

  function addEmployee(){
    state.employees.push({
      id:'emp_'+Math.random().toString(36).slice(2,10),
      name:'Ø¬Ø¯ÙŠØ¯',
      patternType:'weekly',
      weeklyTemplate:Array(7).fill("M"),
      flexCounts:{M:1,A:2,N:2,OFF:2},
      depotQuotas:{},
      vacationDates:""
    });
    renderEmployees();
  }
  function updateEmployee(id,k,v){
    const e = state.employees.find(x=>x.id===id);
    if(e){ e[k]=v; if(k==="patternType") renderEmployees(); }
  }
  function updateWeeklyTemplate(id,i,v){
    const e = state.employees.find(x=>x.id===id);
    if(e) e.weeklyTemplate[i]=v;
  }
  function updateFlexCount(id,s,v){
    const e = state.employees.find(x=>x.id===id);
    if(e){
      if(!e.flexCounts) e.flexCounts={};
      e.flexCounts[s]=Math.max(0, parseInt(v)||0);
    }
  }
  function updateDepotQuota(id,dep,v){
    const e = state.employees.find(x=>x.id===id);
    if(e){
      if(!e.depotQuotas) e.depotQuotas={};
      e.depotQuotas[dep]=Math.max(0, parseInt(v)||0);
    }
  }
  function updateVacationDates(id,v){
    const e = state.employees.find(x=>x.id===id);
    if(e) e.vacationDates=v;
  }
  function deleteEmployee(id){
    if(confirm("Ø­Ø°ÙØŸ")){
      state.employees = state.employees.filter(x=>x.id!==id);
      renderAll();
      saveData();
    }
  }
  function updateDepots(){
    appConfig.depots = document.getElementById("settingDepots").value.split(",").map(s=>s.trim()).filter(Boolean);
    renderAll();
  }

  // =========================
  // Schedule helpers
  // =========================
  function getMonthKey(){ return `${appConfig.year}-${appConfig.month}`; }
  function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

  function ensureMonthSchedule(){
    const key = getMonthKey();
    if(!state.schedule[key]) state.schedule[key] = {};
    state.employees.forEach(e=>{
      if(!state.schedule[key][e.id]) state.schedule[key][e.id] = {};
    });
    return state.schedule[key];
  }

  function getCell(sched, empId, day){
    return (sched[empId] && sched[empId][day]) ? sched[empId][day] : null;
  }
  function setCell(sched, empId, day, shift, depot=""){
    sched[empId][day] = { shift, depot };
  }

  // =========================
  // VAC
  // =========================
  function applyVacations(numDays, sched){
    state.employees.forEach(emp=>{
      if(!emp.vacationDates) return;
      emp.vacationDates.split(",")
        .map(x=>parseInt(x.trim()))
        .filter(x=>!isNaN(x) && x>=1 && x<=numDays)
        .forEach(day=>{
          setCell(sched, emp.id, day, "VAC", "");
        });
    });
  }

  // =========================
  // V11 generator
  // =========================
  function generateScheduleV11(){
    if(!confirm("ğŸš€ ØªÙˆÙ„ÙŠØ¯ V11ØŸ\n- Ø§Ù„Ø«Ø§Ø¨Øª Template\n- Ø§Ù„Ø¯ÙˆÙ‘Ø§Ø± OFF Ù…ÙˆØ²Ø¹ + Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù…Ø¹Ø©\n- Ø§Ù„Ø¬ÙˆÙƒØ± N Ø£ÙˆÙ„Ø§Ù‹ + Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù…Ø¹Ø©\n- VAC Ù„Ø§ ÙŠÙÙ…Ø³\n\nØ¨Ø¹Ø¯Ù‡Ø§ ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„ ÙŠØ¯ÙˆÙŠ ÙˆØªØ«Ø¨Øª Ø¨Ø§Ù„Ù€ ğŸ“Œ")) return;

    showLoader(true);
    setTimeout(()=> {
      try{
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = ensureMonthSchedule();

        // reset month
        for(const emp of state.employees) sched[emp.id] = {};

        applyVacations(numDays, sched);

        const fixed = state.employees.filter(e=>e.patternType==="weekly");
        const rolling = state.employees.filter(e=>e.patternType==="rolling");
        const joker = state.employees.filter(e=>e.patternType==="joker");

        applyFixedTemplateForMonth(numDays, sched, fixed);

        const rollingTemplates = buildRollingWeeklyTemplates(rolling);
        applyWeeklyTemplatesForMonth(numDays, sched, rolling, rollingTemplates, { forbidFridayOff:true });

        const jokerTemplates = buildJokerWeeklyTemplates(joker);
        applyWeeklyTemplatesForMonth(numDays, sched, joker, jokerTemplates, { forbidFridayOff:true });

        enforceSafetyAndStreakMonth(numDays, sched);

        renderSchedule();
        if(currentScheduleView==="shift") renderShiftView();
        saveData();
        alert("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (V11)!");
      }catch(e){
        console.error(e);
        alert("Ø®Ø·Ø£: " + (e?.message || e));
      }finally{
        showLoader(false);
      }
    }, 80);
  }

  function applyFixedTemplateForMonth(numDays, sched, fixedEmps){
    fixedEmps.forEach(emp=>{
      let prev = "OFF";
      let streak = 0;

      for(let day=1; day<=numDays; day++){
        const existing = getCell(sched, emp.id, day);
        if(existing && existing.shift==="VAC"){ prev="VAC"; continue; }

        const dow = new Date(appConfig.year, appConfig.month-1, day).getDay();
        let shift = emp.weeklyTemplate[dow] || "OFF";

        if(streak >= MAX_CONSECUTIVE && WORK_SHIFTS.includes(shift)) shift = "OFF";
        if(isShiftFlipViolation(prev, shift)) shift = "OFF";

        setCell(sched, emp.id, day, shift, "");

        if(breaksStreak(shift)) streak = 0;
        else if(WORK_SHIFTS.includes(shift)) streak++;

        prev = shift;
      }
    });
  }

  function buildRollingWeeklyTemplates(rollingEmps){
    const offCountsByDow = Array(7).fill(0);
    const templates = {};

    function pickOffDow(excludeSet){
      let best = null, bestCount = Infinity;
      for(let d=0; d<7; d++){
        if(d === FRIDAY) continue;
        if(excludeSet.has(d)) continue;
        if(offCountsByDow[d] < bestCount){ bestCount = offCountsByDow[d]; best = d; }
      }
      if(best===null){
        for(let d=0; d<7; d++) if(d!==FRIDAY && !excludeSet.has(d)) return d;
        return 6;
      }
      return best;
    }

    const list = [...rollingEmps].sort((a,b)=> (a.id>b.id?1:-1));

    list.forEach(emp=>{
      const f = emp.flexCounts || {M:1,A:2,N:2,OFF:2};
      const offSlots = Math.min(6, Math.max(0, parseInt(f.OFF)||0));

      const week = Array(7).fill(null);
      const chosen = new Set();
      for(let i=0; i<offSlots; i++){
        const d = pickOffDow(chosen);
        chosen.add(d);
        offCountsByDow[d]++;
        week[d] = "OFF";
      }

      let m = Math.max(0, parseInt(f.M)||0);
      let a = Math.max(0, parseInt(f.A)||0);
      let n = Math.max(0, parseInt(f.N)||0);

      const workSlots = 7 - offSlots;
      let total = m + a + n;

      if(total < workSlots) m += (workSlots - total);
      else if(total > workSlots){
        let excess = total - workSlots;
        const dec = (ref)=>{ const take=Math.min(ref.val,excess); ref.val-=take; excess-=take; };
        let refN={val:n}, refA={val:a}, refM={val:m};
        dec(refN); dec(refA); dec(refM);
        n=refN.val; a=refA.val; m=refM.val;
      }

      const pool = [];
      for(let i=0;i<m;i++) pool.push("M");
      for(let i=0;i<a;i++) pool.push("A");
      for(let i=0;i<n;i++) pool.push("N");

      let idx=0;
      for(let d=0; d<7; d++){
        if(week[d]==="OFF") continue;
        week[d] = pool[idx] || "M";
        idx++;
      }

      fixWeekAntiFlip(week);
      templates[emp.id] = week;
    });

    return templates;
  }

  function buildJokerWeeklyTemplates(jokerEmps){
    const offCountsByDow = Array(7).fill(0);
    const templates = {};

    function pickOffDow(){
      let best=null, bestCount=Infinity;
      for(let d=0; d<7; d++){
        if(d === FRIDAY) continue;
        if(offCountsByDow[d] < bestCount){ bestCount = offCountsByDow[d]; best = d; }
      }
      if(best===null) best = 6;
      return best;
    }

    const list = [...jokerEmps].sort((a,b)=> (a.id>b.id?1:-1));
    list.forEach(emp=>{
      const week = Array(7).fill("N");
      const offDow = pickOffDow();
      offCountsByDow[offDow]++;
      week[offDow] = "OFF";
      fixWeekAntiFlip(week);
      templates[emp.id] = week;
    });
    return templates;
  }

  function fixWeekAntiFlip(week){
    const upgrade = (s) => (s==="M" ? "A" : (s==="A" ? "N" : s));

    for(let pass=0; pass<5; pass++){
      let changed=false;
      for(let i=0; i<7; i++){
        const prev = week[i];
        const j = (i+1)%7;
        let next = week[j];

        if(isShiftFlipViolation(prev,next)){
          let cand = next;
          for(let k=0;k<2;k++){
            cand = upgrade(cand);
            if(!isShiftFlipViolation(prev,cand)){ week[j]=cand; changed=true; break; }
          }
          if(isShiftFlipViolation(prev, week[j])){ week[j]="OFF"; changed=true; }
        }
      }
      if(!changed) break;
    }
  }

  function tryUpgradeToAvoidFlip(prev, desired, type){
    const upgrade = (s) => (s==="M" ? "A" : (s==="A" ? "N" : s));
    let cand = desired;
    for(let i=0;i<3;i++){
      if(!isShiftFlipViolation(prev, cand)){
        if(type==="joker" && cand==="M") cand="A";
        if(!isShiftFlipViolation(prev,cand)) return cand;
      }
      cand = upgrade(cand);
    }
    return "OFF";
  }

  function applyWeeklyTemplatesForMonth(numDays, sched, emps, templates, opts={forbidFridayOff:true}){
    emps.forEach(emp=>{
      const week = templates[emp.id] || Array(7).fill("M");
      let prev = "OFF";
      let streak = 0;

      for(let day=1; day<=numDays; day++){
        const existing = getCell(sched, emp.id, day);
        if(existing && existing.shift==="VAC"){ prev="VAC"; continue; }

        const dow = new Date(appConfig.year, appConfig.month-1, day).getDay();
        let shift = week[dow] || "OFF";

        if(opts.forbidFridayOff && dow===FRIDAY && shift==="OFF"){
          shift = (emp.patternType==="joker") ? "N" : "A";
        }

        if(streak >= MAX_CONSECUTIVE && WORK_SHIFTS.includes(shift)) shift = "OFF";
        if(isShiftFlipViolation(prev, shift)) shift = tryUpgradeToAvoidFlip(prev, shift, emp.patternType);

        if(emp.patternType==="joker" && shift==="M"){
          shift = "A";
          if(isShiftFlipViolation(prev, shift)) shift = tryUpgradeToAvoidFlip(prev, shift, "joker");
        }

        setCell(sched, emp.id, day, shift, "");

        if(breaksStreak(shift)) streak = 0;
        else if(WORK_SHIFTS.includes(shift)) streak++;

        prev = shift;
      }
    });
  }

  function enforceSafetyAndStreakMonth(numDays, sched){
    state.employees.forEach(emp=>{
      let prev = "OFF";
      let streak = 0;

      for(let day=1; day<=numDays; day++){
        const c = getCell(sched, emp.id, day);
        if(!c){ setCell(sched, emp.id, day, "OFF", ""); prev="OFF"; streak=0; continue; }

        if(c.shift==="VAC"){ prev="VAC"; continue; }

        if(streak >= MAX_CONSECUTIVE && WORK_SHIFTS.includes(c.shift)){ c.shift="OFF"; c.depot=""; }
        if(isShiftFlipViolation(prev, c.shift)){ c.shift="OFF"; c.depot=""; }

        if(emp.patternType==="joker" && c.shift==="M"){
          c.shift="A";
          if(isShiftFlipViolation(prev,c.shift)) c.shift="OFF";
        }

        if(breaksStreak(c.shift)) streak = 0;
        else if(WORK_SHIFTS.includes(c.shift)) streak++;

        prev = c.shift;
      }
    });
  }

  // =========================
  // DEPOT FILL
  // =========================
  function fillDepots(){
    const key = getMonthKey();
    const sched = state.schedule[key];
    if(!sched || !confirm("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ØŸ")) return;
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const reqs = state.meta.requirements || {};
    const depots = appConfig.depots.map(d=>d.trim());

    for(let d=1; d<=numDays; d++){
      state.employees.forEach(e=>{
        if(sched[e.id]?.[d] && WORK_SHIFTS.includes(sched[e.id][d].shift)) sched[e.id][d].depot = "";
      });
    }

    for(let d=1; d<=numDays; d++){
      const counts = {}; depots.forEach(dp=>counts[dp]={M:0,A:0,N:0});
      const workers = {M:[],A:[],N:[]};

      state.employees.forEach(e=>{
        const c = sched[e.id]?.[d];
        if(!c) return;
        if(WORK_SHIFTS.includes(c.shift)) workers[c.shift].push(e);
      });

      ["M","A","N"].forEach(s=>{
        let list = workers[s];
        list.sort((a,b)=>((b.depotQuotas?.[depots[0]]||0) - (a.depotQuotas?.[depots[0]]||0)));

        depots.forEach(dep=>{
          let need = (reqs[dep]||{})[s] || 0;
          let i=0;
          while(i<list.length && counts[dep][s] < need){
            const e = list[i];
            if(!sched[e.id][d].depot){
              sched[e.id][d].depot = dep;
              counts[dep][s]++;
            }
            i++;
          }
        });

        list.forEach(e=>{
          if(!sched[e.id][d].depot){
            const target = depots.reduce((a,b)=>counts[a][s]<counts[b][s]?a:b);
            sched[e.id][d].depot = target;
            counts[target][s]++;
          }
        });
      });
    }

    renderSchedule();
    if(currentScheduleView==="shift") renderShiftView();
    saveData();
  }

  // =========================
  // RENDER: employee view
  // =========================
  function renderSchedule(){
    const grid = document.getElementById("scheduleGrid");
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const data = state.schedule[getMonthKey()] || {};

    let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
    for(let d=1; d<=numDays; d++){
      const wd = new Date(appConfig.year, appConfig.month-1, d).getDay();
      html += `<th>${d} <span style="color:var(--muted);font-weight:1000;">${WEEKDAYS[wd]}</span></th>`;
    }
    html += `</tr></thead><tbody>`;

    state.employees.forEach(emp=>{
      let row = `<tr><td class="emp-col">${emp.name}</td>`;
      let prev = "OFF";

      for(let d=1; d<=numDays; d++){
        const c = (data[emp.id] && data[emp.id][d]) ? data[emp.id][d] : {shift:"", depot:""};
        const s = c.shift || "";
        const v = isShiftFlipViolation(prev, s) ? "violation" : "";
        const depotBadge = (c.depot && WORK_SHIFTS.includes(s)) ? `<div class="badge-depot">${c.depot}</div>` : "";
        row += `
          <td class="cell shift-${s} ${v}" onclick="openCellEditorById('${emp.id}', ${d})">
            <div class="shift-pill">${s || "-"}</div>
            ${depotBadge}
          </td>`;
        prev = s || "OFF";
      }

      html += row + `</tr>`;
    });

    grid.innerHTML = html + `</tbody>`;
    analyzeCoverage();
  }

  // =========================
  // RENDER: shift view
  // =========================
  function renderShiftView(){
    const grid = document.getElementById("shiftGrid");
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const data = state.schedule[getMonthKey()] || {};

    // build map: day -> shift -> array of {name,depot,patternType}
    const map = {};
    for(let d=1; d<=numDays; d++){
      map[d] = {};
      SHIFTS.forEach(s=>map[d][s]=[]);
    }

    state.employees.forEach(emp=>{
      for(let d=1; d<=numDays; d++){
        const c = data[emp.id]?.[d];
        const s = c?.shift || "OFF";
        const depot = c?.depot || "";
        map[d][s].push({ name: emp.name, depot, type: emp.patternType });
      }
    });

    let html = `<thead><tr><th class="emp-col">Ø§Ù„Ø´ÙØª</th>`;
    for(let d=1; d<=numDays; d++){
      const wd = new Date(appConfig.year, appConfig.month-1, d).getDay();
      html += `<th>${d} <span style="color:var(--muted);font-weight:1000;">${WEEKDAYS[wd]}</span></th>`;
    }
    html += `</tr></thead><tbody>`;

    SHIFTS.forEach(shift=>{
      html += `<tr>
        <td class="emp-col">
          <span class="shift-pill" style="border:1px solid var(--border); background:#fff;">${shift}</span>
        </td>`;

      for(let d=1; d<=numDays; d++){
        const list = map[d][shift] || [];
        // sort to keep stable (optional)
        list.sort((a,b)=>a.name.localeCompare(b.name,'ar'));

        const namesHtml = list.length
          ? `<div class="names">` + list.map(x=>{
              const depotTag = (x.depot && WORK_SHIFTS.includes(shift)) ? `<span class="mini-tag">${x.depot}</span>` : "";
              return `<div class="name-chip"><span>${x.name}</span>${depotTag}</div>`;
            }).join("") + `</div>`
          : `<div style="color:var(--muted); font-weight:900;">â€”</div>`;

        html += `<td class="shift-${shift}">${namesHtml}</td>`;
      }

      html += `</tr>`;
    });

    grid.innerHTML = html + `</tbody>`;
  }

  // =========================
  // COVERAGE REPORT (as-is)
  // =========================
  function analyzeCoverage(){
    const report = document.getElementById("coverageReport");
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const sched = state.schedule[getMonthKey()] || {};
    const depots = appConfig.depots.map(d=>d.trim());
    const reqs = state.meta.requirements || {};
    let issues = [];

    let anyDepotAssigned = false;
    for(let d=1; d<=numDays; d++){
      for(const e of state.employees){
        const c = sched[e.id]?.[d];
        if(c && c.depot){ anyDepotAssigned=true; break; }
      }
      if(anyDepotAssigned) break;
    }
    if(!anyDepotAssigned){
      report.innerHTML = `<div class="report-item">â„¹ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù… ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹" Ø«Ù… Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</div>`;
      return;
    }

    for(let d=1; d<=numDays; d++){
      let counts = {}; depots.forEach(dp=>counts[dp]={M:0,A:0,N:0});
      state.employees.forEach(e=>{
        let c = sched[e.id]?.[d];
        if(c && c.depot && WORK_SHIFTS.includes(c.shift)) counts[c.depot.trim()][c.shift]++;
      });
      depots.forEach(dep=>{
        let r = reqs[dep] || {};
        ["M","A","N"].forEach(s=>{
          let req = r[s]||0;
          let act = counts[dep][s]||0;
          if(act < req) issues.push(`ÙŠÙˆÙ… ${d} | ${dep} | (${s}) : Ù…Ø·Ù„ÙˆØ¨ ${req}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${act}`);
        });
      });
    }

    report.innerHTML = issues.length
      ? issues.map(i=>`<div class="report-item">${i}</div>`).join("")
      : `<div class="report-ok">âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù…ØªØ§Ø²!</div>`;
  }

  // =========================
  // Manual editor (unchanged logic)
  // =========================
  let ceContext = { empId:null, day:null };

  function openCellEditorById(empId, day){
    const key = getMonthKey();
    if(!state.schedule[key]) state.schedule[key] = {};
    if(!state.schedule[key][empId]) state.schedule[key][empId] = {};
    if(!state.schedule[key][empId][day]) state.schedule[key][empId][day] = { shift:"OFF", depot:"" };

    ceContext = { empId, day };

    const emp = state.employees.find(e=>e.id===empId);
    const wd = new Date(appConfig.year, appConfig.month-1, day).getDay();
    document.getElementById("ceTitle").innerText = `ØªØ¹Ø¯ÙŠÙ„: ${emp?.name||''} | ÙŠÙˆÙ… ${day} (${WEEKDAYS[wd]})`;

    const shiftSel = document.getElementById("ceShift");
    shiftSel.innerHTML = SHIFTS.map(s=>`<option value="${s}">${s}</option>`).join("");

    const depotSel = document.getElementById("ceDepot");
    depotSel.innerHTML = `<option value="">â€”</option>` + appConfig.depots.map(d=>`<option value="${d}">${d}</option>`).join("");

    const cur = state.schedule[key][empId][day];
    shiftSel.value = cur.shift || "OFF";
    depotSel.value = cur.depot || "";

    document.getElementById("ceWarn").style.display = "none";
    document.getElementById("cellEditorOverlay").style.display = "flex";

    shiftSel.onchange = showManualWarnings;
    depotSel.onchange = showManualWarnings;
    showManualWarnings();
  }

  function showManualWarnings(){
    const warn = document.getElementById("ceWarn");
    const key = getMonthKey();
    const {empId, day} = ceContext;
    if(!empId || !day) return;

    const newShift = document.getElementById("ceShift").value;
    const wd = new Date(appConfig.year, appConfig.month-1, day).getDay();
    const emp = state.employees.find(e=>e.id===empId);

    const prevDay = day-1;
    const prev = prevDay>=1 ? (state.schedule[key][empId]?.[prevDay]?.shift || "OFF") : "OFF";

    let msgs = [];
    if(isShiftFlipViolation(prev, newShift)) msgs.push(`ØªØ­Ø°ÙŠØ± Ø£Ù…Ø§Ù†: Ù…Ù…Ù†ÙˆØ¹ (${prev}) â†’ (${newShift}).`);
    if(wd===FRIDAY && newShift==="OFF" && emp && emp.patternType!=="weekly")
      msgs.push("ØªÙ†Ø¨ÙŠÙ‡: Friday OFF Ù„Ù„Ø¯ÙˆÙ‘Ø§Ø±/Ø§Ù„Ø¬ÙˆÙƒØ± Ù…Ù…Ù†ÙˆØ¹ ÙÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¢Ù„ÙŠ (Ù„ÙƒÙ† Ù…Ø³Ù…ÙˆØ­ ÙŠØ¯ÙˆÙŠ).");
    if(emp?.patternType==="joker" && newShift==="M")
      msgs.push("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¬ÙˆÙƒØ± M Ù…Ù…Ù†ÙˆØ¹ ÙÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¢Ù„ÙŠ (Ù„ÙƒÙ† Ù…Ø³Ù…ÙˆØ­ ÙŠØ¯ÙˆÙŠ).");

    if(msgs.length){
      warn.innerHTML = "âš ï¸ " + msgs.join("<br>â€¢ ");
      warn.style.display = "block";
    }else{
      warn.style.display = "none";
      warn.innerHTML = "";
    }
  }

  function saveCellEdit(){
    const key = getMonthKey();
    const {empId, day} = ceContext;
    if(!empId || !day) return;

    const shift = document.getElementById("ceShift").value;
    const depot = document.getElementById("ceDepot").value;

    state.schedule[key][empId][day] = state.schedule[key][empId][day] || {shift:"OFF", depot:""};
    state.schedule[key][empId][day].shift = shift;
    state.schedule[key][empId][day].depot = WORK_SHIFTS.includes(shift) ? (depot||"") : "";

    closeCellEditor();
    renderSchedule();
    if(currentScheduleView==="shift") renderShiftView();
    saveData();
  }

  function clearCellEdit(){
    const key = getMonthKey();
    const {empId, day} = ceContext;
    if(!empId || !day) return;
    if(state.schedule[key]?.[empId]?.[day]) delete state.schedule[key][empId][day];
    closeCellEditor();
    renderSchedule();
    if(currentScheduleView==="shift") renderShiftView();
    saveData();
  }

  function applyWeekdayToMonth(){
    const key = getMonthKey();
    const {empId, day} = ceContext;
    if(!empId || !day) return;

    const shift = document.getElementById("ceShift").value;
    const depot = document.getElementById("ceDepot").value;

    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const targetWD = new Date(appConfig.year, appConfig.month-1, day).getDay();

    for(let d=day; d<=numDays; d++){
      const wd = new Date(appConfig.year, appConfig.month-1, d).getDay();
      if(wd !== targetWD) continue;

      const existing = state.schedule[key]?.[empId]?.[d];
      if(existing && existing.shift==="VAC") continue;

      state.schedule[key][empId][d] = state.schedule[key][empId][d] || {shift:"", depot:""};
      state.schedule[key][empId][d].shift = shift;
      state.schedule[key][empId][d].depot = WORK_SHIFTS.includes(shift) ? (depot||"") : "";
    }

    closeCellEditor();
    renderSchedule();
    if(currentScheduleView==="shift") renderShiftView();
    saveData();
  }

  function closeCellEditor(){
    document.getElementById("cellEditorOverlay").style.display = "none";
    ceContext = {empId:null, day:null};
  }

  // =========================
  // Clear / Export
  // =========================
  function clearMonth(){
    if(confirm("Ù…Ø³Ø­ØŸ")){
      state.schedule[getMonthKey()] = {};
      renderSchedule();
      if(currentScheduleView==="shift") renderShiftView();
      saveData();
    }
  }

  function exportCSV(){
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    let csv = "\uFEFFEmployee,";
    for(let d=1; d<=numDays; d++) csv += `${d},`;
    csv += "\n";
    const data = state.schedule[getMonthKey()] || {};
    state.employees.forEach(e=>{
      csv += `"${e.name}",`;
      for(let d=1; d<=numDays; d++){
        const c = (data[e.id] && data[e.id][d]) || {};
        csv += `"${(c.shift||'')} ${(c.depot||'')}",`;
      }
      csv += "\n";
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "schedule.csv";
    a.click();
  }
</script>
</body>
</html>
