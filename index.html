<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¦Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ù„Ø¬Ø¯ÙˆÙ„Ø© (V12)</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --primary-light: #e0e7ff;
            --success: #10b981; --success-light: #d1fae5;
            --danger: #ef4444; --danger-light: #fee2e2;
            --warning: #f59e0b; --warning-light: #fef3c7;
            --bg: #f3f4f6; --surface: #ffffff;
            --text-main: #1f2937; --text-sub: #6b7280;
            --border: #e5e7eb;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text-main);
            font-size: 14px;
        }

        /* Layout */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .brand h1 { margin: 0; font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .brand p { margin: 0; font-size: 0.85rem; color: var(--text-sub); }

        .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        select, input {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Tajawal';
            font-weight: 600;
            background: #f9fafb;
            color: var(--text-main);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Tajawal';
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        button:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--bg); color: var(--text-main); }

        /* Tabs */
        .tabs {
            display: flex; gap: 10px;
            background: var(--surface); padding: 10px;
            border-radius: var(--radius); box-shadow: var(--shadow);
            overflow-x: auto;
        }
        .tab {
            padding: 10px 25px; border-radius: 8px; cursor: pointer;
            font-weight: 700; color: var(--text-sub); transition: 0.2s; white-space: nowrap;
        }
        .tab.active { background: var(--primary-light); color: var(--primary); }
        .tab:hover:not(.active) { background: var(--bg); }

        /* Views */
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Tables */
        .table-wrapper {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow-x: auto;
            border: 1px solid var(--border);
        }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th, td {
            padding: 10px; text-align: center;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            height: 50px;
        }
        th { background: #f8fafc; color: var(--text-main); font-weight: 800; position: sticky; top: 0; z-index: 20; }
        
        /* Sticky First Column */
        th:first-child, td:first-child {
            position: sticky; right: 0; z-index: 30;
            background: var(--surface); border-left: 2px solid var(--border);
            width: 200px; min-width: 200px; text-align: right; padding-right: 15px;
        }
        th:first-child { z-index: 40; background: #f8fafc; }

        /* Shift Cells */
        .cell { font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
        .cell:hover { opacity: 0.8; box-shadow: inset 0 0 0 2px var(--primary); }
        .shift-M { background-color: #fff7ed; color: #c2410c; }
        .shift-A { background-color: #eff6ff; color: #1d4ed8; }
        .shift-N { background-color: #1e293b; color: #f8fafc; }
        .shift-OFF { background-color: #ecfdf5; color: #047857; }
        .shift-VAC { background-color: #f3e8ff; color: #7e22ce; }
        .shift-X { background-color: #fef2f2; color: #b91c1c; }
        .depot-tag { display: block; font-size: 0.65rem; opacity: 0.8; margin-top: 2px; font-weight: normal; }

        /* Shift View Table Specifics */
        .names-cell { font-size: 0.85rem; line-height: 1.4; font-weight: 600; text-align: center; }
        .name-tag { display: inline-block; background: rgba(255,255,255,0.7); border-radius: 4px; padding: 2px 5px; margin: 1px; border: 1px solid rgba(0,0,0,0.05); }

        /* Dashboard Stats Table */
        .stats-table th { background: var(--primary-light); color: var(--primary); }
        .stats-val { font-weight: 800; font-size: 1rem; }
        .stats-sub { font-size: 0.9rem; color: var(--text-sub); }

        /* Config Panels */
        .config-panel { background: var(--surface); padding: 20px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid var(--border); }
        .config-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 15px; }

        /* Employee Cards */
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; border: 1px solid var(--border); }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .badge-rolling { background: var(--success-light); color: var(--success); }
        .badge-joker { background: var(--warning-light); color: var(--warning); }
        .badge-weekly { background: var(--primary-light); color: var(--primary); }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 3000; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Manual Editor */
        #cellEditorOverlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(2px); }
        #cellEditor { width: min(500px, 90vw); background: #fff; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); padding: 24px; }
        
        /* Flex Utils */
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .ce-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .ce-row > div { flex: 1; }
        .ce-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .small-input { width: 60px; text-align: center; }
        .flex-counts { display: flex; gap: 10px; justify-content: center; background: #f0fdf4; padding: 10px; border-radius: 8px; }
        .flex-counts div { display: flex; flex-direction: column; align-items: center; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h3 style="margin-top:20px; color:var(--text-main);">Ø£Ù‡Ù„Ø§ Ø³ÙŠÙŠÙŠÙŠØ¯Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ...</h3>
</div>

<div id="cellEditorOverlay" onclick="closeCellEditor(event)">
    <div id="cellEditor" onclick="event.stopPropagation()">
        <h3 id="ceTitle" style="margin-top:0; color:var(--text-main);">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØª</h3>
        <div class="ce-row">
            <div>
                <label style="display:block;margin-bottom:5px;font-weight:700;">Ø§Ù„Ø´ÙØª</label>
                <select id="ceShift" style="width:100%"></select>
            </div>
            <div>
                <label style="display:block;margin-bottom:5px;font-weight:700;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Depot)</label>
                <select id="ceDepot" style="width:100%"></select>
            </div>
        </div>
        <div class="ce-actions">
            <button class="btn-primary" style="justify-content:center;" onclick="saveCellEdit()">Ø­ÙØ¸ (ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯)</button>
            <div style="height:1px; background:#eee; margin:5px 0;"></div>
            <button class="btn-ghost" style="justify-content:center; color:var(--primary); border-color:var(--primary-light);" onclick="applyWeekdayForward()">ğŸ“Œ ØªØ«Ø¨ÙŠØª (Ù…Ù† Ø§Ù„ÙŠÙˆÙ… ÙˆØ·Ø§Ù„Ø¹)</button>
            <button class="btn-ghost" style="justify-content:center; color:var(--success); border-color:var(--success-light); background:var(--success-light);" onclick="applyWeekdayEntireMonth()">âœ… ØªØ«Ø¨ÙŠØª (ÙƒÙ„ Ø§Ù„Ø´Ù‡Ø±)</button>
            <div style="height:1px; background:#eee; margin:5px 0;"></div>
            <button class="btn-ghost" style="justify-content:center;" onclick="closeCellEditor()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-danger" style="justify-content:center;" onclick="clearCellEdit()">Ù…Ø³Ø­ Ø§Ù„Ø´ÙØª</button>
        </div>
    </div>
</div>

<div class="app-container">
    
    <div class="header">
        <div class="brand">
            <h1>ğŸ—“ï¸ Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¦Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ù„Ø¬Ø¯ÙˆÙ„Ø© </h1>
            <p>V12 - ØµÙ†Ø¹ Ø®ØµÙŠØµØ§Ù‹ Ù„Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙŠ</p>
        </div>
        <div class="actions">
            <select id="selYear"></select>
            <select id="selMonth"></select>
            <button class="btn-ghost" onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn-primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            <span id="lastUpdated" style="font-size:0.8rem; color:var(--text-sub);"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">ğŸ“… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <div class="tab" onclick="switchTab('shifts-view')">ğŸ—ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙØªØ§Øª</div>
        <div class="tab" onclick="switchTab('dashboard')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
        <div class="tab" onclick="switchTab('employees')">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <div class="tab" onclick="switchTab('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <div id="view-schedule" class="view active">
        <div class="config-panel" style="background: linear-gradient(to left, #e0e7ff, #ffffff); padding: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div>
                    <h3 style="margin:0; color:var(--primary);">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</h3>
                    <p style="margin:5px 0 0 0; font-size:0.9rem; color:var(--text-sub);">Ø§Ù„ØªÙˆØ²ÙŠØ¹ØŒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ ÙˆØ§Ù„ØªØµØ¯ÙŠØ±.</p>
                </div>
                <div class="actions">
                    <button class="btn-primary" onclick="generateScheduleV11()">âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª</button>
                    <button class="btn-success" onclick="fillDepots()">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
                    <button class="btn-danger" onclick="clearMonth()">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
                    <button class="btn-ghost" onclick="exportCSV()">ğŸ“„ Ø§ÙƒØ³Ù„</button>
                </div>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="scheduleGrid"></table>
        </div>
        <div id="coverageReport" class="config-panel" style="margin-top:20px;"></div>
    </div>

    <div id="view-shifts-view" class="view">
        <div class="config-panel">
            <h3 class="config-title">ğŸ—ï¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø´ÙØª ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹</h3>
            <p style="color:var(--text-sub);">ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† ÙŠØ¹Ù…Ù„ ÙÙŠ ÙƒÙ„ Ù…ÙˆÙ‚Ø¹ ÙˆØ´ÙØª ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù„ÙƒØ´Ù Ø§Ù„Ø¹Ø¬Ø² Ø¨ÙˆØ¶ÙˆØ­.</p>
        </div>
        <div class="table-wrapper">
            <table id="shiftsGrid"></table>
        </div>
    </div>

    <div id="view-dashboard" class="view">
        <div class="config-panel">
            <h3 class="config-title">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø± Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
            <div class="table-wrapper" style="box-shadow:none; border:none;">
                <table id="statsGrid" class="stats-table"></table>
            </div>
        </div>
    </div>

    <div id="view-employees" class="view">
        <div style="margin-bottom:20px;">
            <button class="btn-primary" onclick="addEmployee()">â• Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <div id="employeeList" class="grid-cards"></div>
    </div>

    <div id="view-settings" class="view">
        <div class="config-panel">
            <div class="config-title">ğŸ“ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</div>
            <input type="text" id="settingDepots" style="width:100%;" onchange="updateDepots()">
        </div>
        <div class="config-panel">
            <div class="config-title">ğŸ”¢ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
            <div id="requirementsContainer"></div>
        </div>
        <div class="config-panel" style="border-color:var(--danger-light);">
            <div class="config-title" style="color:var(--danger);">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</div>
            <button class="btn-danger" onclick="saveData(true)">ØªØµÙÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>
    </div>

</div>

<script>
    // ==========================================
    // === CONFIGURATION ===
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // â¬…ï¸âš ï¸ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ù‡Ù†Ø§
    
    // ==========================================
    // === STATE & CONSTANTS ===
    // ==========================================
    let state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } };
    let appConfig = { depots: ["Budaiya", "IsaTown"], year: new Date().getFullYear(), month: new Date().getMonth() + 1 };
    
    const SHIFTS = ["M", "A", "N", "OFF", "VAC", "X"];
    const WORK_SHIFTS = ["M", "A", "N"];
    const WEEKDAYS = ["Ø£Ø­Ø¯", "Ø§Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"];
    const MAX_CONSECUTIVE = 6; 

    // --- Manual Editor State ---
    let ceContext = { empId: null, day: null };

    // ==========================================
    // === SAFETY RULES ===
    // ==========================================
    function isShiftFlipViolation(prev, next) {
        if (!prev || ['OFF', 'X', 'VAC'].includes(prev)) return false;
        if (next === 'OFF' || next === 'X' || next === 'VAC') return false;
        if (prev === 'N') return (next === 'M' || next === 'A');
        if (prev === 'A') return (next === 'M');
        return false;
    }

    // ==========================================
    // === INITIALIZATION ===
    // ==========================================
    window.onload = () => { initDateSelectors(); loadData(); };

    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const curr = new Date().getFullYear();
        for(let y=curr-1; y<=curr+2; y++) ySel.add(new Option(y, y));
        ySel.value = curr;
        ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"].forEach((m, i) => mSel.add(new Option(m, i+1)));
        mSel.value = new Date().getMonth()+1;
        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderAllViews(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderAllViews(); };
    }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${t}`).classList.add('active');
    }

    function renderAllViews() {
        renderSchedule();
        renderShiftsView(); // New
        renderDashboard();  // New
        renderEmployees();
        renderRequirementsTable();
    }

    // ==========================================
    // === API HANDLER ===
    // ==========================================
    async function loadData() {
        showLoader(true);
        try {
            const res = await fetch(`${API_URL}?action=load`);
            const json = await res.json();
            if(json.ok) {
                const data = json.data || {};
                state.employees = data.employees || [];
                state.schedule = data.schedule || {};
                state.meta = data.meta || { requirements: {}, depots: [] };
                if(state.meta.depots && state.meta.depots.length) appConfig.depots = state.meta.depots;
                document.getElementById('settingDepots').value = appConfig.depots.join(', ');

                // Normalize Data
                state.employees.forEach(emp => {
                    if(!emp.id) emp.id = 'emp_' + Math.random().toString(36).substr(2, 9);
                    if(!emp.patternType) emp.patternType = 'weekly';
                    if(!emp.weeklyTemplate) emp.weeklyTemplate = Array(7).fill("M");
                    if(!emp.flexCounts) emp.flexCounts = { M: 1, A: 2, N: 2, OFF: 2 };
                    if(!emp.depotQuotas) emp.depotQuotas = {};
                    if(!emp.vacationDates) emp.vacationDates = "";
                });

                // Fix Req
                const reqs = state.meta.requirements;
                for(let d in reqs) {
                    if(reqs[d].D !== undefined) {
                        reqs[d].M = reqs[d].D; reqs[d].A = reqs[d].EN; reqs[d].N = reqs[d].LN;
                        delete reqs[d].D; delete reqs[d].EN; delete reqs[d].LN;
                    }
                }

                renderAllViews();
                if(state.meta.updatedAt) document.getElementById('lastUpdated').innerText = "Ø¢Ø®Ø± Ø­ÙØ¸: " + new Date(state.meta.updatedAt).toLocaleTimeString();
            }
        } catch(e) { console.error(e); alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„."); } finally { showLoader(false); }
    }

    async function saveData(reset = false) {
        showLoader(true);
        if(reset && !confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) { showLoader(false); return; }
        if(reset) state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } };
        state.meta.depots = appConfig.depots;
        state.meta.updatedAt = new Date().toISOString();
        try {
            await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "save", payload: { employees: state.employees, schedule: state.schedule, meta: state.meta } }) });
            if(reset) { document.getElementById('settingDepots').value = "Budaiya, IsaTown"; renderAllViews(); }
            document.getElementById('lastUpdated').innerText = "Ø¢Ø®Ø± Ø­ÙØ¸: " + new Date().toLocaleTimeString();
        } catch(e) { alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸."); } finally { showLoader(false); }
    }

    // ==========================================
    // === MANUAL EDITOR LOGIC ===
    // ==========================================
    function openCellEditor(empId, day) {
        ceContext = { empId, day };
        const emp = state.employees.find(e => e.id === empId);
        const key = getMonthKey();
        
        if(!state.schedule[key]) state.schedule[key] = {};
        if(!state.schedule[key][empId]) state.schedule[key][empId] = {};
        
        const cell = state.schedule[key][empId][day] || { shift: "OFF", depot: "" };
        const dayName = WEEKDAYS[new Date(appConfig.year, appConfig.month - 1, day).getDay()];
        document.getElementById('ceTitle').innerText = `ØªØ¹Ø¯ÙŠÙ„: ${emp.name} | ÙŠÙˆÙ… ${day} (${dayName})`;
        
        const shiftSel = document.getElementById('ceShift');
        shiftSel.innerHTML = SHIFTS.map(s => `<option value="${s}">${s}</option>`).join('');
        shiftSel.value = cell.shift || 'OFF';
        
        const depotSel = document.getElementById('ceDepot');
        depotSel.innerHTML = `<option value="">--</option>` + appConfig.depots.map(d => `<option value="${d}">${d}</option>`).join('');
        depotSel.value = cell.depot || '';

        document.getElementById('cellEditorOverlay').style.display = 'flex';
    }

    function closeCellEditor(e) {
        if (e && e.target.id !== 'cellEditorOverlay') return; 
        document.getElementById('cellEditorOverlay').style.display = 'none';
        ceContext = { empId: null, day: null };
    }

    function saveCellEdit() {
        const { empId, day } = ceContext;
        if (!empId) return;
        
        const shift = document.getElementById('ceShift').value;
        const depot = document.getElementById('ceDepot').value;
        const key = getMonthKey();
        
        state.schedule[key][empId][day] = { shift: shift, depot: (WORK_SHIFTS.includes(shift) ? depot : "") };
        
        renderAllViews();
        closeCellEditor(); 
        saveData(); 
    }

    function clearCellEdit() {
        const { empId, day } = ceContext;
        if (!empId) return;
        const key = getMonthKey();
        state.schedule[key][empId][day] = { shift: "OFF", depot: "" };
        renderAllViews();
        closeCellEditor();
        saveData();
    }

    function applyWeekdayForward() {
        const { empId, day } = ceContext;
        if (!empId) return;
        const shift = document.getElementById('ceShift').value;
        const depot = document.getElementById('ceDepot').value;
        const key = getMonthKey();
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const targetWeekday = new Date(appConfig.year, appConfig.month - 1, day).getDay();

        for(let d = day; d <= numDays; d++) {
            const currentWeekday = new Date(appConfig.year, appConfig.month - 1, d).getDay();
            if(currentWeekday === targetWeekday) {
                const currentCell = state.schedule[key][empId][d];
                if(currentCell && currentCell.shift === 'VAC') continue;
                state.schedule[key][empId][d] = { shift: shift, depot: (WORK_SHIFTS.includes(shift) ? depot : "") };
            }
        }
        renderAllViews(); closeCellEditor(); saveData();
    }

    function applyWeekdayEntireMonth() {
        const { empId, day } = ceContext;
        if (!empId) return;
        const shift = document.getElementById('ceShift').value;
        const depot = document.getElementById('ceDepot').value;
        const key = getMonthKey();
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const targetWeekday = new Date(appConfig.year, appConfig.month - 1, day).getDay();

        for(let d = 1; d <= numDays; d++) {
            const currentWeekday = new Date(appConfig.year, appConfig.month - 1, d).getDay();
            if(currentWeekday === targetWeekday) {
                const currentCell = state.schedule[key][empId] && state.schedule[key][empId][d];
                if(currentCell && currentCell.shift === 'VAC') continue;
                if(!state.schedule[key][empId]) state.schedule[key][empId] = {};
                state.schedule[key][empId][d] = { shift: shift, depot: (WORK_SHIFTS.includes(shift) ? depot : "") };
            }
        }
        renderAllViews(); closeCellEditor(); saveData();
    }

    // ==========================================
    // === VIEW 2: SHIFTS VIEW (New) ===
    // ==========================================
    function renderShiftsView() {
        const grid = document.getElementById('shiftsGrid');
        if (!grid) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const key = getMonthKey();
        const sched = state.schedule[key] || {};
        const depots = appConfig.depots;

        // Build Header
        let html = `<thead><tr><th>Ø§Ù„Ø´ÙØª - Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>`;
        for (let d = 1; d <= numDays; d++) {
            const date = new Date(appConfig.year, appConfig.month - 1, d);
            const isWeekend = (date.getDay() === 5 || date.getDay() === 6);
            html += `<th style="${isWeekend ? 'background:#e0e7ff;' : ''}">${d}<br><small>${WEEKDAYS[date.getDay()]}</small></th>`;
        }
        html += `</tr></thead><tbody>`;

        // Build Rows: For each Shift (M, A, N), iterate depots
        WORK_SHIFTS.forEach(shift => {
            depots.forEach(depot => {
                let rowHtml = `<tr><td style="font-weight:700; text-align:right;">
                    <span class="cell shift-${shift}" style="padding:2px 6px; border-radius:4px;">${shift}</span> ${depot}
                </td>`;
                
                for (let d = 1; d <= numDays; d++) {
                    // Find employees working this Shift & Depot
                    let workers = [];
                    state.employees.forEach(emp => {
                        let cell = sched[emp.id] && sched[emp.id][d];
                        if (cell && cell.shift === shift && cell.depot === depot) {
                            workers.push(emp.name);
                        }
                    });
                    
                    let cellContent = workers.map(w => `<span class="name-tag">${w}</span>`).join('<br>');
                    let bg = (workers.length > 0) ? `shift-${shift}` : '';
                    rowHtml += `<td class="names-cell ${bg}" style="vertical-align:top;">${cellContent}</td>`;
                }
                rowHtml += `</tr>`;
                html += rowHtml;
            });
        });
        html += `</tbody>`;
        grid.innerHTML = html;
    }

    // ==========================================
    // === VIEW 3: DASHBOARD (New) ===
    // ==========================================
    function renderDashboard() {
        const grid = document.getElementById('statsGrid');
        if (!grid) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const key = getMonthKey();
        const sched = state.schedule[key] || {};
        const depots = appConfig.depots;

        // Header
        let html = `<thead><tr>
            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
            <th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</th>
            <th>M</th><th>A</th><th>N</th>
            <th>OFF</th><th>VAC</th>`;
        depots.forEach(d => html += `<th>${d}</th>`);
        html += `</tr></thead><tbody>`;

        state.employees.forEach(emp => {
            let stats = { work: 0, M: 0, A: 0, N: 0, OFF: 0, VAC: 0, X: 0 };
            let depotStats = {};
            depots.forEach(d => depotStats[d] = 0);

            for (let d = 1; d <= numDays; d++) {
                let cell = sched[emp.id] && sched[emp.id][d];
                let s = cell ? cell.shift : 'OFF';
                let dep = cell ? cell.depot : '';

                if (stats[s] !== undefined) stats[s]++;
                if (WORK_SHIFTS.includes(s)) {
                    stats.work++;
                    if (dep && depotStats[dep] !== undefined) depotStats[dep]++;
                }
            }

            html += `<tr>
                <td style="font-weight:700; text-align:right;">${emp.name}</td>
                <td class="stats-val">${stats.work}</td>
                <td>${stats.M}</td>
                <td>${stats.A}</td>
                <td>${stats.N}</td>
                <td>${stats.OFF}</td>
                <td>${stats.VAC}</td>`;
            
            depots.forEach(d => {
                html += `<td>${depotStats[d]}</td>`;
            });
            html += `</tr>`;
        });
        html += `</tbody>`;
        grid.innerHTML = html;
    }

    // ==========================================
    // === ALGORITHM (V11.5) ===
    // ==========================================
    function generateScheduleV11() {
        if(!confirm("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹ (V11.5)ØŸ\nØ³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù…Ø¹ ØªØ´ØªÙŠØª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª.")) return;
        showLoader(true);
        setTimeout(() => {
            try {
                const key = getMonthKey();
                const numDays = daysInMonth(appConfig.year, appConfig.month);
                if(!state.schedule[key]) state.schedule[key] = {};
                const sched = state.schedule[key];
                
                state.employees.forEach(e => { if(!sched[e.id]) sched[e.id] = {}; });
                
                applyVacations(numDays, sched);
                
                const dailyNeeds = calculateDailyNeeds(numDays);
                const workStreaks = {};
                const empPrevShift = {};
                state.employees.forEach(emp => { workStreaks[emp.id] = 0; empPrevShift[emp.id] = 'OFF'; });

                applyFixedEmployees(numDays, sched, dailyNeeds, workStreaks, empPrevShift);

                const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
                const jokerEmps = state.employees.filter(e => e.patternType === 'joker');

                const rollingOffMap = {};
                rollingEmps.forEach((e, idx) => {
                    rollingOffMap[e.id] = [];
                    let d1 = (idx % 7) + 1;
                    let d2 = ((idx + 3) % 7) + 1;
                    for(let x=1; x<=numDays; x++) {
                        let dw = (x-1)%7 + 1;
                        if(dw === d1 || dw === d2) rollingOffMap[e.id].push(x);
                    }
                });

                const jokerOffMap = {};
                jokerEmps.forEach((e, idx) => {
                    jokerOffMap[e.id] = [];
                    let d1 = (idx % 7) + 1;
                    for(let x=d1; x<=numDays; x+=7) jokerOffMap[e.id].push(x);
                });

                let currentDay = 1;
                while(currentDay <= numDays) {
                    let weekEnd = Math.min(currentDay + 6 - new Date(appConfig.year, appConfig.month-1, currentDay).getDay(), numDays);
                    let daysInWeek = [];
                    for(let i=currentDay; i<=weekEnd; i++) daysInWeek.push(i);

                    if(new Date(appConfig.year, appConfig.month-1, currentDay).getDay() === 0 || currentDay === 1) {
                        rollingEmps.forEach(e => {
                            let f = e.flexCounts || {M:1,A:2,N:2,OFF:2};
                            e._bucket = { ...f };
                        });
                    }

                    daysInWeek.forEach(d => {
                        let todaysNeeds = dailyNeeds[d];
                        let rollingList = [...rollingEmps].sort(() => Math.random() - 0.5);
                        let jokerList = [...jokerEmps].sort(() => Math.random() - 0.5);

                        rollingList.forEach(emp => {
                            if(isAssigned(emp, d, sched)) return;
                            let prev = empPrevShift[emp.id];
                            let bucket = emp._bucket;
                            let streak = workStreaks[emp.id] || 0;
                            
                            let isScheduledOff = rollingOffMap[emp.id].includes(d);
                            let assigned = 'OFF';
                            let canM = !isShiftFlipViolation(prev, 'M');
                            let canA = !isShiftFlipViolation(prev, 'A');
                            let canN = !isShiftFlipViolation(prev, 'N');

                            if(streak >= MAX_CONSECUTIVE || (isScheduledOff && bucket.OFF > 0)) {
                                assigned = 'OFF';
                                if(isScheduledOff && bucket.OFF > 0) bucket.OFF--;
                            } else {
                                if(todaysNeeds.M > 0 && canM) { assigned='M'; bucket.M--; }
                                else if(todaysNeeds.A > 0 && canA) { assigned='A'; bucket.A--; }
                                else if(todaysNeeds.N > 0 && canN) { assigned='N'; bucket.N--; }
                                else if(bucket.M > 0 && canM) { assigned='M'; bucket.M--; }
                                else if(bucket.A > 0 && canA) { assigned='A'; bucket.A--; }
                                else if(bucket.N > 0 && canN) { assigned='N'; bucket.N--; }
                                else {
                                    if(canN) assigned='N'; else if(canA) assigned='A'; else if(canM) assigned='M';
                                }
                            }

                            if(assigned !== 'OFF') {
                                if(todaysNeeds[assigned] > 0) todaysNeeds[assigned]--;
                                workStreaks[emp.id]++;
                            } else workStreaks[emp.id]=0;
                            
                            assignShift(emp, d, assigned, sched, empPrevShift);
                        });

                        jokerList.forEach(emp => {
                            if(isAssigned(emp, d, sched)) return;
                            let prev = empPrevShift[emp.id];
                            let streak = workStreaks[emp.id] || 0;
                            let isScheduledOff = jokerOffMap[emp.id].includes(d);
                            let assigned = 'OFF';

                            if(isScheduledOff || streak >= MAX_CONSECUTIVE) {
                                assigned = 'OFF';
                            } else {
                                let canM = !isShiftFlipViolation(prev, 'M');
                                let canA = !isShiftFlipViolation(prev, 'A');
                                let canN = !isShiftFlipViolation(prev, 'N');

                                if(todaysNeeds.N > 0 && canN) assigned = 'N';
                                else if(todaysNeeds.A > 0 && canA) assigned = 'A';
                                else if(todaysNeeds.M > 0 && canM) assigned = 'M';
                                else {
                                    if(canN) assigned='N'; else if(canA) assigned='A'; else if(canM) assigned='M';
                                }
                            }

                            if(assigned !== 'OFF') {
                                if(todaysNeeds[assigned] > 0) todaysNeeds[assigned]--;
                                workStreaks[emp.id]++;
                            } else workStreaks[emp.id]=0;
                            
                            assignShift(emp, d, assigned, sched, empPrevShift);
                        });
                    });
                    currentDay = daysInWeek[daysInWeek.length-1] + 1;
                }

                state.employees.forEach(e => {
                    let p = 'OFF';
                    for(let d=1; d<=numDays; d++) {
                        let c = sched[e.id][d];
                        if(c && c.shift) {
                            if(isShiftFlipViolation(p, c.shift)) c.shift = 'OFF';
                            p = c.shift;
                        }
                    }
                });

                renderAllViews(); saveData(); showLoader(false);
                alert("âœ… ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
            } catch(e) { console.error(e); showLoader(false); alert("Ø®Ø·Ø£: " + e.message); }
        }, 100);
    }

    // --- HELPERS ---
    function isAssigned(emp, d, sched) { return !!(sched[emp.id] && sched[emp.id][d]); }
    function assignShift(emp, d, s, sched, prevs) {
        sched[emp.id][d] = { shift: s, depot: "" };
        prevs[emp.id] = s;
    }
    function applyVacations(numDays, sched) {
        state.employees.forEach(emp => {
            if(emp.vacationDates) emp.vacationDates.split(',').map(d=>parseInt(d.trim())).filter(d=>!isNaN(d)).forEach(d => { if(d<=numDays) sched[emp.id][d] = { shift: 'VAC', depot: '' }; });
        });
    }
    function calculateDailyNeeds(numDays) {
        const needs = {};
        const depots = appConfig.depots.map(d=>d.trim());
        const reqs = state.meta.requirements || {};
        for(let d=1; d<=numDays; d++) {
            needs[d] = { M:0, A:0, N:0 };
            depots.forEach(dep => { const r = reqs[dep] || {}; needs[d].M += (r.M||0); needs[d].A += (r.A||0); needs[d].N += (r.N||0); });
        }
        return needs;
    }
    function applyFixedEmployees(numDays, sched, dailyNeeds, streaks, prevs) {
        state.employees.filter(e => e.patternType === 'weekly').forEach(emp => {
            for(let d=1; d<=numDays; d++) {
                if(isAssigned(emp, d, sched)) { prevs[emp.id]='VAC'; streaks[emp.id]=0; continue; }
                const dayOfWeek = new Date(appConfig.year, appConfig.month-1, d).getDay();
                let shift = emp.weeklyTemplate[dayOfWeek];
                const prev = prevs[emp.id];
                if(isShiftFlipViolation(prev, shift) || (streaks[emp.id] >= MAX_CONSECUTIVE && ['M','A','N'].includes(shift))) shift = 'OFF';
                assignShift(emp, d, shift, sched, prevs);
                if(['M','A','N'].includes(shift) && dailyNeeds[d][shift]>0) dailyNeeds[d][shift]--;
                if(['M','A','N'].includes(shift)) streaks[emp.id]++; else streaks[emp.id]=0;
            }
        });
    }

    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        if(!sched || !confirm("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ØŸ")) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const depots = appConfig.depots.map(d=>d.trim());

        for(let d=1; d<=numDays; d++) {
            state.employees.forEach(e => { if(sched[e.id][d] && ['M','A','N'].includes(sched[e.id][d].shift)) sched[e.id][d].depot = ""; });
        }

        for(let d=1; d<=numDays; d++) {
            const counts = {}; depots.forEach(dp=>counts[dp]={M:0,A:0,N:0});
            const workers = {M:[],A:[],N:[]};
            state.employees.forEach(e => {
                let s = sched[e.id][d].shift;
                if(['M','A','N'].includes(s)) workers[s].push(e);
            });
            ['M','A','N'].forEach(s => {
                let list = workers[s];
                list.sort((a,b) => ((b.depotQuotas[depots[0]]||0) - (a.depotQuotas[depots[0]]||0))); 
                depots.forEach(dep => {
                    let need = (reqs[dep]||{})[s] || 0;
                    let i = 0;
                    while(i<list.length && counts[dep][s] < need) {
                        let e = list[i];
                        if(!sched[e.id][d].depot) { sched[e.id][d].depot = dep; counts[dep][s]++; }
                        i++;
                    }
                });
                list.forEach(e => {
                    if(!sched[e.id][d].depot) {
                        let target = depots.reduce((a,b)=>counts[a][s]<counts[b][s]?a:b);
                        sched[e.id][d].depot = target; counts[target][s]++;
                    }
                });
            });
        }
        renderAllViews(); saveData();
    }

    // --- OTHER RENDERS ---
    function renderRequirementsTable() {
        const container = document.getElementById('requirementsContainer');
        if(!container) return;
        if(!state.meta.requirements) state.meta.requirements = {};
        
        let html = `<table style="width:100%; border-collapse:collapse;">
            <tr style="background:#f3f4f6;"><th style="text-align:right;">Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>M</th><th>A</th><th>N</th></tr>`;
        
        appConfig.depots.forEach(d => {
            let r = (state.meta.requirements && state.meta.requirements[d]) || {M:0,A:0,N:0};
            html += `<tr>
                <td style="font-weight:700; padding:10px;">${d}</td>
                <td style="text-align:center;"><input type="number" class="small-input" value="${r.M||0}" onchange="updReq('${d}','M',this.value)"></td>
                <td style="text-align:center;"><input type="number" class="small-input" value="${r.A||0}" onchange="updReq('${d}','A',this.value)"></td>
                <td style="text-align:center;"><input type="number" class="small-input" value="${r.N||0}" onchange="updReq('${d}','N',this.value)"></td>
            </tr>`;
        });
        container.innerHTML = html + `</table>`;
    }
    function updReq(d,s,v) { if(!state.meta.requirements[d]) state.meta.requirements[d]={}; state.meta.requirements[d][s]=parseInt(v)||0; }

    function renderEmployees() {
        const list = document.getElementById('employeeList'); list.innerHTML = "";
        state.employees.forEach(e => {
            const div = document.createElement('div'); div.className = "card";
            
            // Generate Weekly Selects
            let weekHtml = "<div style='display:grid; grid-template-columns:repeat(7,1fr); gap:5px;'>";
            WEEKDAYS.forEach((day,i) => {
                const opts = SHIFTS.filter(x=>!['VAC','X'].includes(x)).map(s=>`<option ${e.weeklyTemplate[i]===s?'selected':''}>${s}</option>`).join('');
                weekHtml += `<div style="text-align:center;"><small>${day}</small><select style="width:100%; padding:5px;" onchange="updEmpWeek('${e.id}',${i},this.value)">${opts}</select></div>`;
            });
            weekHtml += "</div>";

            let patternHtml = "";
            let badgeClass = "";
            let patternName = "";

            if(e.patternType === 'rolling') {
                badgeClass = "badge-rolling"; patternName = "Ø´ÙØª Ø¯ÙˆØ§Ø±";
                patternHtml = `<div class="flex-counts">
                        <div><label>M</label><input class="small-input" type="number" value="${e.flexCounts.M}" onchange="updFlex('${e.id}','M',this.value)"></div>
                        <div><label>A</label><input class="small-input" type="number" value="${e.flexCounts.A}" onchange="updFlex('${e.id}','A',this.value)"></div>
                        <div><label>N</label><input class="small-input" type="number" value="${e.flexCounts.N}" onchange="updFlex('${e.id}','N',this.value)"></div>
                        <div><label>OFF</label><input class="small-input" type="number" value="${e.flexCounts.OFF}" onchange="updFlex('${e.id}','OFF',this.value)"></div>
                    </div>`;
            } else if(e.patternType === 'joker') {
                badgeClass = "badge-joker"; patternName = "Ø¬ÙˆÙƒØ±";
                patternHtml = `<div style="text-align:center; color:#d97706; font-weight:700; background:#fffbeb; padding:10px; border-radius:8px;">ğŸƒ 6 Ø¹Ù…Ù„ + 1 Ø±Ø§Ø­Ø©</div>`;
            } else {
                badgeClass = "badge-weekly"; patternName = "Ø´ÙØª Ø«Ø§Ø¨Øª";
                patternHtml = weekHtml;
            }

            let quotasHtml = `<div style="display:flex; gap:10px; flex-wrap:wrap;">`;
            appConfig.depots.forEach(d => {
                quotasHtml += `<div style="display:flex; flex-direction:column; align-items:center;"><small>${d}</small><input class="small-input" type="number" value="${(e.depotQuotas&&e.depotQuotas[d])||0}" onchange="updQuota('${e.id}','${d}',this.value)"></div>`;
            });
            quotasHtml += `</div>`;

            div.innerHTML = `
                <div class="card-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="text" value="${e.name}" onchange="updEmp('${e.id}','name',this.value)" style="border:none; font-size:1.1rem; font-weight:800; width:150px;">
                        <span class="badge ${badgeClass}">${patternName}</span>
                    </div>
                    <button class="btn-ghost" style="color:var(--danger);" onclick="delEmp('${e.id}')">âœ•</button>
                </div>
                <div class="card-body">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ§Ù…:</label>
                        <select onchange="updEmp('${e.id}','patternType',this.value)">
                            <option value="weekly" ${e.patternType==='weekly'?'selected':''}>Ø«Ø§Ø¨Øª</option>
                            <option value="rolling" ${e.patternType==='rolling'?'selected':''}>Ø¯ÙˆØ§Ø±</option>
                            <option value="joker" ${e.patternType==='joker'?'selected':''}>Ø¬ÙˆÙƒØ±</option>
                        </select>
                    </div>
                    <div style="border-top:1px solid #eee; padding-top:10px;">${patternHtml}</div>
                    <div style="border-top:1px solid #eee; padding-top:10px;">
                        <label style="display:block; margin-bottom:5px; font-size:0.8rem; color:var(--text-sub);">Ø­ØµØµ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:</label>
                        ${quotasHtml}
                    </div>
                    <div style="border-top:1px solid #eee; padding-top:10px;">
                        <label style="display:block; margin-bottom:5px; font-size:0.8rem; color:var(--text-sub);">Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø­Ø¯Ø¯Ø© (VAC):</label>
                        <input type="text" style="width:100%;" placeholder="Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£ÙŠØ§Ù…: 5, 12" value="${e.vacationDates||''}" onchange="updVac('${e.id}',this.value)">
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        if(!grid) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = state.schedule[getMonthKey()] || {};
        let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
        for(let d=1; d<=numDays; d++) {
            const date = new Date(appConfig.year, appConfig.month-1, d);
            const isWeekend = (date.getDay()===5 || date.getDay()===6);
            html += `<th style="${isWeekend?'background:#f1f5f9;':''}">${d}<br><small>${WEEKDAYS[date.getDay()]}</small></th>`;
        }
        html += `</tr></thead><tbody>`;
        state.employees.forEach(e => {
            let row = `<tr><td class="emp-col">${e.name}</td>`;
            let prev='OFF';
            for(let d=1; d<=numDays; d++) {
                let c = (data[e.id] && data[e.id][d]) || {shift:''};
                let s = c.shift||'';
                let v = isShiftFlipViolation(prev, s) ? 'violation' : '';
                row += `<td class="cell shift-${s} ${v}" onclick="openCellEditor('${e.id}', ${d})">
                    ${s}${c.depot?`<span class="depot-tag">${c.depot}</span>`:''}</td>`;
                if(['M','A','N','VAC','X'].includes(s)) prev=s; else prev='OFF';
            }
            html += row + `</tr>`;
        });
        grid.innerHTML = html + `</tbody>`;
        analyzeCoverage();
    }

    // --- UTILS ---
    function updEmp(id,k,v){ let e=state.employees.find(x=>x.id===id); if(e){e[k]=v; if(k==='patternType') renderEmployees();} }
    function updEmpWeek(id,i,v){ state.employees.find(x=>x.id===id).weeklyTemplate[i]=v; }
    function updFlex(id,k,v){ let e=state.employees.find(x=>x.id===id); if(!e.flexCounts) e.flexCounts={}; e.flexCounts[k]=parseInt(v); }
    function updQuota(id,k,v){ let e=state.employees.find(x=>x.id===id); if(!e.depotQuotas) e.depotQuotas={}; e.depotQuotas[k]=parseInt(v); }
    function updVac(id,v){ state.employees.find(x=>x.id===id).vacationDates=v; }
    function addEmployee(){ state.employees.push({id:'e'+Math.random().toString(36).substr(2,9), name:'Ø¬Ø¯ÙŠØ¯', patternType:'weekly', weeklyTemplate:Array(7).fill('M'), flexCounts:{M:1,A:2,N:2,OFF:2}, depotQuotas:{}, vacationDates:""}); renderEmployees(); }
    function delEmp(id){ if(confirm('Ø­Ø°ÙØŸ')) { state.employees=state.employees.filter(x=>x.id!==id); renderAllViews(); saveData(); } }
    function updateDepots() { appConfig.depots = document.getElementById('settingDepots').value.split(',').map(s=>s.trim()).filter(s=>s); renderAllViews(); }
    function getMonthKey() { return `${appConfig.year}-${appConfig.month}`; }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    function clearMonth() { if(confirm('Ù…Ø³Ø­ØŸ')) { state.schedule[getMonthKey()] = {}; renderAllViews(); saveData(); } }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        let csv = "\uFEFFM,";
        for(let d=1; d<=numDays; d++) csv += `${d},`; csv += "\n";
        let data = state.schedule[getMonthKey()] || {};
        state.employees.forEach(e => {
            csv += `"${e.name}",`;
            for(let d=1; d<=numDays; d++) {
                let c = (data[e.id] && data[e.id][d]) || {};
                csv += `"${c.shift||''} ${c.depot||''}",`;
            }
            csv += "\n";
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'schedule.csv'; a.click();
    }

    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        if(!report) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = state.schedule[getMonthKey()] || {};
        const depots = appConfig.depots.map(d=>d.trim());
        const reqs = state.meta.requirements || {};
        let issues = [];
        
        for(let d=1; d<=numDays; d++) {
            let counts = {}; depots.forEach(dp=>counts[dp]={M:0,A:0,N:0});
            state.employees.forEach(e => {
                let c = sched[e.id] && sched[e.id][d];
                if(c && c.depot && ['M','A','N'].includes(c.shift)) counts[c.depot.trim()][c.shift]++;
            });
            depots.forEach(dep => {
                let r = reqs[dep] || {};
                ['M','A','N'].forEach(s => {
                    let req = r[s]||0;
                    let act = counts[dep][s]||0;
                    if(act < req) issues.push(`âš ï¸ ÙŠÙˆÙ… ${d} (${dep} - ${s}): Ù…Ø·Ù„ÙˆØ¨ ${req}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${act}`);
                });
            });
        }
        
        if(issues.length === 0) report.innerHTML = `<div class="report-ok">âœ… Ø§Ù„ØªØºØ·ÙŠØ© Ù…Ù…ØªØ§Ø²Ø© 100%</div>`;
        else report.innerHTML = issues.map(i=>`<div class="report-err">${i}</div>`).join('');
    }
</script>
</body>
</html>



