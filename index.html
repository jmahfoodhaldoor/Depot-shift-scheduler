<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© (Ù†Ø³Ø®Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦)</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #cbd5e1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg); font-size: 14px; direction: rtl; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; margin-left: auto; color: #dc2626; }
        button { cursor: pointer; padding: 8px 15px; border: 1px solid var(--border); background: white; border-radius: 5px; font-weight: bold; }
        button:hover { background: #f1f5f9; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.danger { background: #ef4444; color: white; border-color: #ef4444; }
        input, select { padding: 8px; border: 1px solid var(--border); border-radius: 5px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }
        .view { display: none; }
        .view.active { display: block; }
        .grid-container { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid var(--border); }
        .schedule-table { border-collapse: collapse; width: 100%; min-width: 1000px; }
        .schedule-table th, .schedule-table td { border: 1px solid #e2e8f0; text-align: center; padding: 5px; height: 35px; }
        .schedule-table th { background: #f1f5f9; position: sticky; top: 0; }
        .schedule-table th.emp-col { position: sticky; right: 0; z-index: 20; background: #f1f5f9; width: 160px; }
        .schedule-table td.emp-col { position: sticky; right: 0; z-index: 5; background: white; font-weight: bold; }
        .cell { cursor: pointer; font-size: 0.85rem; user-select: none; }
        .cell.shift-D { background-color: #dbeafe; color: #1e40af; } 
        .cell.shift-EN { background-color: #fef3c7; color: #92400e; } 
        .cell.shift-LN { background-color: #1e293b; color: #f8fafc; } 
        .cell.shift-OFF { background-color: #f0fdf4; color: #166534; } 
        .cell.shift-X { background-color: #fef2f2; color: #991b1b; } 
        .violation { border: 3px solid #ef4444 !important; }
        .emp-card { border: 1px solid var(--border); background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .pattern-editor { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px dashed #cbd5e1; margin-top: 10px; }
        .flex-counts { display: flex; gap: 10px; flex-wrap: wrap; }
        .depot-quotas { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .depot-quotas div { background: #fff7ed; padding: 5px; border: 1px solid #ffedd5; border-radius: 4px; }
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; font-weight: bold; color: var(--primary); display: none; }
        .report-box { margin-top: 20px; padding: 15px; background: white; border: 1px solid var(--border); border-radius: 8px; }
        .report-item { margin-bottom: 5px; padding: 5px; background: #fff1f2; color: #9f1239; border-radius: 4px; }
        .report-ok { background: #ecfdf5; color: #065f46; padding: 10px; text-align: center; font-weight: bold; }
        .alert-box { background: #fef3c7; border: 2px solid #fbbf24; padding: 12px; border-radius: 6px; margin: 10px 0; color: #92400e; font-weight: 500; }
    </style>
</head>
<body>

<div id="loader">
    <div style="font-size: 2rem;">ğŸ› ï¸</div>
    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
</div>

<div class="app-container">
    <div class="toolbar">
        <h1>ğŸ—“ï¸ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ (Ù†Ø³Ø®Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦)</h1>
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <button onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        <div style="flex-grow:1; text-align:left; font-size:0.8rem; color:gray;">
             <span id="lastUpdated"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>
        <div class="tab" onclick="switchTab('employees')">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <div class="tab" onclick="switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <div id="view-schedule" class="view active">
        <div class="alert-box">
            âš™ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨ÙˆØ¶Ø¹ Ø§Ù„Ø£Ù…Ø§Ù†. Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´Ø§ÙƒÙ„ØŒ Ø§Ø¶ØºØ· "ØªØµÙÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.
        </div>
        <div class="toolbar" style="background:transparent; padding:0; box-shadow:none; justify-content:space-between;">
            <div>
                <button onclick="runSmartOptimizer()" class="primary">âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª (Ù…Ø­Ø³Ù†)</button>
                <button onclick="fillDepots()">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
            </div>
            <div>
                <button onclick="clearMonth()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ù‡Ø±</button>
                <button onclick="exportCSV()">ğŸ“„ Excel</button>
            </div>
        </div>
        <div class="grid-container">
            <table class="schedule-table" id="scheduleGrid"></table>
        </div>
        <div id="coverageReport" class="report-box"></div>
    </div>

    <div id="view-employees" class="view">
        <button class="primary" onclick="addEmployee()" style="margin-bottom: 15px;">+ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
        <div id="employeeList"></div>
    </div>

    <div id="view-settings" class="view">
        <div class="emp-card">
            <h3>1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
            <input type="text" id="settingDepots" style="width: 100%;" onchange="updateDepots()">
        </div>
        <div class="emp-card">
            <h3>2. Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ ÙƒÙ„ Ù…ÙˆÙ‚Ø¹</h3>
            <div id="requirementsContainer"></div>
        </div>
        <div class="emp-card">
            <h3>3. Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h3>
            <button class="danger" onclick="saveData(true)">âš ï¸ ØªØµÙÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„)</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // <--- âš ï¸ Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§
    
    // --- STATE INITIALIZATION (SAFE) ---
    let state = { 
        employees: [], 
        schedule: {}, 
        meta: { requirements: {}, depots: [] } 
    };
    let appConfig = { depots: ["Main"], year: new Date().getFullYear(), month: new Date().getMonth() + 1 };
    const SHIFTS = ["D", "EN", "LN", "OFF", "X"];
    const WEEKDAYS = ["Ø£Ø­Ø¯", "Ø§Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"];

    // --- HELPER: Shift Flip Check ---
    function isShiftFlipViolation(prev, next) {
        if (!prev || prev === 'OFF' || prev === 'X') return false;
        if (next === 'OFF' || next === 'X') return false;
        if (prev === 'LN') return next === 'D' || next === 'EN';
        if (prev === 'EN') return next === 'D';
        return false;
    }

    // --- INITIALIZATION ---
    window.onload = () => { initDateSelectors(); loadData(); };

    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const curr = new Date().getFullYear();
        for(let i=curr-1; i<=curr+2; i++) ySel.add(new Option(i,i));
        ySel.value = curr;
        ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"].forEach((m,i)=>mSel.add(new Option(m,i+1)));
        mSel.value = new Date().getMonth()+1;
        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderSchedule(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderSchedule(); };
    }

    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${t}`).classList.add('active');
    }

    // --- API & DATA HANDLING ---
    async function loadData() {
        showLoader(true);
        try {
            let res = await fetch(`${API_URL}?action=load`);
            let json = await res.json();
            if(json.ok) {
                // Safe Data Merging
                let loadedState = json.data || {};
                state.employees = Array.isArray(loadedState.employees) ? loadedState.employees : [];
                state.schedule = loadedState.schedule || {};
                state.meta = loadedState.meta || { requirements: {}, depots: [] };
                
                // Depot handling
                if(state.meta.depots && state.meta.depots.length > 0) {
                    appConfig.depots = state.meta.depots;
                } else {
                    appConfig.depots = ["Budaiya", "IsaTown"];
                }
                document.getElementById('settingDepots').value = appConfig.depots.join(', ');

                // Initialize properties for employees if missing
                state.employees.forEach(emp => {
                    if(!emp.patternType) emp.patternType = 'weekly';
                    if(!emp.flexCounts) emp.flexCounts = { D: 1, EN: 2, LN: 2, OFF: 2 };
                    if(!emp.depotQuotas) emp.depotQuotas = {};
                    if(!emp.weeklyTemplate) emp.weeklyTemplate = Array(7).fill("D");
                });

                renderEmployees(); 
                renderRequirementsTable(); 
                renderSchedule();
                
                if(state.meta.updatedAt) document.getElementById('lastUpdated').innerText = new Date(state.meta.updatedAt).toLocaleTimeString();
            } else {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + json.error);
            }
        } catch(e) { 
            console.error(e); 
            // Fallback render to avoid empty screen
            renderEmployees(); 
            renderRequirementsTable();
            alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ§Ù„ÙØ©. Ø¬Ø±Ø¨ 'ØªØµÙÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©."); 
        } finally { 
            showLoader(false); 
        }
    }

    async function saveData(reset=false) {
        showLoader(true);
        if(reset && !confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { showLoader(false); return; }
        
        if(reset) {
            state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } };
            appConfig.depots = ["Budaiya", "IsaTown"]; // Reset depots default
        }
        
        state.meta.depots = appConfig.depots;
        
        try {
            await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "save", payload: state }) });
            if(reset) {
                document.getElementById('settingDepots').value = "Budaiya, IsaTown";
                renderEmployees();
                renderRequirementsTable();
                renderSchedule();
            }
            document.getElementById('lastUpdated').innerText = new Date().toLocaleTimeString();
        } catch(e) { alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸."); } finally { showLoader(false); }
    }

    // --- UI RENDERING (SAFE GUARDED) ---
    function renderRequirementsTable() {
        const container = document.getElementById('requirementsContainer');
        if(!container) return;
        
        // Safety: Ensure meta.requirements exists
        if(!state.meta) state.meta = {};
        if(!state.meta.requirements) state.meta.requirements = {};

        let html = `<table class="req-table"><thead><tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>D</th><th>EN</th><th>LN</th></tr></thead><tbody>`;
        appConfig.depots.forEach(d => {
            // Safety: Use fallback object
            let r = state.meta.requirements[d] || {D:0,EN:0,LN:0};
            html += `<tr><td>${d}</td>
            <td><input type="number" class="req-input" value="${r.D||0}" onchange="updReq('${d}','D',this.value)"></td>
            <td><input type="number" class="req-input" value="${r.EN||0}" onchange="updReq('${d}','EN',this.value)"></td>
            <td><input type="number" class="req-input" value="${r.LN||0}" onchange="updReq('${d}','LN',this.value)"></td></tr>`;
        });
        container.innerHTML = html + `</tbody></table>`;
    }
    function updReq(d,s,v) { 
        if(!state.meta.requirements[d]) state.meta.requirements[d]={}; 
        state.meta.requirements[d][s]=parseInt(v)||0; 
    }

    function renderEmployees() {
        const list = document.getElementById('employeeList'); 
        if(!list) return;
        list.innerHTML = "";
        
        state.employees.forEach(e => {
            let weekHtml = WEEKDAYS.map((day,i) => `<div><small>${day}</small><select onchange="updEmpWeek('${e.id}',${i},this.value)" style="width:100%">${SHIFTS.map(s=>`<option ${e.weeklyTemplate[i]===s?'selected':''}>${s}</option>`).join('')}</select></div>`).join('');
            
            let quotas = `<div class="depot-quotas">` + appConfig.depots.map(d => `<div><span>${d}</span><input type="number" style="width:40px" value="${(e.depotQuotas&&e.depotQuotas[d])||0}" onchange="updQuota('${e.id}','${d}',this.value)"></div>`).join('') + `</div>`;
            
            let flex = e.flexCounts || {D:1,EN:2,LN:2,OFF:2};
            let typeHtml = e.patternType === 'rolling' ? 
                `<div class="pattern-editor"><div class="flex-counts"><div>D <input type="number" style="width:40px" value="${flex.D}" onchange="updFlex('${e.id}','D',this.value)"></div><div>EN <input type="number" style="width:40px" value="${flex.EN}" onchange="updFlex('${e.id}','EN',this.value)"></div><div>LN <input type="number" style="width:40px" value="${flex.LN}" onchange="updFlex('${e.id}','LN',this.value)"></div><div>OFF <input type="number" style="width:40px" value="${flex.OFF}" onchange="updFlex('${e.id}','OFF',this.value)"></div></div></div>` :
                (e.patternType === 'joker' ? `<div class="pattern-editor">ğŸƒ Ø¬ÙˆÙƒØ± (Ø¥Ø¬Ø§Ø²Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹)</div>` : `<div class="pattern-editor" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px;">${weekHtml}</div>`);

            let div = document.createElement('div'); div.className = "emp-card";
            div.innerHTML = `<div class="emp-header"><input value="${e.name}" onchange="updEmp('${e.id}','name',this.value)" style="font-weight:bold"><select onchange="updEmp('${e.id}','patternType',this.value)"><option value="weekly" ${e.patternType==='weekly'?'selected':''}>Ø«Ø§Ø¨Øª</option><option value="rolling" ${e.patternType==='rolling'?'selected':''}>Ø¯ÙˆØ§Ø±</option><option value="joker" ${e.patternType==='joker'?'selected':''}>Ø¬ÙˆÙƒØ±</option></select><button class="danger" onclick="delEmp('${e.id}')">X</button></div>${quotas}${typeHtml}`;
            list.appendChild(div);
        });
    }
    
    // UI Helpers (Robust)
    function updEmp(id,k,v){ let e=state.employees.find(x=>x.id===id); if(e){e[k]=v; if(k==='patternType') renderEmployees();} }
    function updEmpWeek(id,i,v){ let e=state.employees.find(x=>x.id===id); if(e) e.weeklyTemplate[i]=v; }
    function updFlex(id,k,v){ let e=state.employees.find(x=>x.id===id); if(e){ if(!e.flexCounts) e.flexCounts={}; e.flexCounts[k]=parseInt(v); } }
    function updQuota(id,k,v){ let e=state.employees.find(x=>x.id===id); if(e){ if(!e.depotQuotas) e.depotQuotas={}; e.depotQuotas[k]=parseInt(v); } }
    function updateExceptions(id, t, v) { const e = state.employees.find(x=>x.id===id); if(e){ if(!e.exceptions) e.exceptions={}; e.exceptions[t]=v; } }
    function addEmployee(){ state.employees.push({id:'e'+Math.random().toString(36).substr(2,9), name:'Ø¬Ø¯ÙŠØ¯', patternType:'weekly', weeklyTemplate:Array(7).fill('D'), flexCounts:{D:1,EN:2,LN:2,OFF:2}, depotQuotas:{}}); renderEmployees(); }
    function delEmp(id){ if(confirm('Ø­Ø°ÙØŸ')) { state.employees=state.employees.filter(x=>x.id!==id); renderEmployees(); renderSchedule(); saveData(); } }
    function updateDepots() { appConfig.depots = document.getElementById('settingDepots').value.split(',').map(s=>s.trim()).filter(s=>s); renderRequirementsTable(); }
    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function getMonthKey() { return `${appConfig.year}-${appConfig.month}`; }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    function clearMonth() { if(confirm('Ù…Ø³Ø­ØŸ')) { state.schedule[getMonthKey()] = {}; renderSchedule(); saveData(); } }

    // ==========================================
    // === OPTIMIZER (WITH INIT GUARD) ===
    // ==========================================
    
    function runSmartOptimizer() {
        if(!confirm("Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø°ÙƒÙŠØŸ")) return;
        
        showLoader(true);
        setTimeout(() => {
            try {
                let bestSched = null;
                let bestScore = -Infinity; 

                for(let i=0; i<30; i++) { // 30 iterations for speed
                    let result = generateSingleRun();
                    if(result.score > bestScore) {
                        bestScore = result.score;
                        bestSched = result.schedule;
                    }
                }

                const key = getMonthKey();
                state.schedule[key] = bestSched;
                renderSchedule();
                saveData();
                alert(`ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!`);
            } catch(e) {
                console.error(e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
            } finally {
                showLoader(false);
            }
        }, 100);
    }

    function generateSingleRun() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());
        
        let tempSched = {};
        // âœ… GUARD: Ensure ALL employees have a schedule object initialized
        state.employees.forEach(e => tempSched[e.id] = {});

        let dailyNeeds = {}; 
        for(let d=1; d<=numDays; d++) {
            dailyNeeds[d] = { D:0, EN:0, LN:0 };
            cleanDepots.forEach(dep => {
                let r = reqs[dep] || reqs[dep.trim()];
                if(r) {
                    dailyNeeds[d].D += (r.D || 0);
                    dailyNeeds[d].EN += (r.EN || 0);
                    dailyNeeds[d].LN += (r.LN || 0);
                }
            });
        }

        let workStreaks = {}; 
        let empPrevShift = {};
        state.employees.forEach(e => { workStreaks[e.id] = 0; empPrevShift[e.id] = 'OFF'; });

        // 2. Fixed Weekly
        state.employees.forEach(emp => {
            if(emp.patternType === 'weekly' || !emp.patternType) {
                applyWeeklyImproved(emp, numDays, tempSched, dailyNeeds, workStreaks, empPrevShift);
            }
        });

        // 3. Rolling
        const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
        processWeeklyBuckets(rollingEmps, numDays, tempSched, dailyNeeds, workStreaks, empPrevShift, 'rolling');

        // 4. Joker
        const jokerEmps = state.employees.filter(e => e.patternType === 'joker');
        processWeeklyBuckets(jokerEmps, numDays, tempSched, dailyNeeds, workStreaks, empPrevShift, 'joker');

        // Calculate Score
        let score = 0;
        for(let d=1; d<=numDays; d++) {
            score -= (dailyNeeds[d].D * 10);
            score -= (dailyNeeds[d].EN * 10);
            score -= (dailyNeeds[d].LN * 10);
        }
        return { schedule: tempSched, score: score };
    }

    function processWeeklyBuckets(employees, numDays, sched, dailyNeeds, workStreaks, empPrevShift, type) {
        let currentDay = 1;
        while(currentDay <= numDays) {
            let daysInWeek = [];
            let d = currentDay;
            while(d <= numDays) {
                daysInWeek.push(d);
                let curDate = new Date(appConfig.year, appConfig.month - 1, d);
                if(curDate.getDay() === 6) break; 
                d++;
            }

            let buckets = {};
            let jokerPlannedOff = {}; 

            if(type === 'joker') {
                let daysUsage = {};
                daysInWeek.forEach(day => daysUsage[day] = 0);
                let shuffledEmps = [...employees].sort(() => Math.random() - 0.5);
                shuffledEmps.forEach(emp => {
                    let bestDay = daysInWeek.sort((a,b) => daysUsage[a] - daysUsage[b])[0];
                    jokerPlannedOff[emp.id] = bestDay;
                    daysUsage[bestDay]++;
                    buckets[emp.id] = { WORK: 6, OFF: 1 };
                });
            } else {
                employees.forEach(emp => {
                    let flex = emp.flexCounts || { D:1, EN:2, LN:2, OFF:2 };
                    buckets[emp.id] = { ...flex };
                });
            }

            let shuffledDays = [...daysInWeek].sort(() => Math.random() - 0.5);

            shuffledDays.forEach(dayNum => {
                let todaysNeeds = dailyNeeds[dayNum];
                let activeEmps = [...employees].sort(() => Math.random() - 0.5);

                activeEmps.forEach(emp => {
                    // âœ… GUARD: Ensure scheduling object exists before access
                    if(!sched[emp.id]) sched[emp.id] = {};

                    if(handleExceptionsImproved(emp, dayNum, sched, workStreaks, empPrevShift)) {
                        if(type === 'rolling' && sched[emp.id][dayNum].shift === 'OFF' && buckets[emp.id].OFF > 0) buckets[emp.id].OFF--;
                        return;
                    }

                    let bucket = buckets[emp.id];
                    let prev = empPrevShift[emp.id];
                    let streak = workStreaks[emp.id];
                    let assigned = "OFF";

                    let mustRest = (streak >= 5);
                    let isJokerPlannedOff = (type === 'joker' && jokerPlannedOff[emp.id] === dayNum);
                    
                    if (mustRest || isJokerPlannedOff) {
                        assigned = "OFF";
                    } else {
                        let canD = !isShiftFlipViolation(prev, 'D') && (type==='joker' ? true : bucket.D > 0);
                        let canEN = !isShiftFlipViolation(prev, 'EN') && (type==='joker' ? true : bucket.EN > 0);
                        let canLN = !isShiftFlipViolation(prev, 'LN') && (type==='joker' ? true : bucket.LN > 0);

                        if(type === 'joker') {
                            if (todaysNeeds.LN > 0 && canLN) { assigned = "LN"; todaysNeeds.LN--; }
                            else if (todaysNeeds.EN > 0 && canEN) { assigned = "EN"; todaysNeeds.EN--; }
                            else if (todaysNeeds.D > 0 && canD) { assigned = "D"; todaysNeeds.D--; }
                            else {
                                if(canLN) assigned = "LN";
                                else if(canEN) assigned = "EN";
                                else if(canD) assigned = "D";
                                else assigned = "OFF"; 
                            }
                        } else {
                            if (todaysNeeds.D > 0 && canD) { assigned = "D"; todaysNeeds.D--; bucket.D--; }
                            else if (todaysNeeds.EN > 0 && canEN) { assigned = "EN"; todaysNeeds.EN--; bucket.EN--; }
                            else if (todaysNeeds.LN > 0 && canLN) { assigned = "LN"; todaysNeeds.LN--; bucket.LN--; }
                            else {
                                if(bucket.OFF > 0) { assigned = "OFF"; bucket.OFF--; }
                                else if(canD && bucket.D > 0) { assigned = "D"; bucket.D--; }
                                else if(canEN && bucket.EN > 0) { assigned = "EN"; bucket.EN--; }
                                else if(canLN && bucket.LN > 0) { assigned = "LN"; bucket.LN--; }
                                else assigned = "OFF"; 
                            }
                        }
                    }

                    sched[emp.id][dayNum] = { shift: assigned, depot: "" };
                    empPrevShift[emp.id] = assigned;
                    updateStreak(emp.id, assigned, workStreaks);
                });
            });

            currentDay = d + 1;
        }
    }

    // --- SHARED HELPERS ---
    function updateStreak(empId, shift, streaks) {
        if(shift === 'OFF' || shift === 'X' || shift === '') streaks[empId] = 0;
        else streaks[empId] = (streaks[empId] || 0) + 1;
    }
    
    function handleExceptionsImproved(emp, d, sched, streaks, prevShifts) {
        // âœ… GUARD
        if(!sched[emp.id]) sched[emp.id] = {};

        const exc = emp.exceptions || {};
        const offDates = (exc.offDates || "").split(',').map(n => parseInt(n)).filter(n => !isNaN(n));
        const xDates = (exc.xDates || "").split(',').map(n => parseInt(n)).filter(n => !isNaN(n));
        
        if (xDates.includes(d)) { 
            sched[emp.id][d] = { shift: "X", depot: "" }; 
            updateStreak(emp.id, "X", streaks);
            prevShifts[emp.id] = "X";
            return true; 
        }
        if (offDates.includes(d)) { 
            sched[emp.id][d] = { shift: "OFF", depot: "" }; 
            updateStreak(emp.id, "OFF", streaks);
            prevShifts[emp.id] = "OFF";
            return true; 
        }
        return false;
    }
    
    function applyWeeklyImproved(emp, numDays, sched, dailyNeeds, streaks, prevShifts) {
        if(!sched[emp.id]) sched[emp.id] = {};
        const exc = emp.exceptions || {};
        const offDates = (exc.offDates || "").split(',').map(n => parseInt(n)).filter(n => !isNaN(n));
        const xDates = (exc.xDates || "").split(',').map(n => parseInt(n)).filter(n => !isNaN(n));
        
        for(let d=1; d<=numDays; d++) {
            let shift = sched[emp.id][d] ? sched[emp.id][d].shift : "";
            if (shift === "") {
                const date = new Date(appConfig.year, appConfig.month - 1, d);
                shift = emp.weeklyTemplate[date.getDay()];
                if (xDates.includes(d)) shift = "X"; 
                else if (offDates.includes(d)) shift = "OFF";
                
                const currentStreak = streaks[emp.id] || 0;
                if(currentStreak >= 5 && ["D","EN","LN"].includes(shift)) shift = "OFF";
                
                const prev = prevShifts[emp.id];
                if(isShiftFlipViolation(prev, shift)) {
                    if(!isShiftFlipViolation(prev, 'LN')) shift = 'LN';
                    else shift = 'OFF';
                }
                
                sched[emp.id][d] = { shift: shift, depot: "" };
            }
            
            if (["D","EN","LN"].includes(shift)) {
                if(dailyNeeds[d][shift] > 0) dailyNeeds[d][shift]--;
                updateStreak(emp.id, shift, streaks);
            } else {
                updateStreak(emp.id, shift, streaks);
            }
            
            prevShifts[emp.id] = shift;
        }
    }

    // --- DEPOT DISTRIBUTOR ---
    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        if(!sched) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const reqs = state.meta.requirements || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());

        if(!confirm("Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø­Ø³Ø¨ Ø­ØµØµ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.")) return;

        for(let d=1; d<=numDays; d++) {
            state.employees.forEach(emp => {
                if(sched[emp.id] && sched[emp.id][d] && ["D","EN","LN"].includes(sched[emp.id][d].shift)) {
                    sched[emp.id][d].depot = ""; 
                }
            });
        }

        let empDepotUsage = {}; state.employees.forEach(e => empDepotUsage[e.id] = {});

        for(let d=1; d<=numDays; d++) {
            let currentCounts = {}; cleanDepots.forEach(dep => { currentCounts[dep] = { D:0, EN:0, LN:0 }; });
            let workersByShift = { D:[], EN:[], LN:[] };
            state.employees.forEach(emp => {
                if(sched[emp.id] && sched[emp.id][d]) {
                    const s = sched[emp.id][d].shift;
                    if(["D","EN","LN"].includes(s)) workersByShift[s].push(emp);
                }
            });

            ["D", "EN", "LN"].forEach(shiftType => {
                let workers = workersByShift[shiftType];
                if(workers.length === 0) return;
                cleanDepots.forEach(dep => {
                    let needed = 0;
                    let r = reqs[dep] || reqs[dep.trim()];
                    if(r) needed = r[shiftType] || 0;
                    workers.sort((a, b) => {
                        let quotaA = (a.depotQuotas && a.depotQuotas[dep]) || 0;
                        let quotaB = (b.depotQuotas && b.depotQuotas[dep]) || 0;
                        let usedA = (empDepotUsage[a.id][dep] || 0);
                        let usedB = (empDepotUsage[b.id][dep] || 0);
                        return (quotaB - usedB) - (quotaA - usedA);
                    });
                    let i = 0;
                    while(i < workers.length && currentCounts[dep][shiftType] < needed) {
                        let emp = workers[i];
                        if(!sched[emp.id][d].depot) { 
                            sched[emp.id][d].depot = dep;
                            currentCounts[dep][shiftType]++;
                            if(!empDepotUsage[emp.id][dep]) empDepotUsage[emp.id][dep] = 0;
                            empDepotUsage[emp.id][dep]++;
                        }
                        i++;
                    }
                });
                workers.forEach(emp => {
                    if(!sched[emp.id][d].depot) {
                        let target = cleanDepots.reduce((a, b) => currentCounts[a][shiftType] < currentCounts[b][shiftType] ? a : b);
                        sched[emp.id][d].depot = target;
                        currentCounts[target][shiftType]++;
                    }
                });
            });
        }
        renderSchedule(); saveData();
    }

    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        if(!grid) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = state.schedule[getMonthKey()] || {};
        let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
        for(let d=1; d<=numDays; d++) html += `<th>${d}<br>${WEEKDAYS[new Date(appConfig.year,appConfig.month-1,d).getDay()]}</th>`;
        html += `</tr></thead><tbody>`;
        
        state.employees.forEach(emp => {
            let prev = 'OFF';
            let row = `<tr><td class="emp-col">${emp.name}</td>`;
            for(let d=1; d<=numDays; d++) {
                let cell = (data[emp.id] && data[emp.id][d]) || {shift:''};
                let s = cell.shift || '';
                let violation = isShiftFlipViolation(prev, s) ? 'violation' : '';
                row += `<td class="cell shift-${s} ${violation}">${s}${cell.depot?`<span class="depot-tag">${cell.depot}</span>`:''}</td>`;
                prev = (s!=='OFF' && s!=='X' && s!=='') ? s : s;
            }
            html += row + `</tr>`;
        });
        grid.innerHTML = html + `</tbody>`;
        analyzeCoverage();
    }

    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        if(!report) return;
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = state.schedule[getMonthKey()] || {};
        const cleanDepots = appConfig.depots.map(d => d.trim());
        const reqs = state.meta.requirements || {};
        let issues = [];
        let flips = 0;

        state.employees.forEach(emp => {
            let prev = 'OFF';
            for(let d=1; d<=numDays; d++) {
                let s = (sched[emp.id] && sched[emp.id][d]) ? sched[emp.id][d].shift : '';
                if(s) {
                    if(isShiftFlipViolation(prev, s)) {
                        flips++;
                        issues.push(`ğŸš¨ Ù‚Ù„Ø¨Ø© Ø´ÙØª: ${emp.name} ÙŠÙˆÙ… ${d} (${prev}->${s})`);
                    }
                    prev = s;
                }
            }
        });

        for(let d=1; d<=numDays; d++) {
            let counts = {}; cleanDepots.forEach(dep => counts[dep] = {D:0,EN:0,LN:0});
            state.employees.forEach(e => {
                let c = (sched[e.id] && sched[e.id][d]);
                if(c && c.depot && c.shift && ['D','EN','LN'].includes(c.shift)) counts[c.depot.trim()][c.shift]++;
            });
            cleanDepots.forEach(dep => {
                let r = reqs[dep] || reqs[dep.trim()];
                if(r) {
                    ['D','EN','LN'].forEach(s => {
                        if(counts[dep][s] < (r[s]||0)) issues.push(`ÙŠÙˆÙ… ${d} ${dep} (${s}): Ù…Ø·Ù„ÙˆØ¨ ${r[s]}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${counts[dep][s]}`);
                    });
                }
            });
        }

        if(issues.length === 0) report.innerHTML = `<div class="report-ok">âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù…ØªØ§Ø² ÙˆØ®Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡!</div>`;
        else report.innerHTML = (flips>0 ? `<div class="alert-box" style="background:#fee2e2;color:#991b1b">âš ï¸ ÙŠÙˆØ¬Ø¯ ${flips} Ù‚Ù„Ø¨Ø© Ø´ÙØª!</div>` : '') + 
            issues.map(i => `<div class="report-item">${i}</div>`).join('');
    }

    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        let csv = "\uFEFFM,";
        for(let d=1; d<=numDays; d++) csv += d + ","; csv += "\n";
        let data = state.schedule[getMonthKey()] || {};
        state.employees.forEach(e => {
            csv += `"${e.name}",`;
            for(let d=1; d<=numDays; d++) {
                let c = (data[e.id] && data[e.id][d]) || {};
                csv += `"${c.shift || ''} ${c.depot||''}",`;
            }
            csv += "\n";
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'schedule.csv'; a.click();
    }
    
    function cycleCell(id, d) {
        alert("Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ø¹Ø·Ù„ Ù„Ø¶Ù…Ø§Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹.");
    }
</script>
</body>
</html>
