<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© V10 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ù†Ù‚Ø­Ø©</title>
    <style>
        :root { --primary: #2563eb; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #f8fafc; --border: #cbd5e1; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: var(--bg); font-size: 13.5px; direction: rtl; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; align-items: center; }
        h1 { margin: 0; font-size: 1.3rem; margin-left: auto; color: #1e293b; font-weight: 800; }
        button { cursor: pointer; padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 6px; font-weight: 600; transition: all 0.2s; font-family: inherit; }
        button:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.success { background: var(--success); color: white; border-color: var(--success); }
        button.danger { background: var(--danger); color: white; border-color: var(--danger); }
        button.warning { background: var(--warning); color: white; border-color: var(--warning); }
        input, select { padding: 8px; border: 1px solid var(--border); border-radius: 5px; font-family: inherit; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; background: white; border-radius: 8px 8px 0 0; padding: 0 10px; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; color: #64748b; font-weight: 600; }
        .tab:hover { background: #f8fafc; color: var(--primary); }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); }
        .view { display: none; }
        .view.active { display: block; }
        .grid-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .schedule-table { border-collapse: collapse; width: 100%; min-width: 1000px; }
        .schedule-table th, .schedule-table td { border: 1px solid #e2e8f0; text-align: center; padding: 4px; height: 38px; font-size: 0.85rem; }
        .schedule-table th { background: #f8fafc; position: sticky; top: 0; z-index: 10; font-weight: 700; color: #334155; }
        .schedule-table th.emp-col { position: sticky; right: 0; z-index: 20; width: 170px; text-align: right; padding-right: 12px; border-left: 2px solid #cbd5e1; background: #f8fafc; }
        .schedule-table td.emp-col { position: sticky; right: 0; z-index: 5; background: white; text-align: right; padding-right: 12px; font-weight: 600; border-left: 2px solid #cbd5e1; color: #1e293b; }
        .cell { cursor: pointer; user-select: none; transition: background 0.15s; font-weight: 600; }
        .cell:hover { filter: brightness(0.95); }
        .cell.shift-M { background-color: #dbeafe; color: #1e40af; } 
        .cell.shift-A { background-color: #fef3c7; color: #92400e; } 
        .cell.shift-N { background-color: #1e293b; color: #f8fafc; } 
        .cell.shift-OFF { background-color: #f0fdf4; color: #166534; } 
        .cell.shift-VAC { background-color: #f3e8ff; color: #7e22ce; } 
        .cell.shift-X { background-color: #fee2e2; color: #991b1b; } 
        .violation { border: 3px solid var(--danger) !important; position: relative; animation: pulse 1s infinite; }
        .violation::after { content: 'âš ï¸'; position: absolute; top: 0; right: 2px; font-size: 0.7rem; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); } }
        .emp-card { border: 1px solid var(--border); background: white; padding: 16px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .emp-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; margin-bottom: 12px; }
        .pattern-editor { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px dashed var(--border); margin-top: 10px; }
        .flex-counts { display: flex; gap: 10px; flex-wrap: wrap; }
        .flex-counts div { display: flex; flex-direction: column; align-items: center; }
        .flex-counts label { font-size: 0.7rem; font-weight: 700; color: #64748b; }
        .flex-counts input { width: 45px; text-align: center; font-weight: 600; border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; }
        .depot-quotas { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 10px; }
        .depot-quotas div { background: #fff7ed; padding: 6px; border: 1px solid #ffedd5; border-radius: 6px; }
        .depot-quotas label { font-size: 0.7rem; font-weight: 700; color: #9a3412; display: block; }
        .depot-quotas input { width: 100%; text-align: center; font-weight: 600; margin-top: 2px; }
        .vacation-input { background: #f3e8ff; padding: 8px; border-radius: 6px; border: 1px solid #e9d5ff; margin-top: 10px; }
        .vacation-input input { width: 100%; padding: 5px; border: 1px solid #d8b4fe; border-radius: 4px; }
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader-content { text-align: center; }
        .loader-icon { font-size: 3rem; animation: spin 2s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-text { margin-top: 15px; font-weight: 700; color: #334155; font-size: 1.1rem; }
        .progress-stage { margin-top: 8px; color: #64748b; font-size: 0.9rem; }
        .report-box { margin-top: 20px; padding: 16px; background: white; border: 1px solid var(--border); border-radius: 10px; }
        .report-item { margin-bottom: 4px; padding: 6px 10px; background: #fff1f2; color: #9f1239; border-radius: 4px; border-right: 3px solid var(--danger); font-size: 0.9rem; font-weight: 500; }
        .report-flip { margin-bottom: 4px; padding: 6px 10px; background: #fee2e2; color: #991b1b; border-radius: 4px; border-right: 3px solid var(--danger); font-size: 0.9rem; font-weight: 600; }
        .report-ok { background: #d1fae5; color: #065f46; padding: 15px; text-align: center; font-weight: 700; border-radius: 8px; }
        .alert-box { background: #dbeafe; border: 1px solid #93c5fd; padding: 12px; border-radius: 8px; margin: 10px 0; color: #1e40af; font-weight: 600; font-size: 0.9rem; text-align: center; }
        .alert-box.warning { background: #fef3c7; border-color: #fcd34d; color: #92400e; }
        .req-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .req-table th, .req-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        .req-input { width: 50px; text-align: center; font-weight: 600; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; margin: 0 3px; }
        .badge.success { background: #d1fae5; color: #065f46; }
        .badge.danger { background: #fee2e2; color: #991b1b; }
        .badge.info { background: #dbeafe; color: #1e40af; }
        .stat-summary { margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px; font-size: 0.85rem; color: #64748b; }
        .depot-tag { font-size: 0.65rem; display: block; opacity: 0.7; margin-top: 1px; }
    </style>
</head>
<body>

<div id="loader">
    <div class="loader-content">
        <div class="loader-icon">âš”ï¸</div>
        <div class="progress-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹...</div>
        <div class="progress-stage" id="progressStage"></div>
    </div>
</div>

<div class="app-container">
    <div class="toolbar">
        <h1>ğŸ—“ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© V10 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h1>
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <button onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸</button>
        <div style="flex-grow:1; text-align:left; font-size:0.8rem; color:#64748b;">
             <span id="lastUpdated"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>
        <div class="tab" onclick="switchTab('employees')">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        <div class="tab" onclick="switchTab('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <div id="view-schedule" class="view active">
        <div class="alert-box">
            ğŸš¦ <strong>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØµØ§Ø±Ù…:</strong> 
            <span class="badge info">1. Ø§Ù„Ø«Ø§Ø¨Øª</span>
            <span class="badge info">2. Ø§Ù„Ø¯ÙˆØ§Ø± (M)</span>
            <span class="badge info">3. Ø³Ø¯ Ø¹Ø¬Ø² M</span>
            <span class="badge info">4. Ø§Ù„Ø¯ÙˆØ§Ø± (A/N)</span>
            <span class="badge info">5. Ø§Ù„Ø¬ÙˆÙƒØ±</span>
        </div>
        <div class="toolbar" style="background:transparent; padding:0; box-shadow:none; justify-content:space-between;">
            <div>
                <button onclick="generateScheduleStages()" class="primary">âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª</button>
                <button onclick="fillDepots()" class="success">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
                <button onclick="autoFixFlips()" class="warning">ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù‚Ù„Ø¨Ø§Øª</button>
            </div>
            <div>
                <button onclick="clearMonth()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ù‡Ø±</button>
                <button onclick="exportCSV()">ğŸ“„ ØªØµØ¯ÙŠØ± Excel</button>
            </div>
        </div>
        <div class="grid-container">
            <table class="schedule-table" id="scheduleGrid"></table>
        </div>
        <div id="coverageReport" class="report-box"></div>
    </div>

    <div id="view-employees" class="view">
        <button class="primary" onclick="addEmployee()" style="margin-bottom: 15px;">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</button>
        <div id="employeeList"></div>
    </div>

    <div id="view-settings" class="view">
        <div class="emp-card">
            <h3>1ï¸âƒ£ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
            <p style="font-size:0.85rem; color:#64748b; margin:8px 0;">Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨ÙØ§ØµÙ„Ø©</p>
            <input type="text" id="settingDepots" style="width: 100%;" onchange="updateDepots()">
        </div>
        <div class="emp-card">
            <h3>2ï¸âƒ£ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ ÙƒÙ„ Ù…ÙˆÙ‚Ø¹</h3>
            <div id="requirementsContainer"></div>
        </div>
        <div class="emp-card">
            <h3>3ï¸âƒ£ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            <button class="danger" onclick="saveData(true)">âš ï¸ Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // === CONFIGURATION ===
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec"; // â¬…ï¸ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Google Web App Ù‡Ù†Ø§
    
    // ==========================================
    // === STATE MANAGEMENT ===
    // ==========================================
    let state = { 
        employees: [], 
        schedule: {}, 
        meta: { requirements: {}, depots: [] } 
    };
    let appConfig = { 
        depots: ["Budaiya", "IsaTown"], 
        year: new Date().getFullYear(), 
        month: new Date().getMonth() + 1 
    };
    
    const SHIFTS = ["M", "A", "N", "OFF", "VAC", "X"];
    const SHIFT_NAMES = {
        "M": "Morning (ØµØ¨Ø§Ø­)",
        "A": "Afternoon (Ø¹ØµØ±)",
        "N": "Night (Ù„ÙŠÙ„)",
        "OFF": "Ø±Ø§Ø­Ø©",
        "VAC": "Ø¥Ø¬Ø§Ø²Ø©",
        "X": "ØºÙŠØ§Ø¨"
    };
    const WEEKDAYS = ["Ø£Ø­Ø¯", "Ø§Ø«Ù†ÙŠÙ†", "Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø®Ù…ÙŠØ³", "Ø¬Ù…Ø¹Ø©", "Ø³Ø¨Øª"];
    const MAX_CONSECUTIVE = 5; // âœ… ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ Ù…Ù† 6 Ø¥Ù„Ù‰ 5

    // ==========================================
    // === SHIFT FLIP PREVENTION (STRICT) ===
    // ==========================================
    function isShiftFlipViolation(prev, next) {
        if (!prev || ['OFF', 'X', 'VAC'].includes(prev)) return false;
        if (next === 'OFF' || next === 'X' || next === 'VAC') return false;
        
        // N â†’ M or N â†’ A (Ù…Ù…Ù†ÙˆØ¹)
        if (prev === 'N') return (next === 'M' || next === 'A');
        
        // A â†’ M (Ù…Ù…Ù†ÙˆØ¹)
        if (prev === 'A') return (next === 'M');
        
        return false;
    }

    // ==========================================
    // === INITIALIZATION ===
    // ==========================================
    window.onload = () => { initDateSelectors(); loadData(); };

    function initDateSelectors() {
        const ySel = document.getElementById('selYear');
        const mSel = document.getElementById('selMonth');
        const curr = new Date().getFullYear();
        
        for(let y = curr - 1; y <= curr + 2; y++) {
            ySel.add(new Option(y, y));
        }
        ySel.value = curr;
        
        const monthsAr = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        monthsAr.forEach((m, i) => mSel.add(new Option(m, i+1)));
        mSel.value = new Date().getMonth() + 1;
        
        ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderSchedule(); };
        mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderSchedule(); };
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`view-${tabName}`).classList.add('active');
    }

    // ==========================================
    // === API & DATA HANDLING ===
    // ==========================================
    async function loadData() {
        showLoader(true, "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
        try {
            const res = await fetch(`${API_URL}?action=load`);
            const json = await res.json();
            
            if(json.ok) {
                const data = json.data || {};
                state.employees = data.employees || [];
                state.schedule = data.schedule || {};
                state.meta = data.meta || { requirements: {}, depots: [] };
                
                if(state.meta.depots && state.meta.depots.length) {
                    appConfig.depots = state.meta.depots;
                }
                document.getElementById('settingDepots').value = appConfig.depots.join(', ');

                // Initialize employee properties
                state.employees.forEach(emp => {
                    if(!emp.id) emp.id = 'emp_' + Math.random().toString(36).substr(2, 9);
                    if(!emp.patternType) emp.patternType = 'weekly';
                    if(!emp.weeklyTemplate) emp.weeklyTemplate = Array(7).fill("M");
                    if(!emp.flexCounts) emp.flexCounts = { M: 1, A: 2, N: 2, OFF: 2 };
                    if(!emp.depotQuotas) emp.depotQuotas = {};
                    if(!emp.vacationDates) emp.vacationDates = "";
                });

                // âœ… Migrate old shift names (Dâ†’M, ENâ†’A, LNâ†’N)
                const reqs = state.meta.requirements;
                for(let depot in reqs) {
                    if(reqs[depot].D !== undefined) {
                        reqs[depot].M = reqs[depot].D;
                        reqs[depot].A = reqs[depot].EN;
                        reqs[depot].N = reqs[depot].LN;
                        delete reqs[depot].D;
                        delete reqs[depot].EN;
                        delete reqs[depot].LN;
                    }
                }

                renderEmployees();
                renderRequirementsTable();
                renderSchedule();
                
                if(state.meta.updatedAt) {
                    document.getElementById('lastUpdated').innerText = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date(state.meta.updatedAt).toLocaleTimeString();
                }
            } else {
                alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + json.error);
            }
        } catch(e) {
            console.error(e);
            alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….");
        } finally {
            showLoader(false);
        }
    }

    async function saveData(reset = false) {
        showLoader(true, reset ? "Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..." : "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...");
        
        if(reset && !confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
            showLoader(false);
            return;
        }
        
        if(reset) {
            state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } };
            appConfig.depots = ["Budaiya", "IsaTown"];
        }
        
        state.meta.depots = appConfig.depots;
        state.meta.updatedAt = new Date().toISOString();
        
        try {
            const payload = {
                action: "save",
                payload: {
                    employees: state.employees,
                    schedule: state.schedule,
                    meta: state.meta
                }
            };
            
            await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            
            if(reset) {
                document.getElementById('settingDepots').value = "Budaiya, IsaTown";
                renderEmployees();
                renderRequirementsTable();
                renderSchedule();
            }
            
            document.getElementById('lastUpdated').innerText = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date().toLocaleTimeString();
        } catch(e) {
            console.error(e);
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.");
        } finally {
            showLoader(false);
        }
    }

    // ==========================================
    // === UI RENDERING ===
    // ==========================================
    function renderRequirementsTable() {
        const container = document.getElementById('requirementsContainer');
        if(!container) return;
        
        if(!state.meta.requirements) state.meta.requirements = {};
        
        let html = `<table class="req-table">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                    <th>M (ØµØ¨Ø§Ø­)</th>
                    <th>A (Ø¹ØµØ±)</th>
                    <th>N (Ù„ÙŠÙ„)</th>
                </tr>
            </thead>
            <tbody>`;
        
        appConfig.depots.forEach(depot => {
            const req = state.meta.requirements[depot] || { M:0, A:0, N:0 };
            html += `<tr>
                <td style="font-weight:700;">${depot}</td>
                <td><input type="number" min="0" class="req-input" value="${req.M || 0}" onchange="updateReq('${depot}', 'M', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.A || 0}" onchange="updateReq('${depot}', 'A', this.value)"></td>
                <td><input type="number" min="0" class="req-input" value="${req.N || 0}" onchange="updateReq('${depot}', 'N', this.value)"></td>
            </tr>`;
        });
        
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function updateReq(depot, shift, value) {
        if(!state.meta.requirements[depot]) state.meta.requirements[depot] = {};
        state.meta.requirements[depot][shift] = parseInt(value) || 0;
    }

    function renderEmployees() {
        const container = document.getElementById('employeeList');
        if(!container) return;
        container.innerHTML = "";
        
        state.employees.forEach(emp => {
            const div = document.createElement('div');
            div.className = "emp-card";
            
            // Weekly Template Editor
            let weekHtml = "<div style='display:grid; grid-template-columns:repeat(7,1fr); gap:6px;'>";
            WEEKDAYS.forEach((day, i) => {
                const opts = SHIFTS.filter(s => s !== 'VAC' && s !== 'X').map(s => 
                    `<option value="${s}" ${emp.weeklyTemplate[i] === s ? 'selected' : ''}>${s}</option>`
                ).join('');
                weekHtml += `<div style="text-align:center;">
                    <label style="font-size:0.7rem; color:#64748b; display:block; margin-bottom:2px;">${day}</label>
                    <select onchange="updateWeeklyTemplate('${emp.id}', ${i}, this.value)" style="width:100%; font-size:0.85rem;">
                        ${opts}
                    </select>
                </div>`;
            });
            weekHtml += "</div>";
            
            // Depot Quotas
            let quotasHtml = `<div class="depot-quotas">`;
            appConfig.depots.forEach(depot => {
                const val = (emp.depotQuotas && emp.depotQuotas[depot]) || 0;
                quotasHtml += `<div>
                    <label>${depot}</label>
                    <input type="number" min="0" value="${val}" onchange="updateDepotQuota('${emp.id}', '${depot}', this.value)">
                </div>`;
            });
            quotasHtml += `</div>`;
            
            // Vacation Input
            let vacationHtml = `<div class="vacation-input">
                <label style="font-size:0.75rem; font-weight:700; color:#7e22ce; display:block; margin-bottom:4px;">
                    ğŸ–ï¸ Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (Ù…Ø«Ø§Ù„: 5, 12, 20)
                </label>
                <input type="text" placeholder="Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£ÙŠØ§Ù… Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©" value="${emp.vacationDates || ''}" 
                       onchange="updateVacationDates('${emp.id}', this.value)">
            </div>`;
            
            // Pattern Type Editor
            const flex = emp.flexCounts || { M: 1, A: 2, N: 2, OFF: 2 };
            let patternHtml = "";
            
            if(emp.patternType === 'rolling') {
                patternHtml = `<div class="pattern-editor">
                    <label style="font-weight:700; display:block; margin-bottom:8px;">Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ø§Ù„Ø£Ø­Ø¯-Ø§Ù„Ø³Ø¨Øª):</label>
                    <div class="flex-counts">
                        <div><label>M ØµØ¨Ø§Ø­</label><input type="number" min="0" max="7" value="${flex.M}" onchange="updateFlexCount('${emp.id}', 'M', this.value)"></div>
                        <div><label>A Ø¹ØµØ±</label><input type="number" min="0" max="7" value="${flex.A}" onchange="updateFlexCount('${emp.id}', 'A', this.value)"></div>
                        <div><label>N Ù„ÙŠÙ„</label><input type="number" min="0" max="7" value="${flex.N}" onchange="updateFlexCount('${emp.id}', 'N', this.value)"></div>
                        <div><label>OFF Ø±Ø§Ø­Ø©</label><input type="number" min="0" max="7" value="${flex.OFF}" onchange="updateFlexCount('${emp.id}', 'OFF', this.value)"></div>
                    </div>
                    <p style="font-size:0.75rem; color:#059669; margin:8px 0 0 0; font-weight:600;">âœ… ÙŠÙØµÙÙ‘Ø± Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ„ ÙŠÙˆÙ… Ø£Ø­Ø¯</p>
                </div>`;
            } else if(emp.patternType === 'joker') {
                patternHtml = `<div class="pattern-editor">
                    <div style="color:#d97706; font-weight:700; font-size:1rem; margin-bottom:6px;">ğŸƒ Ù…ÙˆØ¸Ù Ø¬ÙˆÙƒØ±</div>
                    <p style="font-size:0.8rem; color:#92400e; margin:0; line-height:1.5;">
                        âœ… ÙŠØºØ·ÙŠ Ø§Ù„Ù†Ù‚Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹<br>
                        âœ… Ø£ÙˆÙ„ÙˆÙŠØ©: N â†’ A â†’ M<br>
                        âœ… 6 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„ + 1 Ø±Ø§Ø­Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹
                    </p>
                </div>`;
            } else {
                patternHtml = `<div class="pattern-editor">
                    <label style="font-weight:700; display:block; margin-bottom:8px;">Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª:</label>
                    ${weekHtml}
                </div>`;
            }
            
            div.innerHTML = `
                <div class="emp-header">
                    <input type="text" value="${emp.name}" onchange="updateEmployee('${emp.id}', 'name', this.value)" 
                           style="font-weight:700; font-size:1.05rem; border:none; background:transparent; flex:1;">
                    <select onchange="updateEmployee('${emp.id}', 'patternType', this.value)" style="font-size:0.9rem; margin:0 10px;">
                        <option value="weekly" ${emp.patternType === 'weekly' ? 'selected' : ''}>Ø«Ø§Ø¨Øª (Weekly)</option>
                        <option value="rolling" ${emp.patternType === 'rolling' ? 'selected' : ''}>Ø¯ÙˆØ§Ø± (Rolling)</option>
                        <option value="joker" ${emp.patternType === 'joker' ? 'selected' : ''}>Ø¬ÙˆÙƒØ± (Joker)</option>
                    </select>
                    <button class="danger" onclick="deleteEmployee('${emp.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
                ${vacationHtml}
                <div style="margin:10px 0;">
                    <strong style="font-size:0.85rem; color:#64748b;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:</strong>
                    ${quotasHtml}
                </div>
                ${patternHtml}
            `;
            
            container.appendChild(div);
        });
    }

    // ==========================================
    // === EMPLOYEE MANAGEMENT ===
    // ==========================================
    function addEmployee() {
        const id = 'emp_' + Math.random().toString(36).substr(2, 9);
        state.employees.push({
            id: id,
            name: "Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯",
            patternType: "weekly",
            weeklyTemplate: Array(7).fill("M"),
            flexCounts: { M:1, A:2, N:2, OFF:2 },
            depotQuotas: {},
            vacationDates: ""
        });
        renderEmployees();
    }

    function updateEmployee(id, field, value) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) {
            emp[field] = value;
            if(field === 'patternType') renderEmployees();
        }
    }

    function updateWeeklyTemplate(id, dayIndex, shift) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) emp.weeklyTemplate[dayIndex] = shift;
    }

    function updateFlexCount(id, shift, value) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) {
            if(!emp.flexCounts) emp.flexCounts = {};
            emp.flexCounts[shift] = parseInt(value) || 0;
        }
    }

    function updateDepotQuota(id, depot, value) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) {
            if(!emp.depotQuotas) emp.depotQuotas = {};
            emp.depotQuotas[depot] = parseInt(value) || 0;
        }
    }

    function updateVacationDates(id, value) {
        const emp = state.employees.find(e => e.id === id);
        if(emp) emp.vacationDates = value;
    }

    function deleteEmployee(id) {
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) {
            state.employees = state.employees.filter(e => e.id !== id);
            renderEmployees();
            renderSchedule();
            saveData();
        }
    }

    function updateDepots() {
        const val = document.getElementById('settingDepots').value;
        appConfig.depots = val.split(',').map(s => s.trim()).filter(s => s);
        renderRequirementsTable();
        renderEmployees();
    }

    // ==========================================
    // === SCHEDULE GENERATOR (V10 STAGES) ===
    // ==========================================
    function generateScheduleStages() {
        if(!confirm("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹ (Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØµØ§Ø±Ù…)ØŸ\n\n" +
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø«Ø§Ø¨Øª\n" +
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„Ø¯ÙˆØ§Ø± - M ÙÙ‚Ø· (Ù…Ù† Ø§Ù„Ø¯Ù„Ùˆ)\n" +
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„Ø¯ÙˆØ§Ø± - ØªØ­ÙˆÙŠÙ„ Ù„Ù€ M (Ø³Ø¯ Ø§Ù„Ø¹Ø¬Ø²)\n" +
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„Ø¯ÙˆØ§Ø± - Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´ÙØªØ§Øª (A/N)\n" +
            "Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„Ø¬ÙˆÙƒØ± - Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ")) {
            return;
        }
        
        showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹...");
        
        setTimeout(() => {
            try {
                const key = getMonthKey();
                const numDays = daysInMonth(appConfig.year, appConfig.month);
                
                if(!state.schedule[key]) state.schedule[key] = {};
                const sched = state.schedule[key];
                
                // Initialize all employees
                state.employees.forEach(emp => {
                    if(!sched[emp.id]) sched[emp.id] = {};
                });
                
                updateProgress("Ø§Ù„Ù…Ø±Ø­Ù„Ø© 0: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª...");
                applyVacations(numDays, sched);
                
                const dailyNeeds = calculateDailyNeeds(numDays);
                
                // Tracking
                const workStreaks = {};
                const empPrevShift = {};
                state.employees.forEach(emp => {
                    workStreaks[emp.id] = 0;
                    empPrevShift[emp.id] = 'OFF';
                });
                
                updateProgress("Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø«Ø§Ø¨Øª...");
                applyFixedEmployees(numDays, sched, dailyNeeds, workStreaks, empPrevShift);
                
                const rollingEmps = state.employees.filter(e => e.patternType === 'rolling');
                const jokerEmps = state.employees.filter(e => e.patternType === 'joker');
                
                // Create staggered OFF schedules
                const rollingOffMap = {};
                rollingEmps.forEach((emp, idx) => {
                    rollingOffMap[emp.id] = [];
                    let base1 = (idx % 7) + 1;
                    let base2 = ((idx + 3) % 7) + 1;
                    
                    for(let day = 1; day <= numDays; day++) {
                        let dayOfWeek = ((day - 1) % 7) + 1;
                        if(dayOfWeek === base1 || dayOfWeek === base2) {
                            rollingOffMap[emp.id].push(day);
                        }
                    }
                });
                
                const jokerOffMap = {};
                jokerEmps.forEach((emp, idx) => {
                    jokerOffMap[emp.id] = [];
                    let base = (idx % 7) + 1;
                    for(let day = base; day <= numDays; day += 7) {
                        jokerOffMap[emp.id].push(day);
                    }
                });
                
                // Process week by week
                let currentDay = 1;
                while(currentDay <= numDays) {
                    let weekEnd = Math.min(currentDay + 6 - new Date(appConfig.year, appConfig.month - 1, currentDay).getDay(), numDays);
                    let daysInWeek = [];
                    for(let i = currentDay; i <= weekEnd; i++) {
                        daysInWeek.push(i);
                    }
                    
                    // Reset buckets on week start
                    if(new Date(appConfig.year, appConfig.month - 1, currentDay).getDay() === 0 || currentDay === 1) {
                        rollingEmps.forEach(emp => {
                            let flex = emp.flexCounts || { M:1, A:2, N:2, OFF:2 };
                            emp._bucket = { ...flex };
                            emp._totalWorkNeeded = flex.M + flex.A + flex.N;
                            emp._daysWorkedThisWeek = 0;
                        });
                    }
                    
                    daysInWeek.forEach(day => {
                        let todaysNeeds = dailyNeeds[day];
                        let rollingList = [...rollingEmps].sort(() => Math.random() - 0.5);
                        let jokerList = [...jokerEmps].sort(() => Math.random() - 0.5);
                        
                        // === STAGE 2: ROLLING (HAPPY M) ===
                        updateProgress(`Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„Ø¯ÙˆØ§Ø± - M ÙÙ‚Ø· (ÙŠÙˆÙ… ${day}/${numDays})...`);
                        rollingList.forEach(emp => {
                            if(isAssigned(emp, day, sched)) return;
                            
                            let prev = empPrevShift[emp.id];
                            if(todaysNeeds.M > 0 && emp._bucket.M > 0 && !isShiftFlipViolation(prev, 'M')) {
                                assignShift(emp, day, 'M', sched, todaysNeeds, workStreaks, empPrevShift);
                                emp._bucket.M--;
                                emp._daysWorkedThisWeek++;
                            }
                        });
                        
                        // === STAGE 3: ROLLING (FORCED M) ===
                        updateProgress(`Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø³Ø¯ Ø¹Ø¬Ø² M (ÙŠÙˆÙ… ${day}/${numDays})...`);
                        if(todaysNeeds.M > 0) {
                            rollingList.forEach(emp => {
                                if(todaysNeeds.M <= 0) return;
                                if(isAssigned(emp, day, sched)) return;
                                
                                let prev = empPrevShift[emp.id];
                                if(!isShiftFlipViolation(prev, 'M')) {
                                    // Steal from bucket
                                    if(emp._bucket.A > 0) emp._bucket.A--;
                                    else if(emp._bucket.N > 0) emp._bucket.N--;
                                    else if(emp._bucket.M > 0) emp._bucket.M--;
                                    
                                    assignShift(emp, day, 'M', sched, todaysNeeds, workStreaks, empPrevShift);
                                    emp._daysWorkedThisWeek++;
                                }
                            });
                        }
                        
                        // === STAGE 4: ROLLING (REMAINING A/N & ANTI-SLACK) ===
                        updateProgress(`Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„Ø¯ÙˆØ§Ø± - A/N (ÙŠÙˆÙ… ${day}/${numDays})...`);
                        rollingList.forEach(emp => {
                            if(isAssigned(emp, day, sched)) return;
                            
                            let prev = empPrevShift[emp.id];
                            let bucket = emp._bucket;
                            let streak = workStreaks[emp.id] || 0;
                            
                            let daysLeft = (daysInWeek[daysInWeek.length - 1] - day) + 1;
                            let workLeft = emp._totalWorkNeeded - emp._daysWorkedThisWeek;
                            let mustWork = (workLeft >= daysLeft);
                            let forcedOff = (streak >= MAX_CONSECUTIVE);
                            let isPrefOff = rollingOffMap[emp.id].includes(day);
                            
                            let assigned = 'OFF';
                            
                            if(!forcedOff) {
                                let canA = !isShiftFlipViolation(prev, 'A');
                                let canN = !isShiftFlipViolation(prev, 'N');
                                
                                if(todaysNeeds.N > 0 && canN && bucket.N > 0) {
                                    assigned = 'N';
                                    bucket.N--;
                                } else if(todaysNeeds.A > 0 && canA && bucket.A > 0) {
                                    assigned = 'A';
                                    bucket.A--;
                                } else if(mustWork || (!isPrefOff && bucket.OFF <= 0)) {
                                    // Must work
                                    if(bucket.N > 0 && canN) {
                                        assigned = 'N';
                                        bucket.N--;
                                    } else if(bucket.A > 0 && canA) {
                                        assigned = 'A';
                                        bucket.A--;
                                    } else if(canN) {
                                        assigned = 'N'; // Force fill
                                    } else if(canA) {
                                        assigned = 'A';
                                    }
                                } else {
                                    // Take OFF
                                    if(bucket.OFF > 0) bucket.OFF--;
                                }
                            }
                            
                            if(assigned !== 'OFF') {
                                if(todaysNeeds[assigned] > 0) todaysNeeds[assigned]--;
                                assignShift(emp, day, assigned, sched, {}, workStreaks, empPrevShift);
                                emp._daysWorkedThisWeek++;
                            } else {
                                setOff(emp, day, sched, workStreaks, empPrevShift);
                            }
                        });
                        
                        // === STAGE 5: JOKER (CLEANUP) ===
                        updateProgress(`Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„Ø¬ÙˆÙƒØ± (ÙŠÙˆÙ… ${day}/${numDays})...`);
                        jokerList.forEach(emp => {
                            if(isAssigned(emp, day, sched)) return;
                            
                            let prev = empPrevShift[emp.id];
                            let streak = workStreaks[emp.id] || 0;
                            let assigned = 'OFF';
                            let isOffDay = jokerOffMap[emp.id].includes(day);
                            
                            if(!isOffDay && streak < MAX_CONSECUTIVE) {
                                let canM = !isShiftFlipViolation(prev, 'M');
                                let canA = !isShiftFlipViolation(prev, 'A');
                                let canN = !isShiftFlipViolation(prev, 'N');
                                
                                // Priority: N â†’ A â†’ M
                                if(todaysNeeds.N > 0 && canN) {
                                    assigned = 'N';
                                } else if(todaysNeeds.A > 0 && canA) {
                                    assigned = 'A';
                                } else if(todaysNeeds.M > 0 && canM) {
                                    assigned = 'M';
                                } else {
                                    // Fill hours
                                    if(canN) assigned = 'N';
                                    else if(canA) assigned = 'A';
                                    else if(canM) assigned = 'M';
                                }
                            }
                            
                            if(assigned !== 'OFF') {
                                if(todaysNeeds[assigned] > 0) todaysNeeds[assigned]--;
                                workStreaks[emp.id]++;
                            } else {
                                workStreaks[emp.id] = 0;
                            }
                            
                            sched[emp.id][day] = { shift: assigned, depot: "" };
                            empPrevShift[emp.id] = assigned;
                        });
                    });
                    
                    currentDay = daysInWeek[daysInWeek.length - 1] + 1;
                }
                
                updateProgress("Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...");
                // Final Auto-Correct
                autoFixFlipsInternal(sched, numDays);
                
                renderSchedule();
                saveData();
                showLoader(false);
                alert("âœ… ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!\n\nØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
                
            } catch(error) {
                console.error(error);
                showLoader(false);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹:\n" + error.message);
            }
        }, 100);
    }

    // ==========================================
    // === AUTO-FIX FLIPS ===
    // ==========================================
    function autoFixFlips() {
        if(!confirm("ğŸ”§ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØµÙ„Ø§Ø­ Ù‚Ù„Ø¨Ø§Øª Ø§Ù„Ø´ÙØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŸ\n\nØ³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ù‚Ù„Ø¨Ø© Ø´ÙØª Ø¥Ù„Ù‰ OFF.")) return;
        
        showLoader(true, "Ø¬Ø§Ø±ÙŠ Ø¥ØµÙ„Ø§Ø­ Ù‚Ù„Ø¨Ø§Øª Ø§Ù„Ø´ÙØª...");
        
        setTimeout(() => {
            const key = getMonthKey();
            const sched = state.schedule[key];
            if(!sched) {
                showLoader(false);
                alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ø¥ØµÙ„Ø§Ø­Ù‡!");
                return;
            }
            
            const numDays = daysInMonth(appConfig.year, appConfig.month);
            let fixedCount = autoFixFlipsInternal(sched, numDays);
            
            renderSchedule();
            saveData();
            showLoader(false);
            
            if(fixedCount > 0) {
                alert(`âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixedCount} Ù‚Ù„Ø¨Ø© Ø´ÙØª!`);
            } else {
                alert("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù„Ø¨Ø§Øª Ø´ÙØª Ù„Ù„Ø¥ØµÙ„Ø§Ø­!");
            }
        }, 100);
    }

    function autoFixFlipsInternal(sched, numDays) {
        let fixedCount = 0;
        
        state.employees.forEach(emp => {
            let prev = 'OFF';
            for(let day = 1; day <= numDays; day++) {
                let cell = sched[emp.id] && sched[emp.id][day];
                if(cell && cell.shift) {
                    if(isShiftFlipViolation(prev, cell.shift)) {
                        cell.shift = 'OFF';
                        fixedCount++;
                    }
                    prev = cell.shift;
                }
            }
        });
        
        return fixedCount;
    }

    // ==========================================
    // === HELPER FUNCTIONS ===
    // ==========================================
    function isAssigned(emp, day, sched) {
        return !!(sched[emp.id] && sched[emp.id][day] && sched[emp.id][day].shift);
    }

    function assignShift(emp, day, shift, sched, needs, streaks, prevs) {
        sched[emp.id][day] = { shift: shift, depot: "" };
        prevs[emp.id] = shift;
        
        if(needs[shift] !== undefined && needs[shift] > 0) {
            needs[shift]--;
        }
        
        if(shift === 'OFF' || shift === 'X' || shift === 'VAC') {
            streaks[emp.id] = 0;
        } else {
            streaks[emp.id] = (streaks[emp.id] || 0) + 1;
        }
    }

    function setOff(emp, day, sched, streaks, prevs) {
        sched[emp.id][day] = { shift: 'OFF', depot: "" };
        prevs[emp.id] = 'OFF';
        streaks[emp.id] = 0;
    }

    function applyVacations(numDays, sched) {
        state.employees.forEach(emp => {
            if(!emp.vacationDates) return;
            
            const vacDays = emp.vacationDates.split(',')
                .map(d => parseInt(d.trim()))
                .filter(d => !isNaN(d) && d >= 1 && d <= numDays);
            
            vacDays.forEach(day => {
                sched[emp.id][day] = { shift: 'VAC', depot: '' };
            });
        });
    }

    function calculateDailyNeeds(numDays) {
        const needs = {};
        const depots = appConfig.depots.map(d => d.trim());
        const reqs = state.meta.requirements || {};
        
        for(let day = 1; day <= numDays; day++) {
            needs[day] = { M: 0, A: 0, N: 0 };
            depots.forEach(depot => {
                const req = reqs[depot] || {};
                needs[day].M += (req.M || 0);
                needs[day].A += (req.A || 0);
                needs[day].N += (req.N || 0);
            });
        }
        
        return needs;
    }

    function applyFixedEmployees(numDays, sched, dailyNeeds, streaks, prevs) {
        const fixedEmps = state.employees.filter(e => e.patternType === 'weekly' || !e.patternType);
        
        fixedEmps.forEach(emp => {
            for(let day = 1; day <= numDays; day++) {
                // Skip if vacation
                if(isAssigned(emp, day, sched)) {
                    prevs[emp.id] = 'VAC';
                    streaks[emp.id] = 0;
                    continue;
                }
                
                const date = new Date(appConfig.year, appConfig.month - 1, day);
                const dayOfWeek = date.getDay();
                let shift = emp.weeklyTemplate[dayOfWeek];
                const prev = prevs[emp.id];
                
                // Check violations
                if(isShiftFlipViolation(prev, shift) || 
                   (streaks[emp.id] >= MAX_CONSECUTIVE && ['M','A','N'].includes(shift))) {
                    shift = 'OFF';
                }
                
                sched[emp.id][day] = { shift: shift, depot: "" };
                prevs[emp.id] = shift;
                
                if(['M','A','N'].includes(shift)) {
                    if(dailyNeeds[day][shift] > 0) dailyNeeds[day][shift]--;
                    streaks[emp.id] = (streaks[emp.id] || 0) + 1;
                } else {
                    streaks[emp.id] = 0;
                }
            }
        });
    }

    // ==========================================
    // === DEPOT DISTRIBUTION ===
    // ==========================================
    function fillDepots() {
        const key = getMonthKey();
        const sched = state.schedule[key];
        
        if(!sched) {
            alert("âš ï¸ ÙŠØ¬Ø¨ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´ÙØªØ§Øª Ø£ÙˆÙ„Ø§Ù‹!");
            return;
        }
        
        if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø­Ø³Ø¨ Ø­ØµØµ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŸ")) return;
        
        showLoader(true, "Ø¬Ø§Ø±ÙŠ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹...");
        
        setTimeout(() => {
            const numDays = daysInMonth(appConfig.year, appConfig.month);
            const reqs = state.meta.requirements || {};
            const depots = appConfig.depots.map(d => d.trim());
            
            // Reset all depots
            for(let day = 1; day <= numDays; day++) {
                state.employees.forEach(emp => {
                    if(sched[emp.id] && sched[emp.id][day] && ['M','A','N'].includes(sched[emp.id][day].shift)) {
                        sched[emp.id][day].depot = "";
                    }
                });
            }
            
            const usage = {};
            state.employees.forEach(emp => usage[emp.id] = {});
            
            for(let day = 1; day <= numDays; day++) {
                const counts = {};
                depots.forEach(depot => counts[depot] = { M:0, A:0, N:0 });
                
                const workers = { M:[], A:[], N:[] };
                
                state.employees.forEach(emp => {
                    const cell = sched[emp.id] && sched[emp.id][day];
                    if(cell && ['M','A','N'].includes(cell.shift)) {
                        workers[cell.shift].push(emp);
                    }
                });
                
                ['M', 'A', 'N'].forEach(shift => {
                    let list = workers[shift];
                    if(list.length === 0) return;
                    
                    // Sort by quota deficit
                    list.sort((a, b) => {
                        const quotaA = (a.depotQuotas && a.depotQuotas[depots[0]]) || 0;
                        const quotaB = (b.depotQuotas && b.depotQuotas[depots[0]]) || 0;
                        return quotaB - quotaA;
                    });
                    
                    depots.forEach(depot => {
                        const req = reqs[depot] || {};
                        const needed = req[shift] || 0;
                        
                        let assigned = 0;
                        for(let emp of list) {
                            if(assigned >= needed) break;
                            if(!sched[emp.id][day].depot) {
                                sched[emp.id][day].depot = depot;
                                counts[depot][shift]++;
                                assigned++;
                            }
                        }
                    });
                    
                    // Assign remaining to least crowded depot
                    list.forEach(emp => {
                        if(!sched[emp.id][day].depot) {
                            const target = depots.reduce((a, b) => 
                                counts[a][shift] < counts[b][shift] ? a : b
                            );
                            sched[emp.id][day].depot = target;
                            counts[target][shift]++;
                        }
                    });
                });
            }
            
            renderSchedule();
            saveData();
            showLoader(false);
            alert("âœ… ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!");
        }, 100);
    }

    // ==========================================
    // === SCHEDULE RENDERING ===
    // ==========================================
    function renderSchedule() {
        const grid = document.getElementById('scheduleGrid');
        if(!grid) return;
        
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = state.schedule[getMonthKey()] || {};
        
        let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
        
        for(let day = 1; day <= numDays; day++) {
            const date = new Date(appConfig.year, appConfig.month - 1, day);
            const dayName = WEEKDAYS[date.getDay()];
            const isWeekend = (date.getDay() === 5 || date.getDay() === 6);
            html += `<th style="${isWeekend ? 'background:#e2e8f0;' : ''}">${day}<br><small style="font-size:0.7rem;">${dayName}</small></th>`;
        }
        
        html += `</tr></thead><tbody>`;
        
        state.employees.forEach(emp => {
            const empData = data[emp.id] || {};
            const counts = { M:0, A:0, N:0, OFF:0, VAC:0, X:0 };
            
            let rowHtml = `<tr><td class="emp-col">${emp.name}</td>`;
            let prev = 'OFF';
            
            for(let day = 1; day <= numDays; day++) {
                const cell = empData[day] || { shift: "" };
                const shift = cell.shift || "";
                const depot = cell.depot || "";
                
                if(counts[shift] !== undefined) counts[shift]++;
                
                const violation = isShiftFlipViolation(prev, shift) ? "violation" : "";
                
                if(['M','A','N','VAC','X'].includes(shift)) {
                    prev = shift;
                } else {
                    prev = 'OFF';
                }
                
                const display = (shift === "" || shift === "OFF" || shift === "VAC" || shift === "X") ? 
                    shift : 
                    `${shift}${depot ? `<span class="depot-tag">${depot}</span>` : ''}`;
                
                rowHtml += `<td class="cell shift-${shift} ${violation}">${display}</td>`;
            }
            
            rowHtml += `</tr>`;
            html += rowHtml;
        });
        
        html += `</tbody>`;
        grid.innerHTML = html;
        
        analyzeCoverage();
    }

    // ==========================================
    // === COVERAGE ANALYSIS ===
    // ==========================================
    function analyzeCoverage() {
        const report = document.getElementById('coverageReport');
        if(!report) return;
        
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = state.schedule[getMonthKey()] || {};
        const depots = appConfig.depots.map(d => d.trim());
        const reqs = state.meta.requirements || {};
        
        let issues = [];
        let flipCount = 0;
        
        // âœ… Check for shift flip violations
        state.employees.forEach(emp => {
            let prev = 'OFF';
            for(let day = 1; day <= numDays; day++) {
                const cell = sched[emp.id] && sched[emp.id][day];
                if(cell && cell.shift) {
                    if(isShiftFlipViolation(prev, cell.shift)) {
                        flipCount++;
                        issues.push(`<div class="report-flip">ğŸš¨ <strong>Ù‚Ù„Ø¨Ø© Ø´ÙØª:</strong> ${emp.name} - ÙŠÙˆÙ… ${day} (${prev} â†’ ${cell.shift})</div>`);
                    }
                    prev = cell.shift;
                }
            }
        });
        
        // Check coverage deficits
        for(let day = 1; day <= numDays; day++) {
            const counts = {};
            depots.forEach(depot => counts[depot] = { M:0, A:0, N:0 });
            
            state.employees.forEach(emp => {
                const cell = sched[emp.id] && sched[emp.id][day];
                if(cell && cell.depot && ['M','A','N'].includes(cell.shift)) {
                    const depot = cell.depot.trim();
                    if(counts[depot]) {
                        counts[depot][cell.shift]++;
                    }
                }
            });
            
            depots.forEach(depot => {
                const req = reqs[depot] || {};
                ['M','A','N'].forEach(shift => {
                    const required = req[shift] || 0;
                    const actual = counts[depot][shift] || 0;
                    if(actual < required) {
                        issues.push(`<div class="report-item">ğŸ“Š ÙŠÙˆÙ… ${day}: <strong>${depot}</strong> (${shift}) - Ù…Ø·Ù„ÙˆØ¨ ${required}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${actual} <span class="badge danger">Ù†Ù‚Øµ ${required - actual}</span></div>`);
                    }
                });
            });
        }
        
        if(issues.length === 0) {
            report.innerHTML = `<div class="report-ok">âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù…ØªØ§Ø²! Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù„Ø¨Ø§Øª Ø´ÙØª ÙˆÙ„Ø§ Ù†Ù‚Øµ ÙÙŠ Ø§Ù„ØªØºØ·ÙŠØ©</div>`;
        } else {
            let header = '';
            if(flipCount > 0) {
                header = `<div class="alert-box warning">
                    ğŸš¨ <strong>ØªØ­Ø°ÙŠØ±:</strong> ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${flipCount} Ù‚Ù„Ø¨Ø© Ø´ÙØª! 
                    <span class="badge danger">${flipCount}</span>
                    <button onclick="autoFixFlips()" class="warning" style="margin-right:10px;">ğŸ”§ Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</button>
                </div>`;
            }
            
            report.innerHTML = header + 
                `<h4 style="margin:10px 0; color:#64748b;">ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ:</h4>` + 
                issues.join('');
        }
    }

    // ==========================================
    // === UTILITIES ===
    // ==========================================
    function getMonthKey() {
        return `${appConfig.year}-${appConfig.month}`;
    }

    function daysInMonth(year, month) {
        return new Date(year, month, 0).getDate();
    }

    function clearMonth() {
        if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ø¯ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ')) return;
        state.schedule[getMonthKey()] = {};
        renderSchedule();
        saveData();
    }

    function showLoader(show, message = "") {
        const loader = document.getElementById('loader');
        loader.style.display = show ? 'flex' : 'none';
        if(show && message) {
            updateProgress(message);
        }
    }

    function updateProgress(message) {
        const progressEl = document.getElementById('progressStage');
        if(progressEl) {
            progressEl.innerText = message;
        }
    }

    function exportCSV() {
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const data = state.schedule[getMonthKey()] || {};
        
        let csv = "\uFEFF,";
        for(let day = 1; day <= numDays; day++) {
            csv += `${day},`;
        }
        csv += "\n";
        
        state.employees.forEach(emp => {
            csv += `"${emp.name}",`;
            for(let day = 1; day <= numDays; day++) {
                const cell = (data[emp.id] && data[emp.id][day]) || {};
                const val = cell.shift ? `${cell.shift}${cell.depot ? ' ('+cell.depot+')' : ''}` : '';
                csv += `"${val}",`;
            }
            csv += "\n";
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Schedule_V10_${getMonthKey()}.csv`;
        link.click();
    }
</script>
</body>
</html>
