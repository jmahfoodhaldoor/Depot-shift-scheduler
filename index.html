<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© (V11 - Template Ø£Ø³Ø¨ÙˆØ¹ÙŠ + ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ)</title>
  <style>
    :root { --primary:#2563eb; --success:#10b981; --danger:#ef4444; --warning:#f59e0b; --bg:#f8fafc; --border:#cbd5e1; }
    *{ box-sizing:border-box; }
    body{ font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; margin:0; padding:0; background:var(--bg); font-size:13.5px; direction:rtl; }
    .app-container{ max-width:1400px; margin:0 auto; padding:10px; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.1); margin-bottom:20px; align-items:center; }
    h1{ margin:0; font-size:1.3rem; margin-left:auto; color:#1e293b; font-weight:800; }
    button{ cursor:pointer; padding:8px 16px; border:1px solid var(--border); background:#fff; border-radius:6px; font-weight:600; transition:.2s; font-family:inherit; }
    button:hover{ transform:translateY(-1px); box-shadow:0 2px 5px rgba(0,0,0,.1); }
    button.primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
    button.success{ background:var(--success); color:#fff; border-color:var(--success); }
    button.danger{ background:var(--danger); color:#fff; border-color:var(--danger); }
    button.outline{ background:#fff; border:1px solid #94a3b8; }
    input,select{ padding:8px; border:1px solid var(--border); border-radius:5px; font-family:inherit; }
    .tabs{ display:flex; gap:5px; margin-bottom:15px; border-bottom:2px solid #e2e8f0; background:#fff; border-radius:8px 8px 0 0; padding:0 10px; }
    .tab{ padding:12px 24px; cursor:pointer; border-bottom:3px solid transparent; transition:.2s; color:#64748b; font-weight:600; }
    .tab:hover{ background:#f8fafc; color:var(--primary); }
    .tab.active{ border-bottom-color:var(--primary); color:var(--primary); }
    .view{ display:none; }
    .view.active{ display:block; }
    .grid-container{ overflow-x:auto; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.05); border:1px solid var(--border); }
    .schedule-table{ border-collapse:collapse; width:100%; min-width:1100px; table-layout:fixed; }
    .schedule-table th,.schedule-table td{ border:1px solid #e2e8f0; text-align:center; padding:4px; height:38px; font-size:.85rem; }
    .schedule-table th{ background:#f8fafc; position:sticky; top:0; z-index:10; font-weight:700; color:#334155; white-space:nowrap; }
    .schedule-table th.emp-col{ position:sticky; right:0; z-index:20; width:190px; text-align:right; padding-right:12px; border-left:2px solid #cbd5e1; background:#f8fafc; }
    .schedule-table td.emp-col{ position:sticky; right:0; z-index:5; background:#fff; text-align:right; padding-right:12px; font-weight:600; border-left:2px solid #cbd5e1; color:#1e293b; white-space:nowrap; }

    .cell{ cursor:pointer; user-select:none; transition:background .15s; font-weight:700; }
    .cell:hover{ filter:brightness(.95); }
    .cell.shift-M{ background-color:#dbeafe; color:#1e40af; }
    .cell.shift-A{ background-color:#fef3c7; color:#92400e; }
    .cell.shift-N{ background-color:#1e293b; color:#f8fafc; }
    .cell.shift-OFF{ background-color:#f0fdf4; color:#166534; }
    .cell.shift-VAC{ background-color:#f3e8ff; color:#7e22ce; }
    .cell.shift-X{ background-color:#fee2e2; color:#991b1b; }
    .violation{ border:3px solid var(--danger)!important; }

    .emp-card{ border:1px solid var(--border); background:#fff; padding:16px; border-radius:10px; margin-bottom:12px; box-shadow:0 1px 2px rgba(0,0,0,.05); }
    .emp-header{ display:flex; justify-content:space-between; align-items:center; padding-bottom:10px; border-bottom:1px solid #f1f5f9; margin-bottom:12px; gap:8px; }
    .pattern-editor{ background:#f8fafc; padding:12px; border-radius:8px; border:1px dashed var(--border); margin-top:10px; }
    .flex-counts{ display:flex; gap:10px; flex-wrap:wrap; }
    .flex-counts div{ display:flex; flex-direction:column; align-items:center; }
    .flex-counts label{ font-size:.7rem; font-weight:800; color:#64748b; }
    .flex-counts input{ width:45px; text-align:center; font-weight:700; border:1px solid #cbd5e1; border-radius:4px; padding:4px; }
    .depot-quotas{ display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:8px; margin-top:10px; }
    .depot-quotas div{ background:#fff7ed; padding:6px; border:1px solid #ffedd5; border-radius:6px; }
    .depot-quotas label{ font-size:.7rem; font-weight:800; color:#9a3412; display:block; }
    .depot-quotas input{ width:100%; text-align:center; font-weight:700; margin-top:2px; }

    .vacation-input{ background:#f3e8ff; padding:8px; border-radius:6px; border:1px solid #e9d5ff; margin-top:10px; }
    .vacation-input input{ width:100%; padding:5px; border:1px solid #d8b4fe; border-radius:4px; }

    #loader{ position:fixed; inset:0; background:rgba(255,255,255,.95); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
    .report-box{ margin-top:20px; padding:16px; background:#fff; border:1px solid var(--border); border-radius:10px; }
    .report-item{ margin-bottom:4px; padding:6px 10px; background:#fff1f2; color:#9f1239; border-radius:4px; border-right:3px solid var(--danger); font-size:.9rem; font-weight:700; }
    .report-ok{ background:#d1fae5; color:#065f46; padding:15px; text-align:center; font-weight:900; border-radius:8px; }
    .alert-box{ background:#dbeafe; border:1px solid #93c5fd; padding:12px; border-radius:8px; margin:10px 0; color:#1e40af; font-weight:800; font-size:.9rem; text-align:center; }
    .req-table{ width:100%; border-collapse:collapse; margin-top:10px; }
    .req-table th,.req-table td{ border:1px solid #e2e8f0; padding:8px; text-align:center; }
    .req-input{ width:60px; text-align:center; font-weight:800; }

    /* Manual Editor Modal */
    #cellEditorOverlay{
      position:fixed; inset:0; background:rgba(15,23,42,.35);
      display:none; align-items:center; justify-content:center; z-index:10000;
    }
    #cellEditor{
      width:min(620px,92vw);
      background:#fff; border:1px solid #e2e8f0; border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.2); padding:14px;
    }
    #cellEditor h3{ margin:0 0 10px 0; font-size:1rem; color:#0f172a; }
    .ce-row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .ce-row > div{ flex:1; min-width:170px; }
    .ce-row label{ display:block; font-size:.8rem; font-weight:900; color:#475569; margin-bottom:6px; }
    .ce-actions{ display:flex; gap:10px; justify-content:flex-start; margin-top:8px; flex-wrap:wrap; }
    .ce-hint{ font-size:.78rem; color:#64748b; margin-top:8px; line-height:1.6; }
    .ce-warn{ background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:8px; border-radius:8px; font-weight:900; font-size:.8rem; display:none; }
  </style>
</head>
<body>

<div id="loader">
  <div style="font-size:2.5rem;">ğŸ—ï¸</div>
  <div style="margin-top:10px; font-weight:900; color:#334155;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...</div>
</div>

<!-- Manual Editor -->
<div id="cellEditorOverlay" onclick="closeCellEditor(event)">
  <div id="cellEditor" onclick="event.stopPropagation()">
    <h3 id="ceTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØª</h3>
    <div class="ce-warn" id="ceWarn"></div>
    <div class="ce-row">
      <div>
        <label>Ø§Ù„Ø´ÙØª</label>
        <select id="ceShift"></select>
      </div>
      <div>
        <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Depot)</label>
        <select id="ceDepot"></select>
      </div>
    </div>
    <div class="ce-actions">
      <button class="primary" onclick="saveCellEdit()">Ø­ÙØ¸</button>
      <button onclick="closeCellEditor()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="danger" onclick="clearCellEdit()">Ù…Ø³Ø­ (ÙØ§Ø±Øº)</button>
      <button class="outline" onclick="applyWeekdayToMonth()">ğŸ“Œ ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ù†ÙØ³ ÙŠÙˆÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ù‡Ø±</button>
    </div>
    <div class="ce-hint">
      - Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙŠØ³Ù…Ø­ Ù„Ùƒ ØªØ³ÙˆÙŠ ØªØ¹Ø¯ÙŠÙ„ â€œØ§Ø³ØªØ«Ù†Ø§Ø¦ÙŠâ€ Ø¥Ø°Ø§ Ø§Ù„Ù…ÙˆÙ„Ø¯ Ù…Ø§ Ù‚Ø¯Ø± ÙŠØ­Ù„ Ø­Ø§Ù„Ø© Ù…Ø¹ÙŠÙ†Ø©.<br>
      - Ø²Ø± ğŸ“Œ ÙŠÙƒØ±Ø± Ù†ÙØ³ Ø§Ù„Ø´ÙØª (ÙˆÙ†ÙØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Work) Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù€ weekday Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¸Ù.
    </div>
  </div>
</div>

<div class="app-container">
  <div class="toolbar">
    <h1>ğŸ—“ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙŠØ¯Ø© Ø²ÙŠÙ†Ø¨ (V11)</h1>
    <select id="selYear"></select>
    <select id="selMonth"></select>
    <button onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    <button class="primary" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸</button>
    <div style="flex-grow:1; text-align:left; font-size:0.8rem; color:#64748b;">
      <span id="lastUpdated"></span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('schedule')">Ø§Ù„Ø¬Ø¯ÙˆÙ„</div>
    <div class="tab" onclick="switchTab('employees')">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
    <div class="tab" onclick="switchTab('settings')">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
  </div>

  <div id="view-schedule" class="view active">
    <div class="alert-box">
      âœ… <strong>V11:</strong>
      Template Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙŠØªÙƒØ±Ø± Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ù‡Ø± â€¢ ØªÙˆØ²ÙŠØ¹ OFF Ù„Ù„Ø¯ÙˆÙ‘Ø§Ø± Ø¨Ø¯ÙˆÙ† ØªÙƒØ¯Ù‘Ø³ â€¢ Ù…Ù†Ø¹ Friday OFF Ù„Ù„Ø¯ÙˆÙ‘Ø§Ø±/Ø§Ù„Ø¬ÙˆÙƒØ± (Ø¢Ù„ÙŠØ§Ù‹)
      â€¢ Ø§Ù„Ø¬ÙˆÙƒØ± ÙŠÙØ¶Ù‘Ù„ N ÙˆÙŠØ¨ØªØ¹Ø¯ Ø¹Ù† M (Ø¢Ù„ÙŠØ§Ù‹) â€¢ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ + ØªÙƒØ±Ø§Ø± weekday
    </div>

    <div class="toolbar" style="background:transparent; padding:0; box-shadow:none; justify-content:space-between;">
      <div>
        <button onclick="generateScheduleV11()" class="primary">âš¡ ØªÙˆÙ„ÙŠØ¯ (V11)</button>
        <button onclick="fillDepots()" class="success">ğŸ­ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
      </div>
      <div>
        <button onclick="clearMonth()" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
        <button onclick="exportCSV()">ğŸ“„ Excel</button>
      </div>
    </div>

    <div class="grid-container">
      <table class="schedule-table" id="scheduleGrid"></table>
    </div>

    <div id="coverageReport" class="report-box"></div>
  </div>

  <div id="view-employees" class="view">
    <button class="primary" onclick="addEmployee()" style="margin-bottom:15px;">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
    <div id="employeeList"></div>
  </div>

  <div id="view-settings" class="view">
    <div class="emp-card">
      <h3>1ï¸âƒ£ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Depots)</h3>
      <input type="text" id="settingDepots" style="width:100%;" onchange="updateDepots()">
    </div>
    <div class="emp-card">
      <h3>2ï¸âƒ£ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (M, A, N)</h3>
      <div id="requirementsContainer"></div>
    </div>
    <div class="emp-card">
      <h3>3ï¸âƒ£ ØªØ­ÙƒÙ…</h3>
      <button class="danger" onclick="saveData(true)">âš ï¸ ØªØµÙÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const API_URL = "https://script.google.com/macros/s/AKfycbz_Ax4qk6l7tmebex2kP9e2KCz4twS960mH5D2JxF8RIa0h_OeiAC96uTNSMunQrvha/exec";

  let state = { employees: [], schedule: {}, meta: { requirements: {}, depots: [] } };
  let appConfig = { depots: ["Budaiya","IsaTown"], year:new Date().getFullYear(), month:new Date().getMonth()+1 };

  const SHIFTS = ["M","A","N","OFF","VAC","X"];
  const WORK_SHIFTS = ["M","A","N"];
  const WEEKDAYS = ["Ø£Ø­Ø¯","Ø§Ø«Ù†ÙŠÙ†","Ø«Ù„Ø§Ø«Ø§Ø¡","Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø®Ù…ÙŠØ³","Ø¬Ù…Ø¹Ø©","Ø³Ø¨Øª"];
  const MAX_CONSECUTIVE = 6;

  const FRIDAY = 5; // JS: 0 Sun..5 Fri..6 Sat

  // =========================
  // SAFETY GATE (original rules)
  // =========================
  function isShiftFlipViolation(prev, next){
    if(!prev || ["OFF","VAC","X",""].includes(prev)) return false;
    if(!next || ["OFF","VAC","X",""].includes(next)) return false;
    if(prev==="N") return (next==="M" || next==="A");
    if(prev==="A") return (next==="M");
    return false;
  }
  function breaksStreak(shift){
    return shift === "OFF"; // ÙÙ‚Ø· OFF ÙŠÙƒØ³Ø±
  }

  // =========================
  // INIT
  // =========================
  window.onload = () => { initDateSelectors(); loadData(); };

  function initDateSelectors(){
    const ySel = document.getElementById("selYear");
    const mSel = document.getElementById("selMonth");
    const curr = new Date().getFullYear();
    for(let y=curr-1;y<=curr+2;y++) ySel.add(new Option(y,y));
    ySel.value = curr;
    ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"]
      .forEach((m,i)=>mSel.add(new Option(m,i+1)));
    mSel.value = new Date().getMonth()+1;
    ySel.onchange = () => { appConfig.year = parseInt(ySel.value); renderAll(); };
    mSel.onchange = () => { appConfig.month = parseInt(mSel.value); renderAll(); };
  }

  function switchTab(t){
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".view").forEach(x=>x.classList.remove("active"));
    event.target.classList.add("active");
    document.getElementById(`view-${t}`).classList.add("active");
  }

  function showLoader(s){ document.getElementById("loader").style.display = s ? "flex" : "none"; }

  // =========================
  // API
  // =========================
  async function loadData(){
    showLoader(true);
    try{
      const res = await fetch(`${API_URL}?action=load`);
      const json = await res.json();
      if(json.ok){
        const data = json.data || {};
        state.employees = data.employees || [];
        state.schedule  = data.schedule  || {};
        state.meta      = data.meta      || { requirements:{}, depots:[] };

        if(state.meta.depots && state.meta.depots.length) appConfig.depots = state.meta.depots;
        document.getElementById("settingDepots").value = appConfig.depots.join(", ");

        state.employees.forEach(emp=>{
          if(!emp.id) emp.id = "emp_"+Math.random().toString(36).slice(2,10);
          if(!emp.patternType) emp.patternType = "weekly";
          if(!emp.weeklyTemplate) emp.weeklyTemplate = Array(7).fill("M");
          if(!emp.flexCounts) emp.flexCounts = {M:1,A:2,N:2,OFF:2};
          if(!emp.depotQuotas) emp.depotQuotas = {};
          if(!emp.vacationDates) emp.vacationDates = "";
        });

        renderAll();

        if(state.meta.updatedAt){
          document.getElementById("lastUpdated").innerText = new Date(state.meta.updatedAt).toLocaleTimeString();
        }
      }
    }catch(e){
      console.error(e);
      alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„.");
    }finally{
      showLoader(false);
    }
  }

  async function saveData(reset=false){
    showLoader(true);
    if(reset && !confirm("âš ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")){ showLoader(false); return; }
    if(reset) state = { employees:[], schedule:{}, meta:{ requirements:{}, depots:[] } };
    state.meta.depots = appConfig.depots;
    state.meta.updatedAt = new Date().toISOString();
    try{
      await fetch(API_URL, { method:"POST", body: JSON.stringify({ action:"save", payload:{ employees:state.employees, schedule:state.schedule, meta:state.meta } }) });
      document.getElementById("lastUpdated").innerText = new Date().toLocaleTimeString();
      if(reset) renderAll();
    }catch(e){
      alert("Ø®Ø·Ø£ Ø­ÙØ¸.");
    }finally{
      showLoader(false);
    }
  }

  // =========================
  // UI RENDER
  // =========================
  function renderAll(){
    renderEmployees();
    renderRequirementsTable();
    renderSchedule();
  }

  function renderRequirementsTable(){
    const container = document.getElementById("requirementsContainer");
    if(!state.meta.requirements) state.meta.requirements = {};
    let html = `<table class="req-table"><thead><tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><th>M</th><th>A</th><th>N</th></tr></thead><tbody>`;
    appConfig.depots.forEach(dep=>{
      const r = state.meta.requirements[dep] || {M:0,A:0,N:0};
      html += `<tr>
        <td style="font-weight:900;">${dep}</td>
        <td><input type="number" min="0" class="req-input" value="${r.M||0}" onchange="updateReq('${dep}','M',this.value)"></td>
        <td><input type="number" min="0" class="req-input" value="${r.A||0}" onchange="updateReq('${dep}','A',this.value)"></td>
        <td><input type="number" min="0" class="req-input" value="${r.N||0}" onchange="updateReq('${dep}','N',this.value)"></td>
      </tr>`;
    });
    container.innerHTML = html + `</tbody></table>`;
  }
  function updateReq(dep,shift,value){
    if(!state.meta.requirements[dep]) state.meta.requirements[dep] = {};
    state.meta.requirements[dep][shift] = parseInt(value)||0;
  }

  function renderEmployees(){
    const container = document.getElementById("employeeList");
    container.innerHTML = "";

    state.employees.forEach(emp=>{
      const div = document.createElement("div");
      div.className = "emp-card";

      let weekHtml = "<div style='display:grid; grid-template-columns:repeat(7,1fr); gap:6px;'>";
      WEEKDAYS.forEach((day,i)=>{
        const opts = SHIFTS.filter(s=>!["VAC","X"].includes(s)).map(s=>`<option value="${s}" ${emp.weeklyTemplate[i]===s?'selected':''}>${s}</option>`).join("");
        weekHtml += `<div style="text-align:center;">
          <label style="font-size:0.7rem; color:#64748b; font-weight:900;">${day}</label>
          <select onchange="updateWeeklyTemplate('${emp.id}',${i},this.value)" style="width:100%; font-size:0.85rem;">${opts}</select>
        </div>`;
      });
      weekHtml += "</div>";

      let quotasHtml = `<div class="depot-quotas">`;
      appConfig.depots.forEach(dep=>{
        const val = (emp.depotQuotas && emp.depotQuotas[dep]) || 0;
        quotasHtml += `<div><label>${dep}</label><input type="number" min="0" value="${val}" onchange="updateDepotQuota('${emp.id}','${dep}',this.value)"></div>`;
      });
      quotasHtml += `</div>`;

      let vacationHtml = `<div class="vacation-input">
        <label style="font-weight:900;">ğŸ–ï¸ Ø£ÙŠØ§Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (Ù…Ø«Ø§Ù„: 5, 6)</label>
        <input type="text" value="${emp.vacationDates||''}" onchange="updateVacationDates('${emp.id}',this.value)">
      </div>`;

      const flex = emp.flexCounts || {M:1,A:2,N:2,OFF:2};
      let patternHtml = "";
      if(emp.patternType==="rolling"){
        patternHtml = `<div class="pattern-editor"><div class="flex-counts">
          <div><label>M</label><input type="number" value="${flex.M}" onchange="updateFlexCount('${emp.id}','M',this.value)"></div>
          <div><label>A</label><input type="number" value="${flex.A}" onchange="updateFlexCount('${emp.id}','A',this.value)"></div>
          <div><label>N</label><input type="number" value="${flex.N}" onchange="updateFlexCount('${emp.id}','N',this.value)"></div>
          <div><label>OFF</label><input type="number" value="${flex.OFF}" onchange="updateFlexCount('${emp.id}','OFF',this.value)"></div>
        </div></div>`;
      } else if(emp.patternType==="joker"){
        patternHtml = `<div class="pattern-editor">
          <div style="color:#d97706; font-weight:900;">ğŸƒ Ø¬ÙˆÙƒØ±</div>
          <p style="font-size:0.82rem; margin:6px 0 0; font-weight:800; color:#92400e;">
            Ø¢Ù„ÙŠØ§Ù‹: N Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… A Ø¹Ù†Ø¯ Ø§Ù„Ø¶Ø±ÙˆØ±Ø©ØŒ Ùˆ M Ù…Ù…Ù†ÙˆØ¹.
          </p>
        </div>`;
      } else {
        patternHtml = `<div class="pattern-editor">${weekHtml}</div>`;
      }

      div.innerHTML = `
        <div class="emp-header">
          <input type="text" value="${emp.name}" onchange="updateEmployee('${emp.id}','name',this.value)" style="font-weight:900; flex:1; border:none;">
          <select onchange="updateEmployee('${emp.id}','patternType',this.value)" style="margin:0 10px; font-weight:900;">
            <option value="weekly" ${emp.patternType==='weekly'?'selected':''}>Ø«Ø§Ø¨Øª</option>
            <option value="rolling" ${emp.patternType==='rolling'?'selected':''}>Ø¯ÙˆØ§Ø±</option>
            <option value="joker" ${emp.patternType==='joker'?'selected':''}>Ø¬ÙˆÙƒØ±</option>
          </select>
          <button class="danger" onclick="deleteEmployee('${emp.id}')">ğŸ—‘ï¸</button>
        </div>
        ${vacationHtml}
        <div style="margin:10px 0;">
          <strong style="font-size:0.85rem; color:#64748b; font-weight:900;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹:</strong>
          ${quotasHtml}
        </div>
        ${patternHtml}
      `;
      container.appendChild(div);
    });
  }

  function addEmployee(){
    state.employees.push({
      id:'emp_'+Math.random().toString(36).slice(2,10),
      name:'Ø¬Ø¯ÙŠØ¯',
      patternType:'weekly',
      weeklyTemplate:Array(7).fill("M"),
      flexCounts:{M:1,A:2,N:2,OFF:2},
      depotQuotas:{},
      vacationDates:""
    });
    renderEmployees();
  }
  function updateEmployee(id,k,v){
    const e = state.employees.find(x=>x.id===id);
    if(e){ e[k]=v; if(k==="patternType") renderEmployees(); }
  }
  function updateWeeklyTemplate(id,i,v){
    const e = state.employees.find(x=>x.id===id);
    if(e) e.weeklyTemplate[i]=v;
  }
  function updateFlexCount(id,s,v){
    const e = state.employees.find(x=>x.id===id);
    if(e){
      if(!e.flexCounts) e.flexCounts={};
      e.flexCounts[s]=Math.max(0, parseInt(v)||0);
    }
  }
  function updateDepotQuota(id,dep,v){
    const e = state.employees.find(x=>x.id===id);
    if(e){
      if(!e.depotQuotas) e.depotQuotas={};
      e.depotQuotas[dep]=Math.max(0, parseInt(v)||0);
    }
  }
  function updateVacationDates(id,v){
    const e = state.employees.find(x=>x.id===id);
    if(e) e.vacationDates=v;
  }
  function deleteEmployee(id){
    if(confirm("Ø­Ø°ÙØŸ")){
      state.employees = state.employees.filter(x=>x.id!==id);
      renderAll();
      saveData();
    }
  }
  function updateDepots(){
    appConfig.depots = document.getElementById("settingDepots").value.split(",").map(s=>s.trim()).filter(Boolean);
    renderAll();
  }

  // =========================
  // SCHEDULE STORAGE HELPERS
  // =========================
  function getMonthKey(){ return `${appConfig.year}-${appConfig.month}`; }
  function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

  function ensureMonthSchedule(){
    const key = getMonthKey();
    if(!state.schedule[key]) state.schedule[key] = {};
    state.employees.forEach(e=>{
      if(!state.schedule[key][e.id]) state.schedule[key][e.id] = {};
    });
    return state.schedule[key];
  }

  function getCell(sched, empId, day){
    return (sched[empId] && sched[empId][day]) ? sched[empId][day] : null;
  }

  function setCell(sched, empId, day, shift, depot=""){
    sched[empId][day] = { shift, depot };
  }

  // =========================
  // APPLY VACATIONS (override)
  // =========================
  function applyVacations(numDays, sched){
    state.employees.forEach(emp=>{
      if(!emp.vacationDates) return;
      emp.vacationDates.split(",")
        .map(x=>parseInt(x.trim()))
        .filter(x=>!isNaN(x) && x>=1 && x<=numDays)
        .forEach(day=>{
          setCell(sched, emp.id, day, "VAC", "");
        });
    });
  }

  // =========================
  // DAILY NEEDS (for report + optional balancing)
  // =========================
  function calculateDailyNeeds(numDays){
    const needs = {};
    const depots = appConfig.depots.map(d=>d.trim());
    const reqs = state.meta.requirements || {};
    for(let d=1; d<=numDays; d++){
      needs[d] = { M:0, A:0, N:0 };
      depots.forEach(dep=>{
        const r = reqs[dep] || {};
        needs[d].M += (r.M||0);
        needs[d].A += (r.A||0);
        needs[d].N += (r.N||0);
      });
    }
    return needs;
  }

  // =========================
  // V11 GENERATOR (Template Weekly)
  // =========================
  function generateScheduleV11(){
    if(!confirm("ğŸš€ ØªÙˆÙ„ÙŠØ¯ V11ØŸ\n\n- Ø§Ù„Ø«Ø§Ø¨Øª ÙŠØªÙƒØ±Ø± Ø­Ø³Ø¨ Template\n- Ø§Ù„Ø¯ÙˆÙ‘Ø§Ø±: OFF Ù…ÙˆØ²Ø¹ ÙˆÙ…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù…Ø¹Ø© (Ø¢Ù„ÙŠØ§Ù‹)\n- Ø§Ù„Ø¬ÙˆÙƒØ±: N Ø£ÙˆÙ„Ø§Ù‹ Ùˆ OFF ÙˆØ§Ø­Ø¯ ÙˆÙ…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù…Ø¹Ø© (Ø¢Ù„ÙŠØ§Ù‹)\n- VAC Ù„Ø§ ÙŠÙÙ…Ø³\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù„Ø§Ø­Ù‚ ØªÙ‚Ø¯Ø± ØªØ«Ø¨Ù‘ØªÙ‡ Ø¨Ø²Ø± ğŸ“Œ")) return;

    showLoader(true);
    setTimeout(()=> {
      try{
        const numDays = daysInMonth(appConfig.year, appConfig.month);
        const sched = ensureMonthSchedule();

        // 1) clear month (Ù„ÙƒÙ† Ù†Ø®Ù„ÙŠ VAC Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ØŸ Ø§Ù„Ø£ÙØ¶Ù„ Ù†Ø¹ÙŠØ¯ ÙƒÙ„ Ø´ÙŠØ¡ Ø«Ù… Ù†Ø·Ø¨Ù‚ VAC)
        //    Ù„Ø£Ù† VAC override: Ù†Ø¹ÙŠØ¯ ØªÙˆÙ„ÙŠØ¯ Ø«Ù… Ù†Ø·Ø¨Ù‚ VAC Ø¢Ø®Ø± Ø´ÙŠØ¡.
        for(const emp of state.employees){
          sched[emp.id] = {};
        }

        // 2) apply VAC first (so generator skips those days)
        applyVacations(numDays, sched);

        // 3) build weekly templates
        const fixed = state.employees.filter(e=>e.patternType==="weekly");
        const rolling = state.employees.filter(e=>e.patternType==="rolling");
        const joker = state.employees.filter(e=>e.patternType==="joker");

        // A) fixed: repeat month directly with safety streak + flip
        applyFixedTemplateForMonth(numDays, sched, fixed);

        // B) rolling: create 7-day template per employee (Sun..Sat), repeat
        const rollingTemplates = buildRollingWeeklyTemplates(rolling);
        applyWeeklyTemplatesForMonth(numDays, sched, rolling, rollingTemplates, { forbidFridayOff:true });

        // C) joker: create 7-day template per employee (mostly N + 1 OFF), repeat
        const jokerTemplates = buildJokerWeeklyTemplates(joker);
        applyWeeklyTemplatesForMonth(numDays, sched, joker, jokerTemplates, { forbidFridayOff:true });

        // 4) enforce safety & max consecutive over full month (only OFF breaks)
        enforceSafetyAndStreakMonth(numDays, sched);

        // 5) render & save
        renderSchedule();
        saveData();
        alert("âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (V11)!");
      }catch(e){
        console.error(e);
        alert("Ø®Ø·Ø£: " + (e?.message || e));
      }finally{
        showLoader(false);
      }
    }, 80);
  }

  function applyFixedTemplateForMonth(numDays, sched, fixedEmps){
    fixedEmps.forEach(emp=>{
      let prev = "OFF";
      let streak = 0;

      for(let day=1; day<=numDays; day++){
        const existing = getCell(sched, emp.id, day);
        if(existing && existing.shift==="VAC"){
          prev = "VAC";
          // VAC Ù„Ø§ ÙŠÙƒØ³Ø± Ø§Ù„Ø³ØªØ±ÙŠÙƒ Ø­Ø³Ø¨ Ø·Ù„Ø¨ÙƒØŒ Ù„Ø°Ø§ Ø§Ù„Ø³ØªØ±ÙŠÙƒ ÙƒÙ…Ø§ Ù‡Ùˆ
          continue;
        }

        const dow = new Date(appConfig.year, appConfig.month-1, day).getDay(); // 0..6
        let shift = emp.weeklyTemplate[dow] || "OFF";

        // enforce max consecutive: Ø¥Ø°Ø§ streak == 6 Ùˆ Ø§Ù„ÙŠÙˆÙ… Ø¹Ù…Ù„ => OFF
        if(streak >= MAX_CONSECUTIVE && WORK_SHIFTS.includes(shift)){
          shift = "OFF";
        }

        // enforce anti-flip
        if(isShiftFlipViolation(prev, shift)){
          shift = "OFF"; // Ø­Ù„ Ø¢Ù…Ù†
        }

        setCell(sched, emp.id, day, shift, "");

        // update streak
        if(breaksStreak(shift)){
          streak = 0;
        } else if(WORK_SHIFTS.includes(shift)){
          streak++;
        } // VAC/X Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø³ØªØ±ÙŠÙƒ

        prev = shift;
      }
    });
  }

  // ----- Build Rolling templates (7 days) -----
  // Ø§Ù„Ù‡Ø¯Ù: ØªÙˆØ²ÙŠØ¹ OFF Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø¯ÙˆÙ† ØªÙƒØ¯Ù‘Ø³ + Ù…Ù†Ø¹ Friday OFF Ø¢Ù„ÙŠØ§Ù‹
  function buildRollingWeeklyTemplates(rollingEmps){
    const offCountsByDow = Array(7).fill(0); // global to spread
    const templates = {}; // empId -> array[7]

    // helper choose OFF day with min count excluding Friday
    function pickOffDow(excludeSet){
      let best = null, bestCount = Infinity;
      for(let d=0; d<7; d++){
        if(d === FRIDAY) continue;
        if(excludeSet.has(d)) continue;
        if(offCountsByDow[d] < bestCount){
          bestCount = offCountsByDow[d];
          best = d;
        }
      }
      // fallback
      if(best===null){
        for(let d=0; d<7; d++){
          if(d!==FRIDAY && !excludeSet.has(d)) return d;
        }
        return 6;
      }
      return best;
    }

    // deterministic-ish shuffle to avoid same order each time
    const list = [...rollingEmps].sort((a,b)=> (a.id>b.id?1:-1));

    list.forEach(emp=>{
      const f = emp.flexCounts || {M:1,A:2,N:2,OFF:2};
      const offNeeded = Math.max(0, parseInt(f.OFF)||0);
      // Ù†Ø«Ø¨Øª 2 OFF ØºØ§Ù„Ø¨Ø§Ù‹Ø› Ø¥Ø°Ø§ user Ø¯Ø®Ù„ Ø´ÙŠØ¡ Ù…Ø®ØªÙ„Ù Ù†Ù…Ø´ÙŠ Ø¹Ù„ÙŠÙ‡
      const offSlots = Math.min(6, offNeeded);

      // start with all WORK placeholders
      const week = Array(7).fill(null);

      // pick OFF dows (spread)
      const chosen = new Set();
      for(let i=0; i<offSlots; i++){
        const d = pickOffDow(chosen);
        chosen.add(d);
        offCountsByDow[d]++;
        week[d] = "OFF";
      }

      // fill remaining with shifts based on counts (M/A/N)
      let m = Math.max(0, parseInt(f.M)||0);
      let a = Math.max(0, parseInt(f.A)||0);
      let n = Math.max(0, parseInt(f.N)||0);

      // If counts don't fit remaining slots, we'll flex:
      const workSlots = 7 - offSlots;
      let total = m + a + n;
      if(total < workSlots){
        // add extra M (upgrade friendly) to reach
        m += (workSlots - total);
      } else if(total > workSlots){
        // trim from N first (upgrade preference) then A then M
        let excess = total - workSlots;
        const dec = (ref) => {
          const take = Math.min(ref.val, excess);
          ref.val -= take;
          excess -= take;
        };
        let refN={val:n}, refA={val:a}, refM={val:m};
        dec(refN); dec(refA); dec(refM);
        n=refN.val; a=refA.val; m=refM.val;
      }

      // Build ordered pool to minimize anti-flip (M -> A -> N is safest)
      // Ù„ÙƒÙ† ØªÙØ¶ÙŠÙ„ Upgrade ÙŠØ¹Ù†ÙŠ Ù…Ø³Ù…ÙˆØ­ Ù†Ø±ÙØ¹ØŒ ÙØ®Ù„Ù‘ÙŠÙ†Ø§ Ù†Ø¹Ø·ÙŠ M Ø£ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø£ÙƒØ«Ø±
      const pool = [];
      for(let i=0;i<m;i++) pool.push("M");
      for(let i=0;i<a;i++) pool.push("A");
      for(let i=0;i<n;i++) pool.push("N");

      // place into week in weekday order
      let idx=0;
      for(let d=0; d<7; d++){
        if(week[d]==="OFF") continue;
        week[d] = pool[idx] || "M";
        idx++;
      }

      // fix anti-flip inside weekly loop (including Sat->Sun)
      fixWeekAntiFlip(week);

      templates[emp.id] = week;
    });

    return templates;
  }

  // ----- Build Joker templates -----
  function buildJokerWeeklyTemplates(jokerEmps){
    const offCountsByDow = Array(7).fill(0);
    const templates = {};

    function pickOffDow(){
      let best=null, bestCount=Infinity;
      for(let d=0; d<7; d++){
        if(d === FRIDAY) continue;
        if(offCountsByDow[d] < bestCount){
          bestCount = offCountsByDow[d];
          best = d;
        }
      }
      if(best===null) best = 6;
      return best;
    }

    const list = [...jokerEmps].sort((a,b)=> (a.id>b.id?1:-1));
    list.forEach(emp=>{
      const week = Array(7).fill("N"); // default N
      const offDow = pickOffDow();
      offCountsByDow[offDow]++;
      week[offDow] = "OFF";

      // Joker prefers N, avoids M. We'll allow A in template only if needed by counts? (but joker has no counts)
      // Keep as N.
      fixWeekAntiFlip(week);
      templates[emp.id] = week;
    });
    return templates;
  }

  // ensure no forbidden transitions (N->M/A, A->M) around 7 days cycle
  function fixWeekAntiFlip(week){
    // try upgrade "next" day if violates, else OFF as last resort
    const upgrade = (s) => (s==="M" ? "A" : (s==="A" ? "N" : s));
    const safeNext = (prev,next) => !isShiftFlipViolation(prev,next);

    // iterate multiple passes
    for(let pass=0; pass<5; pass++){
      let changed=false;
      for(let i=0; i<7; i++){
        const prev = week[i];
        const j = (i+1)%7;
        let next = week[j];

        if(isShiftFlipViolation(prev,next)){
          // try upgrade next
          let cand = next;
          for(let k=0;k<2;k++){
            cand = upgrade(cand);
            if(safeNext(prev,cand)){
              week[j]=cand;
              changed=true;
              break;
            }
          }
          // still violation? make next OFF
          if(isShiftFlipViolation(prev, week[j])){
            week[j]="OFF";
            changed=true;
          }
        }
      }
      if(!changed) break;
    }
  }

  function applyWeeklyTemplatesForMonth(numDays, sched, emps, templates, opts={forbidFridayOff:true}){
    emps.forEach(emp=>{
      const week = templates[emp.id] || Array(7).fill("M");
      let prev = "OFF";
      let streak = 0;

      for(let day=1; day<=numDays; day++){
        const existing = getCell(sched, emp.id, day);
        if(existing && existing.shift==="VAC"){
          prev = "VAC";
          continue;
        }

        const dow = new Date(appConfig.year, appConfig.month-1, day).getDay(); // 0..6
        let shift = week[dow] || "OFF";

        // enforce: rolling/joker Friday OFF Ù…Ù…Ù†ÙˆØ¹ Ø¢Ù„ÙŠØ§Ù‹
        if(opts.forbidFridayOff && dow===FRIDAY && shift==="OFF"){
          // Ø§Ø¬Ø¨Ø§Ø± Ø¹Ù…Ù„: Ù„Ù„Ø¬ÙˆÙƒØ± NØŒ Ù„Ù„Ø¯ÙˆØ§Ø± A (Ø£Ø®Ù) Ø«Ù… N
          if(emp.patternType==="joker") shift="N";
          else shift="A";
        }

        // enforce max consecutive: Ø¥Ø°Ø§ streak == 6 Ùˆ Ø§Ù„ÙŠÙˆÙ… Ø¹Ù…Ù„ => OFF (Ø­ØªÙ‰ Ù„Ùˆ VAC/X Ù…Ø§ ÙŠÙƒØ³Ø±)
        if(streak >= MAX_CONSECUTIVE && WORK_SHIFTS.includes(shift)){
          shift = "OFF";
        }

        // enforce anti-flip with prev day
        if(isShiftFlipViolation(prev, shift)){
          // Ø­Ø§ÙˆÙ„ upgrade (M->A->N) Ù„ØªÙØ§Ø¯ÙŠ flipØŒ Ø¥Ø°Ø§ Ù…Ø§ Ù†ÙØ¹ OFF
          shift = tryUpgradeToAvoidFlip(prev, shift, emp.patternType);
        }

        // Joker avoid M Ø¢Ù„ÙŠØ§Ù‹
        if(emp.patternType==="joker" && shift==="M"){
          shift = "A"; // Ø«Ù… enforcement below
          if(isShiftFlipViolation(prev, shift)) shift = tryUpgradeToAvoidFlip(prev, shift, "joker");
        }

        setCell(sched, emp.id, day, shift, "");

        // update streak
        if(breaksStreak(shift)){
          streak = 0;
        } else if(WORK_SHIFTS.includes(shift)){
          streak++;
        } // VAC/X Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø³ØªØ±ÙŠÙƒ

        prev = shift;
      }
    });
  }

  function tryUpgradeToAvoidFlip(prev, desired, type){
    const upgrade = (s) => (s==="M" ? "A" : (s==="A" ? "N" : s));
    let cand = desired;
    for(let i=0;i<3;i++){
      if(!isShiftFlipViolation(prev, cand)){
        // Joker avoid M
        if(type==="joker" && cand==="M") cand="A";
        if(!isShiftFlipViolation(prev,cand)) return cand;
      }
      cand = upgrade(cand);
    }
    return "OFF";
  }

  // Enforce month-wide streak & flip after everything (safety net)
  function enforceSafetyAndStreakMonth(numDays, sched){
    state.employees.forEach(emp=>{
      let prev = "OFF";
      let streak = 0;

      for(let day=1; day<=numDays; day++){
        const c = getCell(sched, emp.id, day);
        if(!c){ setCell(sched, emp.id, day, "OFF", ""); prev="OFF"; streak=0; continue; }

        // VAC override
        if(c.shift==="VAC"){
          prev = "VAC";
          continue;
        }

        // enforce max consecutive
        if(streak >= MAX_CONSECUTIVE && WORK_SHIFTS.includes(c.shift)){
          c.shift = "OFF";
          c.depot = "";
        }

        // enforce anti flip
        if(isShiftFlipViolation(prev, c.shift)){
          c.shift = "OFF";
          c.depot = "";
        }

        // joker no M (auto safety)
        if(emp.patternType==="joker" && c.shift==="M"){
          c.shift = "A";
          if(isShiftFlipViolation(prev, c.shift)) c.shift="OFF";
        }

        // update streak
        if(breaksStreak(c.shift)){
          streak = 0;
        } else if(WORK_SHIFTS.includes(c.shift)){
          streak++;
        }
        prev = c.shift;
      }
    });
  }

  // =========================
  // DEPOT FILL (unchanged)
  // =========================
  function fillDepots(){
    const key = getMonthKey();
    const sched = state.schedule[key];
    if(!sched || !confirm("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ØŸ")) return;
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const reqs = state.meta.requirements || {};
    const depots = appConfig.depots.map(d=>d.trim());

    for(let d=1; d<=numDays; d++){
      state.employees.forEach(e=>{
        if(sched[e.id]?.[d] && WORK_SHIFTS.includes(sched[e.id][d].shift)) sched[e.id][d].depot = "";
      });
    }

    for(let d=1; d<=numDays; d++){
      const counts = {}; depots.forEach(dp=>counts[dp]={M:0,A:0,N:0});
      const workers = {M:[],A:[],N:[]};

      state.employees.forEach(e=>{
        const c = sched[e.id]?.[d];
        if(!c) return;
        if(WORK_SHIFTS.includes(c.shift)) workers[c.shift].push(e);
      });

      ["M","A","N"].forEach(s=>{
        let list = workers[s];
        list.sort((a,b)=>((b.depotQuotas?.[depots[0]]||0) - (a.depotQuotas?.[depots[0]]||0)));

        depots.forEach(dep=>{
          let need = (reqs[dep]||{})[s] || 0;
          let i=0;
          while(i<list.length && counts[dep][s] < need){
            const e = list[i];
            if(!sched[e.id][d].depot){
              sched[e.id][d].depot = dep;
              counts[dep][s]++;
            }
            i++;
          }
        });

        list.forEach(e=>{
          if(!sched[e.id][d].depot){
            const target = depots.reduce((a,b)=>counts[a][s]<counts[b][s]?a:b);
            sched[e.id][d].depot = target;
            counts[target][s]++;
          }
        });
      });
    }

    renderSchedule();
    saveData();
  }

  // =========================
  // RENDER SCHEDULE + REPORT
  // =========================
  function renderSchedule(){
    const grid = document.getElementById("scheduleGrid");
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const data = state.schedule[getMonthKey()] || {};

    let html = `<thead><tr><th class="emp-col">Ø§Ù„Ù…ÙˆØ¸Ù</th>`;
    for(let d=1; d<=numDays; d++){
      const wd = new Date(appConfig.year, appConfig.month-1, d).getDay();
      html += `<th>${d}<br>${WEEKDAYS[wd]}</th>`;
    }
    html += `</tr></thead><tbody>`;

    state.employees.forEach(emp=>{
      let row = `<tr><td class="emp-col">${emp.name}</td>`;
      let prev = "OFF";

      for(let d=1; d<=numDays; d++){
        const c = (data[emp.id] && data[emp.id][d]) ? data[emp.id][d] : {shift:"", depot:""};
        const s = c.shift || "";
        const v = isShiftFlipViolation(prev, s) ? "violation" : "";
        row += `<td class="cell shift-${s} ${v}" onclick="openCellEditorById('${emp.id}', ${d})">${s}</td>`;
        prev = s || "OFF";
      }

      html += row + `</tr>`;
    });

    grid.innerHTML = html + `</tbody>`;
    analyzeCoverage();
  }

  function analyzeCoverage(){
    const report = document.getElementById("coverageReport");
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const sched = state.schedule[getMonthKey()] || {};
    const depots = appConfig.depots.map(d=>d.trim());
    const reqs = state.meta.requirements || {};
    let issues = [];

    // Ø¥Ø°Ø§ Ù…Ø§ ÙˆØ²Ø¹Øª depotsØŒ Ù†Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø³ÙŠØ· Ø¨Ø¯Ù„ Ù†Ù‚Øµ ØºÙ„Ø·
    let anyDepotAssigned = false;
    for(let d=1; d<=numDays; d++){
      for(const e of state.employees){
        const c = sched[e.id]?.[d];
        if(c && c.depot){ anyDepotAssigned=true; break; }
      }
      if(anyDepotAssigned) break;
    }
    if(!anyDepotAssigned){
      report.innerHTML = `<div class="report-item">â„¹ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù… ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹" Ø«Ù… Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</div>`;
      return;
    }

    for(let d=1; d<=numDays; d++){
      let counts = {}; depots.forEach(dp=>counts[dp]={M:0,A:0,N:0});
      state.employees.forEach(e=>{
        let c = sched[e.id]?.[d];
        if(c && c.depot && WORK_SHIFTS.includes(c.shift)) counts[c.depot.trim()][c.shift]++;
      });
      depots.forEach(dep=>{
        let r = reqs[dep] || {};
        ["M","A","N"].forEach(s=>{
          let req = r[s]||0;
          let act = counts[dep][s]||0;
          if(act < req) issues.push(`ÙŠÙˆÙ… ${d} | ${dep} | (${s}) : Ù…Ø·Ù„ÙˆØ¨ ${req}ØŒ Ù…ÙˆØ¬ÙˆØ¯ ${act}`);
        });
      });
    }

    report.innerHTML = issues.length
      ? issues.map(i=>`<div class="report-item">${i}</div>`).join("")
      : `<div class="report-ok">âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù…ØªØ§Ø²!</div>`;
  }

  // =========================
  // MANUAL CELL EDITOR
  // =========================
  let ceContext = { empId:null, day:null };

  function openCellEditorById(empId, day){
    const key = getMonthKey();
    if(!state.schedule[key]) state.schedule[key] = {};
    if(!state.schedule[key][empId]) state.schedule[key][empId] = {};
    if(!state.schedule[key][empId][day]) state.schedule[key][empId][day] = { shift:"OFF", depot:"" };

    ceContext = { empId, day };

    const emp = state.employees.find(e=>e.id===empId);
    const wd = new Date(appConfig.year, appConfig.month-1, day).getDay();
    document.getElementById("ceTitle").innerText = `ØªØ¹Ø¯ÙŠÙ„: ${emp?.name||''} | ÙŠÙˆÙ… ${day} (${WEEKDAYS[wd]})`;

    const shiftSel = document.getElementById("ceShift");
    shiftSel.innerHTML = SHIFTS.map(s=>`<option value="${s}">${s}</option>`).join("");

    const depotSel = document.getElementById("ceDepot");
    depotSel.innerHTML = `<option value="">â€”</option>` + appConfig.depots.map(d=>`<option value="${d}">${d}</option>`).join("");

    const cur = state.schedule[key][empId][day];
    shiftSel.value = cur.shift || "OFF";
    depotSel.value = cur.depot || "";

    document.getElementById("ceWarn").style.display = "none";
    document.getElementById("cellEditorOverlay").style.display = "flex";

    shiftSel.onchange = showManualWarnings;
    depotSel.onchange = showManualWarnings;
    showManualWarnings();
  }

  function showManualWarnings(){
    const warn = document.getElementById("ceWarn");
    const key = getMonthKey();
    const {empId, day} = ceContext;
    if(!empId || !day) return;

    const newShift = document.getElementById("ceShift").value;
    const wd = new Date(appConfig.year, appConfig.month-1, day).getDay();
    const emp = state.employees.find(e=>e.id===empId);

    const prevDay = day-1;
    const prev = prevDay>=1 ? (state.schedule[key][empId]?.[prevDay]?.shift || "OFF") : "OFF";

    let msgs = [];
    if(isShiftFlipViolation(prev, newShift)) msgs.push(`ØªØ­Ø°ÙŠØ± Ø£Ù…Ø§Ù†: Ù…Ù…Ù†ÙˆØ¹ (${prev}) â†’ (${newShift}).`);
    if(wd===FRIDAY && newShift==="OFF" && emp && emp.patternType!=="weekly")
      msgs.push("ØªÙ†Ø¨ÙŠÙ‡: Friday OFF Ù„Ù„Ø¯ÙˆÙ‘Ø§Ø±/Ø§Ù„Ø¬ÙˆÙƒØ± Ù…Ù…Ù†ÙˆØ¹ ÙÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¢Ù„ÙŠ (Ù„ÙƒÙ† Ù…Ø³Ù…ÙˆØ­ ÙŠØ¯ÙˆÙŠ).");
    if(emp?.patternType==="joker" && newShift==="M")
      msgs.push("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¬ÙˆÙƒØ± M Ù…Ù…Ù†ÙˆØ¹ ÙÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¢Ù„ÙŠ (Ù„ÙƒÙ† Ù…Ø³Ù…ÙˆØ­ ÙŠØ¯ÙˆÙŠ).");

    if(msgs.length){
      warn.innerHTML = "âš ï¸ " + msgs.join("<br>â€¢ ");
      warn.style.display = "block";
    }else{
      warn.style.display = "none";
      warn.innerHTML = "";
    }
  }

  function saveCellEdit(){
    const key = getMonthKey();
    const {empId, day} = ceContext;
    if(!empId || !day) return;

    const shift = document.getElementById("ceShift").value;
    const depot = document.getElementById("ceDepot").value;

    state.schedule[key][empId][day] = state.schedule[key][empId][day] || {shift:"OFF", depot:""};
    state.schedule[key][empId][day].shift = shift;
    state.schedule[key][empId][day].depot = WORK_SHIFTS.includes(shift) ? (depot||"") : "";

    closeCellEditor();
    renderSchedule();
    saveData();
  }

  function clearCellEdit(){
    const key = getMonthKey();
    const {empId, day} = ceContext;
    if(!empId || !day) return;
    if(state.schedule[key]?.[empId]?.[day]) delete state.schedule[key][empId][day];
    closeCellEditor();
    renderSchedule();
    saveData();
  }

  // NEW: Apply same shift+depot to same weekday for rest of month (this employee only)
  function applyWeekdayToMonth(){
    const key = getMonthKey();
    const {empId, day} = ceContext;
    if(!empId || !day) return;

    const shift = document.getElementById("ceShift").value;
    const depot = document.getElementById("ceDepot").value;

    const numDays = daysInMonth(appConfig.year, appConfig.month);
    const targetWD = new Date(appConfig.year, appConfig.month-1, day).getDay();

    for(let d=day; d<=numDays; d++){
      const wd = new Date(appConfig.year, appConfig.month-1, d).getDay();
      if(wd !== targetWD) continue;

      // Ù„Ø§ Ù†Ù„Ù…Ø³ VAC
      const existing = state.schedule[key]?.[empId]?.[d];
      if(existing && existing.shift==="VAC") continue;

      state.schedule[key][empId][d] = state.schedule[key][empId][d] || {shift:"", depot:""};
      state.schedule[key][empId][d].shift = shift;
      state.schedule[key][empId][d].depot = WORK_SHIFTS.includes(shift) ? (depot||"") : "";
    }

    closeCellEditor();
    renderSchedule();
    saveData();
  }

  function closeCellEditor(){
    document.getElementById("cellEditorOverlay").style.display = "none";
    ceContext = {empId:null, day:null};
  }

  // =========================
  // CLEAR / EXPORT
  // =========================
  function clearMonth(){
    if(confirm("Ù…Ø³Ø­ØŸ")){
      state.schedule[getMonthKey()] = {};
      renderSchedule();
      saveData();
    }
  }

  function exportCSV(){
    const numDays = daysInMonth(appConfig.year, appConfig.month);
    let csv = "\uFEFFEmployee,";
    for(let d=1; d<=numDays; d++) csv += `${d},`;
    csv += "\n";
    const data = state.schedule[getMonthKey()] || {};
    state.employees.forEach(e=>{
      csv += `"${e.name}",`;
      for(let d=1; d<=numDays; d++){
        const c = (data[e.id] && data[e.id][d]) || {};
        csv += `"${(c.shift||'')} ${(c.depot||'')}",`;
      }
      csv += "\n";
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "schedule.csv";
    a.click();
  }
</script>

</body>
</html>
